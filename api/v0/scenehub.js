function SceneJS_webgl_ensureImageSizePowerOfTwo(e){if(!SceneJS_webgl_isPowerOfTwo(e.width)||!SceneJS_webgl_isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=SceneJS_webgl_nextHighestPowerOfTwo(e.width);t.height=SceneJS_webgl_nextHighestPowerOfTwo(e.height);var n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height);e=t}return e}function SceneJS_webgl_isPowerOfTwo(e){return(e&e-1)==0}function SceneJS_webgl_nextHighestPowerOfTwo(e){--e;for(var t=1;t<32;t<<=1){e=e|e>>t}return e+1}WebGLDebugUtils=function(){function r(e){if(n==null){n={};for(var t in e){if(typeof e[t]=="number"){n[e[t]]=t}}}}function i(){if(n==null){throw"WebGLDebugUtils.init(ctx) not called"}}function s(e){i();return n[e]!==undefined}function o(e){i();var t=n[e];return t!==undefined?t:"*UNKNOWN WebGL ENUM (0x"+e.toString(16)+")"}function u(e,n,r){var i=t[e];if(i!==undefined){if(i[n]){return o(r)}}if(r===null){return"null"}else if(r===undefined){return"undefined"}else{return r.toString()}}function a(e,t){var n="";for(var r=0;r<t.length;++r){n+=(r==0?"":", ")+u(e,r,t[r])}return n}function f(e,t,n){e.__defineGetter__(n,function(){return t[n]});e.__defineSetter__(n,function(e){t[n]=e})}function l(e,t){var n=e[t];return function(){var t=n.apply(e,arguments);return t}}function c(t,n,i){function a(e,t){return function(){if(i){i(t,arguments)}var r=e[t].apply(e,arguments);var o=e.getError();if(o!=0){s[o]=true;n(o,t,arguments)}return r}}r(t);n=n||function(t,n,r){var i="";for(var s=0;s<r.length;++s){i+=(s==0?"":", ")+u(n,s,r[s])}e("WebGL error "+o(t)+" in "+n+"("+i+")")};var s={};var l={};for(var c in t){if(typeof t[c]=="function"){l[c]=a(t,c)}else{f(l,t,c)}}l.getError=function(){for(var e in s){if(s.hasOwnProperty(e)){if(s[e]){s[e]=false;return e}}}return t.NO_ERROR};return l}function h(e){var t=e.getParameter(e.MAX_VERTEX_ATTRIBS);var n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n);for(var r=0;r<t;++r){e.disableVertexAttribArray(r);e.vertexAttribPointer(r,4,e.FLOAT,false,0,0);e.vertexAttrib1f(r,0)}e.deleteBuffer(n);var i=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(var r=0;r<i;++r){e.activeTexture(e.TEXTURE0+r);e.bindTexture(e.TEXTURE_CUBE_MAP,null);e.bindTexture(e.TEXTURE_2D,null)}e.activeTexture(e.TEXTURE0);e.useProgram(null);e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,null);e.disable(e.BLEND);e.disable(e.CULL_FACE);e.disable(e.DEPTH_TEST);e.disable(e.DITHER);e.disable(e.SCISSOR_TEST);e.blendColor(0,0,0,0);e.blendEquation(e.FUNC_ADD);e.blendFunc(e.ONE,e.ZERO);e.clearColor(0,0,0,0);e.clearDepth(1);e.clearStencil(-1);e.colorMask(true,true,true,true);e.cullFace(e.BACK);e.depthFunc(e.LESS);e.depthMask(true);e.depthRange(0,1);e.frontFace(e.CCW);e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE);e.lineWidth(1);e.pixelStorei(e.PACK_ALIGNMENT,4);e.pixelStorei(e.UNPACK_ALIGNMENT,4);e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,false);e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);if(e.UNPACK_COLORSPACE_CONVERSION_WEBGL){e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL)}e.polygonOffset(0,0);e.sampleCoverage(1,false);e.scissor(0,0,e.canvas.width,e.canvas.height);e.stencilFunc(e.ALWAYS,0,4294967295);e.stencilMask(4294967295);e.stencilOp(e.KEEP,e.KEEP,e.KEEP);e.viewport(0,0,e.canvas.width,e.canvas.height);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);while(e.getError());}function p(e){function m(e){if(typeof e=="function"){return e}else{return function(t){e.handleEvent(t)}}}function b(e){var t=e.addEventListener;e.addEventListener=function(n,r,i){switch(n){case"webglcontextlost":g(r);break;case"webglcontextrestored":y(r);break;default:t.apply(e,arguments)}}}function w(e){return e instanceof WebGLBuffer||e instanceof WebGLFramebuffer||e instanceof WebGLProgram||e instanceof WebGLRenderbuffer||e instanceof WebGLShader||e instanceof WebGLTexture}function E(e){for(var t=0;t<e.length;++t){var n=e[t];if(w(n)){return n.__webglDebugContextLostId__==s}}return true}function S(){var e=Object.keys(v);for(var t=0;t<e.length;++t){delete v[e]}}function x(){++c;if(!o){if(l==c){e.loseContext()}}}function T(e,t){var n=e[t];return function(){x();if(!o){var t=n.apply(e,arguments);return t}}}function N(){for(var e=0;e<a.length;++e){var n=a[e];if(n instanceof WebGLBuffer){t.deleteBuffer(n)}else if(n instanceof WebGLFramebuffer){t.deleteFramebuffer(n)}else if(n instanceof WebGLProgram){t.deleteProgram(n)}else if(n instanceof WebGLRenderbuffer){t.deleteRenderbuffer(n)}else if(n instanceof WebGLShader){t.deleteShader(n)}else if(n instanceof WebGLTexture){t.deleteTexture(n)}}}function C(e){return{statusMessage:e,preventDefault:function(){p=true}}}function k(e){for(var r in e){if(typeof e[r]=="function"){n[r]=T(e,r)}else{f(n,e,r)}}n.getError=function(){x();if(!o){var e;while(e=t.getError()){v[e]=true}}for(var e in v){if(v[e]){delete v[e];return e}}return n.NO_ERROR};var i=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"];for(var u=0;u<i.length;++u){var l=i[u];n[l]=function(t){return function(){x();if(o){return null}var n=t.apply(e,arguments);n.__webglDebugContextLostId__=s;a.push(n);return n}}(e[l])}var c=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(var u=0;u<c.length;++u){var l=c[u];n[l]=function(t){return function(){x();if(o){return null}return t.apply(e,arguments)}}(n[l])}var h=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(var u=0;u<h.length;++u){var l=h[u];n[l]=function(t){return function(){x();if(o){return false}return t.apply(e,arguments)}}(n[l])}n.checkFramebufferStatus=function(t){return function(){x();if(o){return n.FRAMEBUFFER_UNSUPPORTED}return t.apply(e,arguments)}}(n.checkFramebufferStatus);n.getAttribLocation=function(t){return function(){x();if(o){return-1}return t.apply(e,arguments)}}(n.getAttribLocation);n.getVertexAttribOffset=function(t){return function(){x();if(o){return 0}return t.apply(e,arguments)}}(n.getVertexAttribOffset);n.isContextLost=function(){return o};return n}var t;var n;var r=[];var i=[];var n={};var s=1;var o=false;var u=0;var a=[];var l=0;var c=0;var p=false;var d=0;var v={};e.getContext=function(r){return function(){var i=r.apply(e,arguments);if(i instanceof WebGLRenderingContext){if(i!=t){if(t){throw"got different context"}t=i;n=k(t)}return n}return i}}(e.getContext);var g=function(e){r.push(m(e))};var y=function(e){i.push(m(e))};b(e);e.loseContext=function(){if(!o){o=true;l=0;++s;while(t.getError());S();v[t.CONTEXT_LOST_WEBGL]=true;var n=C("context lost");var i=r.slice();setTimeout(function(){for(var t=0;t<i.length;++t){i[t](n)}if(d>=0){setTimeout(function(){e.restoreContext()},d)}},0)}};e.restoreContext=function(){if(o){if(i.length){setTimeout(function(){if(!p){throw"can not restore. webglcontestlost listener did not call event.preventDefault"}N();h(t);o=false;c=0;p=false;var e=i.slice();var n=C("context restored");for(var r=0;r<e.length;++r){e[r](n)}},0)}}};e.loseContextInNCalls=function(e){if(o){throw"You can not ask a lost contet to be lost"}l=c+e};e.getNumCalls=function(){return c};e.setRestoreTimeout=function(e){d=e};return e}var e=function(e){if(window.console&&window.console.log){window.console.log(e)}};var t={enable:{0:true},disable:{0:true},getParameter:{0:true},drawArrays:{0:true},drawElements:{0:true,2:true},createShader:{0:true},getShaderParameter:{1:true},getProgramParameter:{1:true},getVertexAttrib:{1:true},vertexAttribPointer:{2:true},bindTexture:{0:true},activeTexture:{0:true},getTexParameter:{0:true,1:true},texParameterf:{0:true,1:true},texParameteri:{0:true,1:true,2:true},texImage2D:{0:true,2:true,6:true,7:true},texSubImage2D:{0:true,6:true,7:true},copyTexImage2D:{0:true,2:true},copyTexSubImage2D:{0:true},generateMipmap:{0:true},bindBuffer:{0:true},bufferData:{0:true,2:true},bufferSubData:{0:true},getBufferParameter:{0:true,1:true},pixelStorei:{0:true,1:true},readPixels:{4:true,5:true},bindRenderbuffer:{0:true},bindFramebuffer:{0:true},checkFramebufferStatus:{0:true},framebufferRenderbuffer:{0:true,1:true,2:true},framebufferTexture2D:{0:true,1:true,2:true},getFramebufferAttachmentParameter:{0:true,1:true,2:true},getRenderbufferParameter:{0:true,1:true},renderbufferStorage:{0:true,1:true},clear:{0:true},depthFunc:{0:true},blendFunc:{0:true,1:true},blendFuncSeparate:{0:true,1:true,2:true,3:true},blendEquation:{0:true},blendEquationSeparate:{0:true,1:true},stencilFunc:{0:true},stencilFuncSeparate:{0:true,1:true},stencilMaskSeparate:{0:true},stencilOp:{0:true,1:true,2:true},stencilOpSeparate:{0:true,1:true,2:true,3:true},cullFace:{0:true},frontFace:{0:true}};var n=null;return{init:r,mightBeEnum:s,glEnumToString:o,glFunctionArgToString:u,glFunctionArgsToString:a,makeDebugContext:c,makeLostContextSimulatingCanvas:p,resetToInitialState:h}}();var SceneJS_Map=function(e,t){this.items=e||[];var n=t||0;var r=n+1;this.addItem=function(){var e;if(arguments.length==2){var t=arguments[0];e=arguments[1];if(this.items[t]){throw SceneJS_error.fatalError(SceneJS.errors.ID_CLASH,"ID clash: '"+t+"'")}this.items[t]=e;return t}else{while(true){e=arguments[0];var n=r++;if(!this.items[n]){this.items[n]=e;return n}}}};this.removeItem=function(e){delete this.items[e]}};var SceneJS=new function(){this.VERSION="3.0.0.0";this._baseStateId=0;this._engines={};this._engineIds=new SceneJS_Map;this.createScene=function(e,t){if(!e){throw SceneJS_error.fatalError("param 'json' is null or undefined")}if(e.id){if(this._engines[e.id]){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Scene already exists with this ID: '"+e.id+"'")}this._engineIds.addItem(e.id,{})}else{e.id=this._engineIds.addItem({})}var n=new SceneJS_Engine(e,t);this._engines[e.id]=n;SceneJS_events.fireEvent(SceneJS_events.SCENE_CREATED,{engine:n});return n.scene};this.scene=function(e){var t=this._engines[e];return t?t.scene:null};this.getScene=function(e){var t=this._engines[e];return t?t.scene:null};this.getScenes=function(){var e={};for(var t in this._engines){if(this._engines.hasOwnProperty(t)){e[t]=this._engines[t].scene}}return e};this._isArray=function(e){return e&&!e.propertyIsEnumerable("length")&&typeof e==="object"&&typeof e.length==="number"};this._shallowClone=function(e){var t={};for(var n in e){if(e.hasOwnProperty(n)){t[n]=e[n]}}return t};this._applyIf=function(e,t){for(var n in e){if(e.hasOwnProperty(n)){if(t[n]==undefined||t[n]==null){t[n]=e[n]}}}return t};this._apply=function(e,t,n){var r;if(n){for(r in t){if(t.hasOwnProperty(r)){delete t[r]}}}for(r in e){if(e.hasOwnProperty(r)){t[r]=e[r]}}return t};this.reset=function(){var e=[];for(var t in this._engines){if(this._engines.hasOwnProperty(t)){e.push(this._engines[t]);delete this._engines[t];this._engineIds.removeItem(t)}}while(e.length>0){e.pop().destroy()}SceneJS_events.fireEvent(SceneJS_events.RESET)}};var SceneJS_eventManager=function(){this._handlerIds=new SceneJS_Map;this.typeHandlers={}};SceneJS_eventManager.prototype.createEvent=function(e){if(this.typeHandlers[e]){return}this.typeHandlers[e]={handlers:{},numSubs:0}};SceneJS_eventManager.prototype.onEvent=function(e,t){var n=this.typeHandlers[e];if(!n){throw"event type not supported: '"+e+"'"}var r=this._handlerIds.addItem(e);var i=n.handlers;i[r]=t;n.numSubs++;return r};SceneJS_eventManager.prototype.fireEvent=function(e,t){var n=this.typeHandlers[e];if(!n){throw"event not supported: '"+e+"'"}if(n.numSubs>0){var r=n.handlers;for(var i in r){if(r.hasOwnProperty(i)){r[i](t)}}}};SceneJS_eventManager.prototype.unEvent=function(e){var t=this._handlerIds.items[e];if(!t){return}this._handlerIds.removeItem(e);var n=this.typeHandlers[t];if(!n){return}delete n[e];this.typeHandlers[t].numSubs--};SceneJS.Plugins=new function(){function e(e,t){var n=document.createElement("script");n.type="text/javascript";if(n.readyState){n.onreadystatechange=function(){if(n.readyState=="loaded"||n.readyState=="complete"){n.onreadystatechange=null;t()}}}else{n.onload=function(){t()}}n.src=e;document.getElementsByTagName("head")[0].appendChild(n)}this._nodePlugins={};this.addPlugin=function(e,t,n){var r=this._nodePlugins[e]||(this._nodePlugins[e]={});r[t]=n};this.hasPlugin=function(e,t){var n=this._nodePlugins[e];return n&&!!n[t]};this.getPlugin=function(t,n,r){var i=this._nodePlugins[t];if(i){var s=i[n];if(s){r(s)}}var o=this;var u=SceneJS_debugModule.configs.pluginPath;if(!u){throw"no pluginPath config"}e(u+"/"+t+"/"+n+".js",function(){r(o._nodePlugins[t][n])})}};var SceneJS_events=new function(){this.ERROR=0;this.RESET=1;this.NODE_CREATED=2;this.SCENE_CREATED=3;this.SCENE_COMPILING=4;this.SCENE_DESTROYED=5;this.OBJECT_COMPILING=6;this.WEBGL_CONTEXT_LOST=7;this.WEBGL_CONTEXT_RESTORED=8;var e=[];this.addListener=function(t,n,r){var i=e[t];if(!i){i=[];e[t]=i}var s={command:n,priority:r==undefined?i.length:r};var o=-1;for(var u=0,a=i.length;u<a;u++){if(!i[u]){o=u;break}}if(o<0){i.push(s);o=i.length-1}var f=t+"."+o;return f};this.removeListener=function(t){var n=t.lastIndexOf(".");var r=parseInt(t.substr(0,n));var i=parseInt(t.substr(n+1));var s=e[r];if(!s){return}delete s[i]};this.fireEvent=function(t,n){var r=e[t];if(r){n=n||{};for(var i=0;i<r.length;i++){if(r[i]){r[i].command(n)}}}}};SceneJS.bind=function(e,t){switch(e){case"error":return SceneJS_events.addListener(SceneJS_events.ERROR,t);break;case"nodeCreated":return SceneJS_events.addListener(SceneJS_events.NODE_CREATED,function(e){t(e)});break;case"reset":return SceneJS_events.addListener(SceneJS_events.RESET,function(){t()});break;case"webglcontextlost":return SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_LOST,function(e){t(e)});break;case"webglcontextrestored":return SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(e){t(e)});break;default:throw SceneJS_error.fatalError("SceneJS.bind - this event type not supported: '"+e+"'")}};SceneJS.onEvent=SceneJS.bind;SceneJS.unEvent=function(e){return SceneJS_events.removeListener(e)};SceneJS.subscribe=SceneJS.addListener=SceneJS.onEvent=SceneJS.bind;SceneJS.unsubscribe=SceneJS.unEvent;var SceneJS_Canvas=function(e,t,n,r){this.canvasId;if(!t){t="canvas-"+e;var i=document.getElementsByTagName("body")[0];i.innerHTML="";var s=document.createElement("div");s.style.height="100%";s.style.width="100%";s.innerHTML='<canvas id="'+t+'" style="width: 100%; height: 100%; margin: 0; padding: 0;"></canvas>';i.appendChild(s)}var o=document.getElementById(t);if(!o){throw SceneJS_error.fatalError(SceneJS.errors.CANVAS_NOT_FOUND,"SceneJS.Scene attribute 'canvasId' does not match any elements in the page")}this.canvasId=t;this.options=r||{};this.canvas=this.options.simulateWebGLContextLost?WebGLDebugUtils.makeLostContextSimulatingCanvas(o):o;this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight;this.contextAttr=n;this.gl=null;this.initWebGL()};SceneJS_Canvas.prototype._WEBGL_CONTEXT_NAMES=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];SceneJS_Canvas.prototype.initWebGL=function(){for(var e=0;!this.gl&&e<this._WEBGL_CONTEXT_NAMES.length;e++){try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[e],this.contextAttr)}catch(t){}}if(!this.gl){throw SceneJS_error.fatalError(SceneJS.errors.WEBGL_NOT_SUPPORTED,"Failed to get a WebGL context")}this.gl.clearDepth(1);this.gl.enable(this.gl.DEPTH_TEST);this.gl.disable(this.gl.CULL_FACE);this.gl.depthRange(0,1);this.gl.disable(this.gl.SCISSOR_TEST)};SceneJS_Canvas.prototype.loseWebGLContext=function(){if(this.options.simulateWebGLContextLost){this.canvas.loseContext()}};var SceneJS_Engine=function(e,t){e.type="scene";this.id=e.id;this.canvas=new SceneJS_Canvas(this.id,e.canvasId,e.contextAttr,t);this.events=new SceneJS_eventManager;this.events.createEvent("started");this.events.createEvent("idle");this.events.createEvent("rendered");this.events.createEvent("sleep");this.events.createEvent("stopped");this.events.createEvent("loading");this.events.createEvent("loaded");this.events.createEvent("destroyed");this._coreFactory=new SceneJS_CoreFactory;this._nodeFactory=new SceneJS_NodeFactory;this.display=new SceneJS_Display({canvas:this.canvas});this.sceneDirty=false;this._sceneBranchesDirty=false;this._nodesToDestroy=[];this._numNodesToDestroy=0;this.running=false;this.paused=false;this.destroyed=false;this.sceneStatus={nodes:{},numLoading:0};this.scene=this.createNode(e);var n=this;this.canvas.canvas.addEventListener("webglcontextlost",function(e){e.preventDefault();SceneJS_events.fireEvent(SceneJS_events.WEBGL_CONTEXT_LOST,{scene:n.scene})},false);this.canvas.canvas.addEventListener("webglcontextrestored",function(e){e.preventDefault();n.canvas.initWebGL();n._coreFactory.webglRestored();n.display.webglRestored();SceneJS_events.fireEvent(SceneJS_events.WEBGL_CONTEXT_RESTORED,{scene:n.scene})},false)};SceneJS_Engine.prototype.loseWebGLContext=function(){this.canvas.loseWebGLContext()};SceneJS_Engine.prototype.createNode=function(e){e.type=e.type||"node";var t=this._coreFactory.getCore(e.type,e.coreId);var n;n=this._nodeFactory.getNode(this,e,t);SceneJS_events.fireEvent(SceneJS_events.NODE_CREATED,{sceneId:this.id,nodeId:n.nodeId});if(e.nodes){for(var r=0,i=e.nodes.length;r<i;r++){n.addNode(this.createNode(e.nodes[r]))}}return n};SceneJS_Engine.prototype.findNode=function(e){return this._nodeFactory.nodes.items[e]};SceneJS_Engine.prototype.findNodes=function(e){var t=new RegExp(e);var n=[];var r=this._nodeFactory.nodes.items;for(var i in r){if(r.hasOwnProperty(i)){if(t.test(i)){n.push(r[i])}}}return n};SceneJS_Engine.prototype.branchDirty=function(e){if(this.sceneDirty){return}if(e==window){return}e.branchDirty=true;e.dirty=true;for(var t=e.parent;t&&!(t.dirty||t.branchDirty);t=t.parent){t.dirty=true}this._sceneBranchesDirty=true};SceneJS_Engine.prototype.nodeLoading=function(e){var t=this.sceneStatus.nodes[e.id]||(this.sceneStatus.nodes[e.id]={numLoading:0});t.numLoading++;this.sceneStatus.numLoading++;this.events.fireEvent("loading",this.sceneStatus)};SceneJS_Engine.prototype.nodeLoaded=function(e){var t=this.sceneStatus.nodes[e.id];if(!t){return}t.numLoading--;this.sceneStatus.numLoading--;if(t.numLoading==0){delete this.sceneStatus.nodes[e.id]}this.events.fireEvent("loaded",this.sceneStatus)};SceneJS_Engine.prototype.renderFrame=function(e){if(this._tryCompile()||e&&e.force){this.display.render(e);return true}return false};SceneJS_Engine.prototype.start=function(e){if(!this.running){e=e||{};this.running=true;this.paused=false;var t=this;var n="__scenejs_sceneLoop"+this.id;var r=false;this.sceneDirty=true;var i={sceneId:this.id};t.events.fireEvent("started",i);window[n]=function(){if(t.running&&!t.paused){t.events.fireEvent("idle",i);if(e.idleFunc){e.idleFunc()}if(!t.running){return}if(t._tryCompile()){r=false;t.display.render();t.events.fireEvent("rendered",i);if(e.frameFunc){e.frameFunc()}window.requestAnimationFrame(window[n])}else{if(!r&&e.sleepFunc){e.sleepFunc()}r=true;t.events.fireEvent("sleep",i);window.requestAnimationFrame(window[n])}}else{window.requestAnimationFrame(window[n])}};this._startCfg=e;window.requestAnimationFrame(window[n])}};SceneJS_Engine.prototype.pick=function(e,t,n){this._tryCompile();var r=this.display.pick({canvasX:e,canvasY:t,rayPick:n?n.rayPick:false});if(r){r.canvasX=e;r.canvasY=t}return r};SceneJS_Engine.prototype._tryCompile=function(){if(this.display.imageDirty||this.display.drawListDirty||this.display.stateSortDirty||this.display.stateOrderDirty||this.display.objectListDirty||this._sceneBranchesDirty||this.sceneDirty){this._doDestroyNodes();if(this._sceneBranchesDirty||this.sceneDirty){SceneJS_events.fireEvent(SceneJS_events.SCENE_COMPILING,{engine:this});this.scene._compileNodes()}this._sceneBranchesDirty=false;this.sceneDirty=false;return true}return false};SceneJS_Engine.prototype.pause=function(e){this.paused=e};SceneJS_Engine.prototype.stop=function(){if(this.running){this.running=false;this.paused=false;window["__scenejs_sceneLoop"+this.id]=null;this.events.fireEvent("stopped",{sceneId:this.id})}};SceneJS_Engine.prototype.destroyNode=function(e){this._nodesToDestroy[this._numNodesToDestroy++]=e;var t=this.sceneStatus.nodes[e.id];if(t){this.sceneStatus.numLoading-=t.numLoading;delete this.sceneStatus.nodes[e.id]}};SceneJS_Engine.prototype._doDestroyNodes=function(){var e;while(this._numNodesToDestroy>0){e=this._nodesToDestroy[--this._numNodesToDestroy];e._doDestroy();this._coreFactory.putCore(e._core);this._nodeFactory.putNode(e)}};SceneJS_Engine.prototype.destroy=function(){this.destroyed=true;this.events.fireEvent("destroyed",{sceneId:this.id})};if(!self.Int32Array){self.Int32Array=Array;self.Float32Array=Array}(function(){var e=0;var t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n){window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"RequestCancelAnimationFrame"]}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(t,n){var r=(new Date).getTime();var i=Math.max(0,16-(r-e));var s=window.setTimeout(function(){t(r+i)},i);e=r+i;return s};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(e){clearTimeout(e)}})();var SceneJS_error=new function(){var e;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){e=t.engine.id});SceneJS_events.addListener(SceneJS_events.RESET,function(){e=null},1e5);this.fatalError=function(t,n){if(typeof t=="string"){n=t;t=SceneJS.errors.ERROR}var r={errorName:SceneJS.errors._getErrorName(t)||"ERROR",code:t,exception:n,fatal:true};if(e){r.sceneId=e}SceneJS_events.fireEvent(SceneJS_events.ERROR,r);return n};this.error=function(t,n){var r={errorName:SceneJS.errors._getErrorName(t)||"ERROR",code:t,exception:n,fatal:false};if(e){r.sceneId=e}SceneJS_events.fireEvent(SceneJS_events.ERROR,r)}};(function(){SceneJS.errors={};var e=0;SceneJS.errors.ERROR=e++;SceneJS.errors.WEBGL_NOT_SUPPORTED=e++;SceneJS.errors.WEBGL_CONTEXT_LOST=e++;SceneJS.errors.NODE_CONFIG_EXPECTED=e++;SceneJS.errors.ILLEGAL_NODE_CONFIG=e++;SceneJS.errors.SHADER_COMPILATION_FAILURE=e++;SceneJS.errors.SHADER_LINK_FAILURE=e++;SceneJS.errors.CANVAS_NOT_FOUND=e++;SceneJS.errors.OUT_OF_VRAM=e++;SceneJS.errors.WEBGL_UNSUPPORTED_NODE_CONFIG=e++;SceneJS.errors.NODE_NOT_FOUND=e++;SceneJS.errors.NODE_ILLEGAL_STATE=e++;SceneJS.errors.ID_CLASH=e++;SceneJS.errors.PLUGIN_INVALID=e++})();SceneJS.errors._getErrorName=function(e){for(var t in SceneJS.errors){if(SceneJS.errors.hasOwnProperty(t)&&SceneJS.errors[t]==e){return t}}return null};var SceneJS_debugModule=new function(){this.configs={};this.getConfigs=function(e){if(!e){return this.configs}else{var t=this.configs;var n=e.split(".");for(var r=0;t&&r<n.length;r++){t=t[n[r]]}return t||{}}};this.setConfigs=function(e,t){if(!e){this.configs=t}else{var n=e.split(".");var r=this.configs;var i;var s;for(var o=0;o<n.length-1;o++){s=n[o];i=r[s];if(!i){i=r[s]={}}r=i}r[n.length-1]=t}}};SceneJS.configure=SceneJS.setConfigs=SceneJS.setDebugConfigs=function(){if(arguments.length==1){SceneJS_debugModule.setConfigs(null,arguments[0])}else if(arguments.length==2){SceneJS_debugModule.setConfigs(arguments[0],arguments[1])}else{throw SceneJS_error.fatalError("Illegal arguments given to SceneJS.setDebugs - should be either ({String}:name, {Object}:cfg) or ({Object}:cfg)")}};SceneJS.getConfigs=SceneJS.getDebugConfigs=function(e){return SceneJS_debugModule.getConfigs(e)};SceneJS.log=new function(){var e;var t=null;var n={};var r=0;var i="";SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){e=t.engine.id});SceneJS_events.addListener(SceneJS_events.RESET,function(){n={};t=null;e=null},1e5);this._setIndent=function(e){r=e;var t=[];for(var n=0;n<r;n++){t.push("----")}i=t.join("")};this.error=function(e){this._log("error",e)};this.warn=function(e){this._log("warn",e)};this.info=function(e){this._log("info",e)};this.debug=function(e){this._log("debug",e)};this.setFuncs=function(e){if(e){t=e;for(var r in n){this._flush(r)}}};this._flush=function(e){var r=n[e];if(r){var i=t?t[e]:null;if(i){for(var s=0;s<r.length;s++){i(r[s])}n[e]=[]}}};this._log=function(e,t){if(SceneJS._isArray(t)){for(var n=0;n<t.length;n++){this.__log(e,t[n])}}else{this.__log(e,t)}};this.__log=function(n,r){r=e?i+e+": "+r:i+r;if(t&&t[n]){t[n](r)}else if(console&&console[n]){console[n](r)}};this.getFuncs=function(){return t}};var SceneJS_math_divVec3=function(e,t,n){if(!n){n=e}n[0]=e[0]/t[0];n[1]=e[1]/t[1];n[2]=e[2]/t[2];return n};var SceneJS_math_negateVector4=function(e,t){if(!t){t=e}t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];t[3]=-e[3];return t};var SceneJS_math_addVec4=function(e,t,n){if(!n){n=e}n[0]=e[0]+t[0];n[1]=e[1]+t[1];n[2]=e[2]+t[2];n[3]=e[3]+t[3];return n};var SceneJS_math_addVec4s=function(e,t,n){if(!n){n=e}n[0]=e[0]+t;n[1]=e[1]+t;n[2]=e[2]+t;n[3]=e[3]+t;return n};var SceneJS_math_addVec3=function(e,t,n){if(!n){n=e}n[0]=e[0]+t[0];n[1]=e[1]+t[1];n[2]=e[2]+t[2];return n};var SceneJS_math_addVec3s=function(e,t,n){if(!n){n=e}n[0]=e[0]+t;n[1]=e[1]+t;n[2]=e[2]+t;return n};var SceneJS_math_addScalarVec4=function(e,t,n){return SceneJS_math_addVec4s(t,e,n)};var SceneJS_math_subVec4=function(e,t,n){if(!n){n=e}n[0]=e[0]-t[0];n[1]=e[1]-t[1];n[2]=e[2]-t[2];n[3]=e[3]-t[3];return n};var SceneJS_math_subVec3=function(e,t,n){if(!n){n=e}n[0]=e[0]-t[0];n[1]=e[1]-t[1];n[2]=e[2]-t[2];return n};var SceneJS_math_lerpVec3=function(e,t,n,r,i){var s=(e-t)/(n-t);var o=1-s;return{x:r.x*o+i.x*s,y:r.y*o+i.y*s,z:r.z*o+i.z*s}};var SceneJS_math_subVec2=function(e,t,n){if(!n){n=e}n[0]=e[0]-t[0];n[1]=e[1]-t[1];return n};var SceneJS_math_subVec4Scalar=function(e,t,n){if(!n){n=e}n[0]=e[0]-t;n[1]=e[1]-t;n[2]=e[2]-t;n[3]=e[3]-t;return n};var SceneJS_math_subScalarVec4=function(e,t,n){if(!n){n=e}n[0]=t-e[0];n[1]=t-e[1];n[2]=t-e[2];n[3]=t-e[3];return n};var SceneJS_math_mulVec4=function(e,t,n){if(!n){n=e}n[0]=e[0]*t[0];n[1]=e[1]*t[1];n[2]=e[2]*t[2];n[3]=e[3]*t[3];return n};var SceneJS_math_mulVec4Scalar=function(e,t,n){if(!n){n=e}n[0]=e[0]*t;n[1]=e[1]*t;n[2]=e[2]*t;n[3]=e[3]*t;return n};var SceneJS_math_mulVec3Scalar=function(e,t,n){if(!n){n=e}n[0]=e[0]*t;n[1]=e[1]*t;n[2]=e[2]*t;return n};var SceneJS_math_mulVec2Scalar=function(e,t,n){if(!n){n=e}n[0]=e[0]*t;n[1]=e[1]*t;return n};var SceneJS_math_divVec4=function(e,t,n){if(!n){n=e}n[0]=e[0]/t[0];n[1]=e[1]/t[1];n[2]=e[2]/t[2];n[3]=e[3]/t[3];return n};var SceneJS_math_divScalarVec3=function(e,t,n){if(!n){n=t}n[0]=e/t[0];n[1]=e/t[1];n[2]=e/t[2];return n};var SceneJS_math_divVec3s=function(e,t,n){if(!n){n=e}n[0]=e[0]/t;n[1]=e[1]/t;n[2]=e[2]/t;return n};var SceneJS_math_divVec4s=function(e,t,n){if(!n){n=e}n[0]=e[0]/t;n[1]=e[1]/t;n[2]=e[2]/t;n[3]=e[3]/t;return n};var SceneJS_math_divScalarVec4=function(e,t,n){if(!n){n=t}n[0]=e/t[0];n[1]=e/t[1];n[2]=e/t[2];n[3]=e/t[3];return n};var SceneJS_math_dotVector4=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]};var SceneJS_math_cross3Vec4=function(e,t){var n=e[0],r=e[1],i=e[2];var s=t[0],o=t[1],u=t[2];return[r*u-i*o,i*s-n*u,n*o-r*s,0]};var SceneJS_math_cross3Vec3=function(e,t,n){if(!n){n=e}var r=e[0],i=e[1],s=e[2];var o=t[0],u=t[1],a=t[2];n[0]=i*a-s*u;n[1]=s*o-r*a;n[2]=r*u-i*o;return n};var SceneJS_math_sqLenVec4=function(e){return SceneJS_math_dotVector4(e,e)};var SceneJS_math_lenVec4=function(e){return Math.sqrt(SceneJS_math_sqLenVec4(e))};var SceneJS_math_dotVector3=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]};var SceneJS_math_dotVector2=function(e,t){return e[0]*t[0]+e[1]*t[1]};var SceneJS_math_sqLenVec3=function(e){return SceneJS_math_dotVector3(e,e)};var SceneJS_math_sqLenVec2=function(e){return SceneJS_math_dotVector2(e,e)};var SceneJS_math_lenVec3=function(e){return Math.sqrt(SceneJS_math_sqLenVec3(e))};var SceneJS_math_lenVec2=function(e){return Math.sqrt(SceneJS_math_sqLenVec2(e))};var SceneJS_math_rcpVec3=function(e,t){return SceneJS_math_divScalarVec3(1,e,t)};var SceneJS_math_normalizeVec4=function(e,t){var n=1/SceneJS_math_lenVec4(e);return SceneJS_math_mulVec4Scalar(e,n,t)};var SceneJS_math_normalizeVec3=function(e,t){var n=1/SceneJS_math_lenVec3(e);return SceneJS_math_mulVec3Scalar(e,n,t)};var SceneJS_math_normalizeVec2=function(e,t){var n=1/SceneJS_math_lenVec2(e);return SceneJS_math_mulVec2Scalar(e,n,t)};var SceneJS_math_mat4=function(){return new Array(16)};var SceneJS_math_dupMat4=function(e){return e.slice(0,16)};var SceneJS_math_getCellMat4=function(e,t,n){return e[t+n*4]};var SceneJS_math_setCellMat4=function(e,t,n,r){e[t+n*4]=r};var SceneJS_math_getRowMat4=function(e,t){return[e[t],e[t+4],e[t+8],e[t+12]]};var SceneJS_math_setRowMat4=function(e,t,n){e[t]=n[0];e[t+4]=n[1];e[t+8]=n[2];e[t+12]=n[3]};var SceneJS_math_setRowMat4c=function(e,t,n,r,i,s){SceneJS_math_setRowMat4(e,t,[n,r,i,s])};var SceneJS_math_setRowMat4s=function(e,t,n){SceneJS_math_setRowMat4c(e,t,n,n,n,n)};var SceneJS_math_getColMat4=function(e,t){var n=t*4;return[e[n],e[n+1],e[n+2],e[n+3]]};var SceneJS_math_setColMat4v=function(e,t,n){var r=t*4;e[r]=n[0];e[r+1]=n[1];e[r+2]=n[2];e[r+3]=n[3]};var SceneJS_math_setColMat4c=function(e,t,n,r,i,s){SceneJS_math_setColMat4v(e,t,[n,r,i,s])};var SceneJS_math_setColMat4Scalar=function(e,t,n){SceneJS_math_setColMat4c(e,t,n,n,n,n)};var SceneJS_math_mat4To3=function(e){return[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]};var SceneJS_math_m4s=function(e){return[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]};var SceneJS_math_setMat4ToZeroes=function(){return SceneJS_math_m4s(0)};var SceneJS_math_setMat4ToOnes=function(){return SceneJS_math_m4s(1)};var SceneJS_math_diagonalMat4v=function(e){return[e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]]};var SceneJS_math_diagonalMat4c=function(e,t,n,r){return SceneJS_math_diagonalMat4v([e,t,n,r])};var SceneJS_math_diagonalMat4s=function(e){return SceneJS_math_diagonalMat4c(e,e,e,e)};var SceneJS_math_identityMat4=function(){return SceneJS_math_diagonalMat4v([1,1,1,1])};var SceneJS_math_isIdentityMat4=function(e){if(e[0]!==1||e[1]!==0||e[2]!==0||e[3]!==0||e[4]!==0||e[5]!==1||e[6]!==0||e[7]!==0||e[8]!==0||e[9]!==0||e[10]!==1||e[11]!==0||e[12]!==0||e[13]!==0||e[14]!==0||e[15]!==1){return false}return true};var SceneJS_math_negateMat4=function(e,t){if(!t){t=e}t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];t[3]=-e[3];t[4]=-e[4];t[5]=-e[5];t[6]=-e[6];t[7]=-e[7];t[8]=-e[8];t[9]=-e[9];t[10]=-e[10];t[11]=-e[11];t[12]=-e[12];t[13]=-e[13];t[14]=-e[14];t[15]=-e[15];return t};var SceneJS_math_addMat4=function(e,t,n){if(!n){n=e}n[0]=e[0]+t[0];n[1]=e[1]+t[1];n[2]=e[2]+t[2];n[3]=e[3]+t[3];n[4]=e[4]+t[4];n[5]=e[5]+t[5];n[6]=e[6]+t[6];n[7]=e[7]+t[7];n[8]=e[8]+t[8];n[9]=e[9]+t[9];n[10]=e[10]+t[10];n[11]=e[11]+t[11];n[12]=e[12]+t[12];n[13]=e[13]+t[13];n[14]=e[14]+t[14];n[15]=e[15]+t[15];return n};var SceneJS_math_addMat4Scalar=function(e,t,n){if(!n){n=e}n[0]=e[0]+t;n[1]=e[1]+t;n[2]=e[2]+t;n[3]=e[3]+t;n[4]=e[4]+t;n[5]=e[5]+t;n[6]=e[6]+t;n[7]=e[7]+t;n[8]=e[8]+t;n[9]=e[9]+t;n[10]=e[10]+t;n[11]=e[11]+t;n[12]=e[12]+t;n[13]=e[13]+t;n[14]=e[14]+t;n[15]=e[15]+t;return n};var SceneJS_math_addScalarMat4=function(e,t,n){return SceneJS_math_addMat4Scalar(t,e,n)};var SceneJS_math_subMat4=function(e,t,n){if(!n){n=e}n[0]=e[0]-t[0];n[1]=e[1]-t[1];n[2]=e[2]-t[2];n[3]=e[3]-t[3];n[4]=e[4]-t[4];n[5]=e[5]-t[5];n[6]=e[6]-t[6];n[7]=e[7]-t[7];n[8]=e[8]-t[8];n[9]=e[9]-t[9];n[10]=e[10]-t[10];n[11]=e[11]-t[11];n[12]=e[12]-t[12];n[13]=e[13]-t[13];n[14]=e[14]-t[14];n[15]=e[15]-t[15];return n};var SceneJS_math_subMat4Scalar=function(e,t,n){if(!n){n=e}n[0]=e[0]-t;n[1]=e[1]-t;n[2]=e[2]-t;n[3]=e[3]-t;n[4]=e[4]-t;n[5]=e[5]-t;n[6]=e[6]-t;n[7]=e[7]-t;n[8]=e[8]-t;n[9]=e[9]-t;n[10]=e[10]-t;n[11]=e[11]-t;n[12]=e[12]-t;n[13]=e[13]-t;n[14]=e[14]-t;n[15]=e[15]-t;return n};var SceneJS_math_subScalarMat4=function(e,t,n){if(!n){n=t}n[0]=e-t[0];n[1]=e-t[1];n[2]=e-t[2];n[3]=e-t[3];n[4]=e-t[4];n[5]=e-t[5];n[6]=e-t[6];n[7]=e-t[7];n[8]=e-t[8];n[9]=e-t[9];n[10]=e-t[10];n[11]=e-t[11];n[12]=e-t[12];n[13]=e-t[13];n[14]=e-t[14];n[15]=e-t[15];return n};var SceneJS_math_mulMat4=function(e,t,n){if(!n){n=e}var r=e[0],i=e[1],s=e[2],o=e[3];var u=e[4],a=e[5],f=e[6],l=e[7];var c=e[8],h=e[9],p=e[10],d=e[11];var v=e[12],m=e[13],g=e[14],y=e[15];var b=t[0],w=t[1],E=t[2],S=t[3];var x=t[4],T=t[5],N=t[6],C=t[7];var k=t[8],L=t[9],A=t[10],O=t[11];var M=t[12],_=t[13],D=t[14],P=t[15];n[0]=b*r+w*u+E*c+S*v;n[1]=b*i+w*a+E*h+S*m;n[2]=b*s+w*f+E*p+S*g;n[3]=b*o+w*l+E*d+S*y;n[4]=x*r+T*u+N*c+C*v;n[5]=x*i+T*a+N*h+C*m;n[6]=x*s+T*f+N*p+C*g;n[7]=x*o+T*l+N*d+C*y;n[8]=k*r+L*u+A*c+O*v;n[9]=k*i+L*a+A*h+O*m;n[10]=k*s+L*f+A*p+O*g;n[11]=k*o+L*l+A*d+O*y;n[12]=M*r+_*u+D*c+P*v;n[13]=M*i+_*a+D*h+P*m;n[14]=M*s+_*f+D*p+P*g;n[15]=M*o+_*l+D*d+P*y;return n};var SceneJS_math_mulMat4s=function(e,t,n){if(!n){n=e}n[0]=e[0]*t;n[1]=e[1]*t;n[2]=e[2]*t;n[3]=e[3]*t;n[4]=e[4]*t;n[5]=e[5]*t;n[6]=e[6]*t;n[7]=e[7]*t;n[8]=e[8]*t;n[9]=e[9]*t;n[10]=e[10]*t;n[11]=e[11]*t;n[12]=e[12]*t;n[13]=e[13]*t;n[14]=e[14]*t;n[15]=e[15]*t;return n};var SceneJS_math_mulMat4v4=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3];return[e[0]*n+e[4]*r+e[8]*i+e[12]*s,e[1]*n+e[5]*r+e[9]*i+e[13]*s,e[2]*n+e[6]*r+e[10]*i+e[14]*s,e[3]*n+e[7]*r+e[11]*i+e[15]*s]};var SceneJS_math_transposeMat4=function(e,t){var n=e[4],r=e[14],i=e[8];var s=e[13],o=e[12],u=e[9];if(!t||e==t){var a=e[1],f=e[2],l=e[3];var c=e[6],h=e[7];var p=e[11];e[1]=n;e[2]=i;e[3]=o;e[4]=a;e[6]=u;e[7]=s;e[8]=f;e[9]=c;e[11]=r;e[12]=l;e[13]=h;e[14]=p;return e}t[0]=e[0];t[1]=n;t[2]=i;t[3]=o;t[4]=e[1];t[5]=e[5];t[6]=u;t[7]=s;t[8]=e[2];t[9]=e[6];t[10]=e[10];t[11]=r;t[12]=e[3];t[13]=e[7];t[14]=e[11];t[15]=e[15];return t};var SceneJS_math_determinantMat4=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];var s=e[4],o=e[5],u=e[6],a=e[7];var f=e[8],l=e[9],c=e[10],h=e[11];var p=e[12],d=e[13],v=e[14],m=e[15];return p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*m+s*l*r*m+f*n*u*m-t*l*u*m-s*n*c*m+t*o*c*m};var SceneJS_math_inverseMat4=function(e,t){if(!t){t=e}var n=e[0],r=e[1],i=e[2],s=e[3];var o=e[4],u=e[5],a=e[6],f=e[7];var l=e[8],c=e[9],h=e[10],p=e[11];var d=e[12],v=e[13],m=e[14],g=e[15];var y=n*u-r*o;var b=n*a-i*o;var w=n*f-s*o;var E=r*a-i*u;var S=r*f-s*u;var x=i*f-s*a;var T=l*v-c*d;var N=l*m-h*d;var C=l*g-p*d;var k=c*m-h*v;var L=c*g-p*v;var A=h*g-p*m;var O=1/(y*A-b*L+w*k+E*C-S*N+x*T);t[0]=(u*A-a*L+f*k)*O;t[1]=(-r*A+i*L-s*k)*O;t[2]=(v*x-m*S+g*E)*O;t[3]=(-c*x+h*S-p*E)*O;t[4]=(-o*A+a*C-f*N)*O;t[5]=(n*A-i*C+s*N)*O;t[6]=(-d*x+m*w-g*b)*O;t[7]=(l*x-h*w+p*b)*O;t[8]=(o*L-u*C+f*T)*O;t[9]=(-n*L+r*C-s*T)*O;t[10]=(d*S-v*w+g*y)*O;t[11]=(-l*S+c*w-p*y)*O;t[12]=(-o*k+u*N-a*T)*O;t[13]=(n*k-r*N+i*T)*O;t[14]=(-d*E+v*b-m*y)*O;t[15]=(l*E-c*b+h*y)*O;return t};var SceneJS_math_traceMat4=function(e){return e[0]+e[5]+e[10]+e[15]};var SceneJS_math_translationMat4v=function(e){var t=SceneJS_math_identityMat4();t[12]=e[0];t[13]=e[1];t[14]=e[2];return t};var SceneJS_math_translationMat4c=function(e,t,n){return SceneJS_math_translationMat4v([e,t,n])};var SceneJS_math_translationMat4s=function(e){return SceneJS_math_translationMat4c(e,e,e)};var SceneJS_math_rotationMat4v=function(e,t){var n=SceneJS_math_normalizeVec4([t[0],t[1],t[2],0]);var r=Math.sin(e);var i=Math.cos(e);var s=1-i;var o=n[0];var u=n[1];var a=n[2];var f,l,c,h,p,d;f=o*u;l=u*a;c=a*o;h=o*r;p=u*r;d=a*r;var v=SceneJS_math_mat4();v[0]=s*o*o+i;v[1]=s*f+d;v[2]=s*c-p;v[3]=0;v[4]=s*f-d;v[5]=s*u*u+i;v[6]=s*l+h;v[7]=0;v[8]=s*c+p;v[9]=s*l-h;v[10]=s*a*a+i;v[11]=0;v[12]=0;v[13]=0;v[14]=0;v[15]=1;return v};var SceneJS_math_rotationMat4c=function(e,t,n,r){return SceneJS_math_rotationMat4v(e,[t,n,r])};var SceneJS_math_scalingMat4v=function(e){var t=SceneJS_math_identityMat4();t[0]=e[0];t[5]=e[1];t[10]=e[2];return t};var SceneJS_math_scalingMat4c=function(e,t,n){return SceneJS_math_scalingMat4v([e,t,n])};var SceneJS_math_scalingMat4s=function(e){return SceneJS_math_scalingMat4c(e,e,e)};var SceneJS_math_LOOKAT_OBJ={eye:{x:0,y:0,z:1},look:{x:0,y:0,z:0},up:{x:0,y:1,z:0}};var SceneJS_math_LOOKAT_ARRAYS={eye:[0,0,1],look:[0,0,0],up:[0,1,0]};var SceneJS_math_ORTHO_OBJ={left:-1,right:1,bottom:-1,near:.1,top:1,far:5e3};var SceneJS_math_lookAtMat4v=function(e,t,n,r){if(!r){r=SceneJS_math_mat4()}var i=e[0],s=e[1],o=e[2],u=n[0],a=n[1],f=n[2],l=t[0],c=t[1],h=t[2];if(i==l&&s==c&&o==h){return SceneJS_math_identityMat4()}var p,d,v,m,g,y,b,w,E,S;p=i-l;d=s-c;v=o-h;S=1/Math.sqrt(p*p+d*d+v*v);p*=S;d*=S;v*=S;m=a*v-f*d;g=f*p-u*v;y=u*d-a*p;S=Math.sqrt(m*m+g*g+y*y);if(!S){m=0;g=0;y=0}else{S=1/S;m*=S;g*=S;y*=S}b=d*y-v*g;w=v*m-p*y;E=p*g-d*m;S=Math.sqrt(b*b+w*w+E*E);if(!S){b=0;w=0;E=0}else{S=1/S;b*=S;w*=S;E*=S}r[0]=m;r[1]=b;r[2]=p;r[3]=0;r[4]=g;r[5]=w;r[6]=d;r[7]=0;r[8]=y;r[9]=E;r[10]=v;r[11]=0;r[12]=-(m*i+g*s+y*o);r[13]=-(b*i+w*s+E*o);r[14]=-(p*i+d*s+v*o);r[15]=1;return r};var SceneJS_math_lookAtMat4c=function(e,t,n,r,i,s,o,u,a){return SceneJS_math_lookAtMat4v([e,t,n],[r,i,s],[o,u,a])};var SceneJS_math_orthoMat4c=function(e,t,n,r,i,s,o){if(!o){o=SceneJS_math_mat4()}var u=t-e;var a=r-n;var f=s-i;o[0]=2/u;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=2/a;o[6]=0;o[7]=0;o[8]=0;o[9]=0;o[10]=-2/f;o[11]=0;o[12]=-(e+t)/u;o[13]=-(r+n)/a;o[14]=-(s+i)/f;o[15]=1;return o};var SceneJS_math_frustumMat4v=function(e,t){var n=[e[0],e[1],e[2],0];var r=[t[0],t[1],t[2],0];var i=SceneJS_math_mat4();SceneJS_math_addVec4(r,n,i);var s=SceneJS_math_mat4();SceneJS_math_subVec4(r,n,s);var o=2*n[2];var u=SceneJS_math_mat4();var a=s[0],f=s[1],l=s[2];u[0]=o/a;u[1]=0;u[2]=0;u[3]=0;u[4]=0;u[5]=o/f;u[6]=0;u[7]=0;u[8]=i[0]/a;u[9]=i[1]/f;u[10]=-i[2]/l;u[11]=-1;u[12]=0;u[13]=0;u[14]=-o*r[2]/l;u[15]=0;return u};var SceneJS_math_frustumMatrix4=function(e,t,n,r,i,s,o){if(!o){o=SceneJS_math_mat4()}var u=t-e;var a=r-n;var f=s-i;o[0]=i*2/u;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=i*2/a;o[6]=0;o[7]=0;o[8]=(t+e)/u;o[9]=(r+n)/a;o[10]=-(s+i)/f;o[11]=-1;o[12]=0;o[13]=0;o[14]=-(s*i*2)/f;o[15]=0;return o};var SceneJS_math_perspectiveMatrix4=function(e,t,n,r){var i=[];var s=[];i[2]=n;s[2]=r;s[1]=i[2]*Math.tan(e/2);i[1]=-s[1];s[0]=s[1]*t;i[0]=-s[0];return SceneJS_math_frustumMat4v(i,s)};var SceneJS_math_transformPoint3=function(e,t){var n=t[0],r=t[1],i=t[2];return[e[0]*n+e[4]*r+e[8]*i+e[12],e[1]*n+e[5]*r+e[9]*i+e[13],e[2]*n+e[6]*r+e[10]*i+e[14],e[3]*n+e[7]*r+e[11]*i+e[15]]};var SceneJS_math_transformPoints3=function(e,t){var n=new Array(t.length);var r=t.length;var i,s,o;var u;var a=e[0],f=e[1],l=e[2],c=e[3];var h=e[4],p=e[5],d=e[6],v=e[7];var m=e[8],g=e[9],y=e[10],b=e[11];var w=e[12],E=e[13],S=e[14],x=e[15];for(var T=0;T<r;++T){u=t[T];i=u[0];s=u[1];o=u[2];n[T]=[a*i+h*s+m*o+w,f*i+p*s+g*o+E,l*i+d*s+y*o+S,c*i+v*s+b*o+x]}return n};var SceneJS_math_transformVector3=function(e,t){var n=t[0],r=t[1],i=t[2];return[e[0]*n+e[4]*r+e[8]*i,e[1]*n+e[5]*r+e[9]*i,e[2]*n+e[6]*r+e[10]*i]};var SceneJS_math_transformVector4=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3];return[e[0]*n+e[4]*r+e[8]*i+e[12]*s,e[1]*n+e[5]*r+e[9]*i+e[13]*s,e[2]*n+e[6]*r+e[10]*i+e[14]*s,e[3]*n+e[7]*r+e[11]*i+e[15]*s]};var SceneJS_math_projectVec4=function(e){var t=1/e[3];return[e[0]*t,e[1]*t,e[2]*t,1]};var SceneJS_math_Plane3=function(e,t,n){this.normal=[0,0,1];this.offset=0;if(e&&t){var r=e[0],i=e[1],s=e[2];this.offset=t;if(n){var o=Math.sqrt(r*r+i*i+s*s);if(o>0){o=1/o;this.normal[0]=r*o;this.normal[1]=i*o;this.normal[2]=s*o;this.offset*=o}}}};var SceneJS_math_MAX_DOUBLE=Number.POSITIVE_INFINITY;var SceneJS_math_MIN_DOUBLE=Number.NEGATIVE_INFINITY;var SceneJS_math_Box3=function(e,t){this.min=e||[SceneJS_math_MAX_DOUBLE,SceneJS_math_MAX_DOUBLE,SceneJS_math_MAX_DOUBLE];this.max=t||[SceneJS_math_MIN_DOUBLE,SceneJS_math_MIN_DOUBLE,SceneJS_math_MIN_DOUBLE];this.init=function(e,t){this.min[0]=e[0];this.min[1]=e[1];this.min[2]=e[2];this.max[0]=t[0];this.max[1]=t[1];this.max[2]=t[2];return this};this.fromPoints=function(e){var t=e.length;for(var n=0;n<t;++n){var r=e[n][3];var i=e[n][0]/r;var s=e[n][1]/r;var o=e[n][2]/r;if(i<this.min[0]){this.min[0]=i}if(s<this.min[1]){this.min[1]=s}if(o<this.min[2]){this.min[2]=o}if(i>this.max[0]){this.max[0]=i}if(s>this.max[1]){this.max[1]=s}if(o>this.max[2]){this.max[2]=o}}return this};this.isEmpty=function(){return this.min[0]>=this.max[0]&&this.min[1]>=this.max[1]&&this.min[2]>=this.max[2]};this.getCenter=function(){return[(this.max[0]+this.min[0])/2,(this.max[1]+this.min[1])/2,(this.max[2]+this.min[2])/2]};this.getSize=function(){return[this.max[0]-this.min[0],this.max[1]-this.min[1],this.max[2]-this.min[2]]};this.getFacesAreas=function(){var e=this.size;return[e[1]*e[2],e[0]*e[2],e[0]*e[1]]};this.getSurfaceArea=function(){var e=this.getFacesAreas();return(e[0]+e[1]+e[2])*2};this.getVolume=function(){var e=this.size;return e[0]*e[1]*e[2]};this.getOffset=function(e){this.min[0]-=e;this.min[1]-=e;this.min[2]-=e;this.max[0]+=e;this.max[1]+=e;this.max[2]+=e;return this}};var SceneJS_math_AxisBox3=function(e,t){var n=e[0],r=e[1],i=e[2];var s=t[0],o=t[1],u=t[2];this.verts=[[n,r,i],[s,r,i],[s,o,i],[n,o,i],[n,r,u],[s,r,u],[s,o,u],[n,o,u]];this.toBox3=function(){var e=new SceneJS_math_Box3;for(var t=0;t<8;++t){var n=this.verts[t];for(var r=0;r<3;++r){if(n[r]<e.min[r]){e.min[r]=n[r]}if(n[r]>e.max[r]){e.max[r]=n[r]}}}}};var SceneJS_math_Sphere3=function(e,t){this.center=[e[0],e[1],e[2]];this.radius=t;this.isEmpty=function(){return this.radius===0};this.surfaceArea=function(){return 4*Math.PI*this.radius*this.radius};this.getVolume=function(){var e=this.radius;return 4/3*Math.PI*e*e*e}};var SceneJS_math_billboardMat=function(e){var t=[SceneJS_math_getColMat4(e,0),SceneJS_math_getColMat4(e,1),SceneJS_math_getColMat4(e,2)];var n=[SceneJS_math_lenVec4(t[0]),SceneJS_math_lenVec4(t[1]),SceneJS_math_lenVec4(t[2])];var r=SceneJS_math_mat4();SceneJS_math_rcpVec3(n,r);var i=SceneJS_math_scalingMat4v(n);SceneJS_math_mulVec4Scalar(t[0],r[0]);SceneJS_math_mulVec4Scalar(t[1],r[1]);SceneJS_math_mulVec4Scalar(t[2],r[2]);var s=SceneJS_math_identityMat4();SceneJS_math_setRowMat4(s,0,t[0]);SceneJS_math_setRowMat4(s,1,t[1]);SceneJS_math_setRowMat4(s,2,t[2]);return SceneJS_math_mulMat4(s,i)};var SceneJS_math_FrustumPlane=function(e,t,n,r){var i=1/Math.sqrt(e*e+t*t+n*n);this.normal=[e*i,t*i,n*i];this.offset=r*i;this.testVertex=[this.normal[0]>=0?1:0,this.normal[1]>=0?1:0,this.normal[2]>=0?1:0]};var SceneJS_math_OUTSIDE_FRUSTUM=3;var SceneJS_math_INTERSECT_FRUSTUM=4;var SceneJS_math_INSIDE_FRUSTUM=5;var SceneJS_math_Frustum=function(e,t,n){var r=SceneJS_math_mat4();SceneJS_math_mulMat4(t,e,r);var i=r[0],s=r[1],o=r[2],u=r[3];var a=r[4],f=r[5],l=r[6],c=r[7];var h=r[8],p=r[9],d=r[10],v=r[11];var m=r[12],g=r[13],y=r[14],b=r[15];var w=[new SceneJS_math_FrustumPlane(u-i,c-a,v-h,b-m),new SceneJS_math_FrustumPlane(u+i,c+a,v+h,b+m),new SceneJS_math_FrustumPlane(u-s,c-f,v-p,b-g),new SceneJS_math_FrustumPlane(u+s,c+f,v+p,b+g),new SceneJS_math_FrustumPlane(u-o,c-l,v-d,b-y),new SceneJS_math_FrustumPlane(u+o,c+l,v+d,b+y)];var E=[SceneJS_math_getColMat4(e,0),SceneJS_math_getColMat4(e,1),SceneJS_math_getColMat4(e,2)];var S=[SceneJS_math_lenVec4(E[0]),SceneJS_math_lenVec4(E[1]),SceneJS_math_lenVec4(E[2])];var x=SceneJS_math_rcpVec3(S);var T=SceneJS_math_scalingMat4v(S);var N=SceneJS_math_scalingMat4v(x);SceneJS_math_mulVec4Scalar(E[0],x[0]);SceneJS_math_mulVec4Scalar(E[1],x[1]);SceneJS_math_mulVec4Scalar(E[2],x[2]);var C=SceneJS_math_identityMat4();SceneJS_math_setRowMat4(C,0,E[0]);SceneJS_math_setRowMat4(C,1,E[1]);SceneJS_math_setRowMat4(C,2,E[2]);if(!this.matrix){this.matrix=SceneJS_math_mat4()}SceneJS_math_mulMat4(t,e,this.matrix);if(!this.billboardMatrix){this.billboardMatrix=SceneJS_math_mat4()}SceneJS_math_mulMat4(N,SceneJS_math_mulMat4(C,T),this.billboardMatrix);this.viewport=n.slice(0,4);this.textAxisBoxIntersection=function(e){var t=SceneJS_math_INSIDE_FRUSTUM;var n=[e.min,e.max];var r=null;for(var i=0;i<6;++i){r=w[i];if(r.normal[0]*n[r.testVertex[0]][0]+r.normal[1]*n[r.testVertex[1]][1]+r.normal[2]*n[r.testVertex[2]][2]+r.offset<0){return SceneJS_math_OUTSIDE_FRUSTUM}if(r.normal[0]*n[1-r.testVertex[0]][0]+r.normal[1]*n[1-r.testVertex[1]][1]+r.normal[2]*n[1-r.testVertex[2]][2]+r.offset<0){t=SceneJS_math_INTERSECT_FRUSTUM}}return t};this.getProjectedSize=function(e){var t=SceneJS_math_mat4();SceneJS_math_subVec3(e.max,e.min,t);var r=SceneJS_math_lenVec3(t);var i=Math.abs(r);var s=[(e.min[0]+e.max[0])*.5,(e.min[1]+e.max[1])*.5,(e.min[2]+e.max[2])*.5,0];var o=i*.5;var u=[-o,0,0,1];var a=[o,0,0,1];u=SceneJS_math_mulMat4v4(this.billboardMatrix,u);u=SceneJS_math_addVec4(u,s);u=SceneJS_math_projectVec4(SceneJS_math_mulMat4v4(this.matrix,u));a=SceneJS_math_mulMat4v4(this.billboardMatrix,a);a=SceneJS_math_addVec4(a,s);a=SceneJS_math_projectVec4(SceneJS_math_mulMat4v4(this.matrix,a));return n[2]*Math.abs(a[0]-u[0])};this.getProjectedState=function(e){var t=SceneJS_math_transformPoints3(this.matrix,e);var r=1e7,i=1e7;var s=-1e7,o=-1e7;var u,a,f;var l=t.length;for(var c=0;c<l;++c){u=SceneJS_math_projectVec4(t[c]);a=u[0];f=u[1];if(a<-.5){a=-.5}if(f<-.5){f=-.5}if(a>.5){a=.5}if(f>.5){f=.5}if(a<r){r=a}if(f<i){i=f}if(a>s){s=a}if(f>o){o=f}}r+=.5;i+=.5;s+=.5;o+=.5;var h=n[2],p=n[3];r=r*(h+15);i=i*(p+15);s=s*(h+15);o=o*(p+15);var d=SceneJS_math_mat4();SceneJS_math_subVec2([s,o],[r,i],d);var v=SceneJS_math_lenVec2(d);if(r<0){r=0}if(s>h){s=h}if(i<0){i=0}if(o>p){o=p}return{canvasBox:{min:[r,i],max:[s,o]},canvasSize:v}}};var SceneJS_math_identityQuaternion=function(){return[0,0,0,1]};var SceneJS_math_angleAxisQuaternion=function(e,t,n,r){var i=r/180*Math.PI;var s=i/2;var o=Math.sin(s);return[o*e,o*t,o*n,Math.cos(s)]};var SceneJS_math_mulQuaternions=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3];var o=t[0],u=t[1],a=t[2],f=t[3];return[s*o+n*f+r*a-i*u,s*u+r*f+i*o-n*a,s*a+i*f+n*u-r*o,s*f-n*o-r*u-i*a]};var SceneJS_math_newMat4FromQuaternion=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];var s=2*t;var o=2*n;var u=2*r;var a=s*i;var f=o*i;var l=u*i;var c=s*t;var h=o*t;var p=u*t;var d=o*n;var v=u*n;var m=u*r;var g=SceneJS_math_identityMat4();SceneJS_math_setCellMat4(g,0,0,1-(d+m));SceneJS_math_setCellMat4(g,0,1,h-l);SceneJS_math_setCellMat4(g,0,2,p+f);SceneJS_math_setCellMat4(g,1,0,h+l);SceneJS_math_setCellMat4(g,1,1,1-(c+m));SceneJS_math_setCellMat4(g,1,2,v-a);SceneJS_math_setCellMat4(g,2,0,p-f);SceneJS_math_setCellMat4(g,2,1,v+a);SceneJS_math_setCellMat4(g,2,2,1-(c+d));return g};var SceneJS_math_slerp=function(e,t,n){var r=t[3]*.0174532925;var i=n[3]*.0174532925;var s=r*i+t[0]*n[0]+t[1]*n[1]+t[2]*n[2];if(Math.abs(s)>=1){return[t[0],t[1],t[2],t[3]]}else{var o=Math.acos(s);var u=Math.sqrt(1-s*s);if(Math.abs(u)<.001){return[t[0]*.5+n[0]*.5,t[1]*.5+n[1]*.5,t[2]*.5+n[2]*.5,t[3]*.5+n[3]*.5]}else{var a=Math.sin((1-e)*o)/u;var f=Math.sin(e*o)/u;return[t[0]*a+n[0]*f,t[1]*a+n[1]*f,t[2]*a+n[2]*f,(r*a+i*f)*57.295779579]}}};var SceneJS_math_normalizeQuaternion=function(e){var t=SceneJS_math_lenVec4([e[0],e[1],e[2],e[3]]);return[e[0]/t,e[1]/t,e[2]/t,e[3]/t]};var SceneJS_math_conjugateQuaternion=function(e){return[-e[0],-e[1],-e[2],e[3]]};var SceneJS_math_angleAxisFromQuaternion=function(e){e=SceneJS_math_normalizeQuaternion(e);var t=e[3];var n=2*Math.acos(t);var r=Math.sqrt(1-t*t);if(r<.001){return{x:e[0],y:e[1],z:e[2],angle:n*57.295779579}}else{return{x:e[0]/r,y:e[1]/r,z:e[2]/r,angle:n*57.295779579}}};var SceneJS_webgl_enumMap={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipMapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipMapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipMapLinear:"NEAREST_MIPMAP_LINEAR",linearMipMapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};var SceneJS_webgl_ProgramUniform=function(e,t,n,r,i,s,o){var u=null;if(r==e.BOOL){u=function(t){e.uniform1i(s,t)}}else if(r==e.BOOL_VEC2){u=function(t){e.uniform2iv(s,t)}}else if(r==e.BOOL_VEC3){u=function(t){e.uniform3iv(s,t)}}else if(r==e.BOOL_VEC4){u=function(t){e.uniform4iv(s,t)}}else if(r==e.INT){u=function(t){e.uniform1iv(s,t)}}else if(r==e.INT_VEC2){u=function(t){e.uniform2iv(s,t)}}else if(r==e.INT_VEC3){u=function(t){e.uniform3iv(s,t)}}else if(r==e.INT_VEC4){u=function(t){e.uniform4iv(s,t)}}else if(r==e.FLOAT){u=function(t){e.uniform1f(s,t)}}else if(r==e.FLOAT_VEC2){u=function(t){e.uniform2fv(s,t)}}else if(r==e.FLOAT_VEC3){u=function(t){e.uniform3fv(s,t)}}else if(r==e.FLOAT_VEC4){u=function(t){e.uniform4fv(s,t)}}else if(r==e.FLOAT_MAT2){u=function(t){e.uniformMatrix2fv(s,e.FALSE,t)}}else if(r==e.FLOAT_MAT3){u=function(t){e.uniformMatrix3fv(s,e.FALSE,t)}}else if(r==e.FLOAT_MAT4){u=function(t){e.uniformMatrix4fv(s,e.FALSE,t)}}else{throw"Unsupported shader uniform type: "+r}this.setValue=u;this.getValue=function(){return e.getUniform(t,s)};this.getLocation=function(){return s}};var SceneJS_webgl_ProgramSampler=function(e,t,n,r,i,s){this.bindTexture=function(t,n){if(t.bind(n)){e.uniform1i(s,n);return true}return false}};var SceneJS_webgl_ProgramAttribute=function(e,t,n,r,i,s){this.bindFloatArrayBuffer=function(t){t.bind();e.enableVertexAttribArray(s);e.vertexAttribPointer(s,t.itemSize,e.FLOAT,false,0,0)}};var SceneJS_webgl_Shader=function(e,t,n){this.handle=e.createShader(t);e.shaderSource(this.handle,n);e.compileShader(this.handle);this.valid=e.getShaderParameter(this.handle,e.COMPILE_STATUS)!=0;if(!this.valid){if(!e.isContextLost()){SceneJS.log.error("Shader program failed to compile: "+e.getShaderInfoLog(this.handle));SceneJS.log.error("Shader source:");var r=n.split("\n");for(var i=0;i<r.length;i++){SceneJS.log.error(r[i])}throw SceneJS_error.fatalError(SceneJS.errors.SHADER_COMPILATION_FAILURE,"Shader program failed to compile")}}};var SceneJS_webgl_Program=function(e,t,n){var r,i,s,o,u,a;this._uniforms={};this._samplers={};this._attributes={};this._shaders=[];for(i=0;i<t.length;i++){this._shaders.push(new SceneJS_webgl_Shader(e,e.VERTEX_SHADER,t[i]))}for(i=0;i<n.length;i++){this._shaders.push(new SceneJS_webgl_Shader(e,e.FRAGMENT_SHADER,n[i]))}var f=e.createProgram();for(i=0;i<this._shaders.length;i++){a=this._shaders[i];if(a.valid){e.attachShader(f,a.handle)}}e.linkProgram(f);this.valid=e.getProgramParameter(f,e.LINK_STATUS)!=0;var l=SceneJS_debugModule.getConfigs("shading");if(l.validate!==false){e.validateProgram(f);this.valid=this.valid&&e.getProgramParameter(f,e.VALIDATE_STATUS)!=0}if(!this.valid){if(!e.isglLost()){SceneJS.log.error("Shader program failed to link: "+e.getProgramInfoLog(f));SceneJS.log.error("Vertex shader(s):");for(i=0;i<t.length;i++){SceneJS.log.error("Vertex shader #"+i+":");var c=t[i].split("\n");for(var h=0;h<c.length;h++){SceneJS.log.error(c[h])}}SceneJS.log.error("Fragment shader(s):");for(i=0;i<n.length;i++){SceneJS.log.error("Fragment shader #"+i+":");var c=n[i].split("\n");for(var h=0;h<c.length;h++){SceneJS.log.error(c[h])}}throw SceneJS_error.fatalError(SceneJS.errors.SHADER_LINK_FAILURE,"Shader program failed to link")}}var p=e.getProgramParameter(f,e.ACTIVE_UNIFORMS);for(i=0;i<p;++i){s=e.getActiveUniform(f,i);if(s){o=s.name;if(o[o.length-1]=="\0"){o=o.substr(0,o.length-1)}u=e.getUniformLocation(f,o);if(s.type==e.SAMPLER_2D||s.type==e.SAMPLER_CUBE||s.type==35682){this._samplers[o]=new SceneJS_webgl_ProgramSampler(e,f,o,s.type,s.size,u)}else{this._uniforms[o]=new SceneJS_webgl_ProgramUniform(e,f,o,s.type,s.size,u)}}}var d=e.getProgramParameter(f,e.ACTIVE_ATTRIBUTES);for(i=0;i<d;i++){r=e.getActiveAttrib(f,i);if(r){u=e.getAttribLocation(f,r.name);this._attributes[r.name]=new SceneJS_webgl_ProgramAttribute(e,f,r.name,r.type,r.size,u)}}this.setProfile=function(e){this._profile=e};this.bind=function(){e.useProgram(f);if(this._profile){this._profile.program++}};this.getUniformLocation=function(e){var t=this._uniforms[e];if(t){return t.getLocation()}else{}};this.getUniform=function(e){var t=this._uniforms[e];if(t){return t}else{}};this.setUniform=function(e,t){var n=this._uniforms[e];if(n){n.setValue(t);if(this._profile){this._profile.uniform++}}else{}};this.getAttribute=function(e){var t=this._attributes[e];if(t){return t}else{}};this.bindFloatArrayBuffer=function(e,t){var n=this._attributes[e];if(n){n.bindFloatArrayBuffer(t);if(this._profile){this._profile.varying++}}else{}};this.bindTexture=function(e,t,n){var r=this._samplers[e];if(r){if(this._profile){this._profile.texture++}return r.bindTexture(t,n)}else{return false}};this.unbind=function(){};this.destroy=function(){if(this.valid){e.deleteProgram(f);for(var t in this._shaders){e.deleteShader(this._shaders[t].handle)}this._attributes=null;this._uniforms=null;this._samplers=null;this.valid=false}}};var SceneJS_webgl_Texture2D=function(e,t){this.target=e.TEXTURE_2D;this.minFilter=t.minFilter;this.magFilter=t.magFilter;this.wrapS=t.wrapS;this.wrapT=t.wrapT;this.update=t.update;this.texture=t.texture;this.format=e.RGBA;this.isDepth=false;this.depthMode=0;this.depthCompareMode=0;this.depthCompareFunc=0;try{e.bindTexture(this.target,this.texture);if(t.minFilter){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t.minFilter)}if(t.magFilter){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t.magFilter)}if(t.wrapS){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,t.wrapS)}if(t.wrapT){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,t.wrapT)}if(t.minFilter==e.NEAREST_MIPMAP_NEAREST||t.minFilter==e.LINEAR_MIPMAP_NEAREST||t.minFilter==e.NEAREST_MIPMAP_LINEAR||t.minFilter==e.LINEAR_MIPMAP_LINEAR){e.generateMipmap(e.TEXTURE_2D)}e.bindTexture(this.target,null)}catch(n){throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to create texture: "+n.message||n)}this.bind=function(t){if(this.texture){e.activeTexture(e["TEXTURE"+t]);e.bindTexture(this.target,this.texture);if(this.update){this.update(e)}return true}return false};this.unbind=function(t){if(this.texture){e.activeTexture(e["TEXTURE"+t]);e.bindTexture(this.target,null)}};this.destroy=function(){if(this.texture){e.deleteTexture(this.texture);this.texture=null}}};var SceneJS_webgl_ArrayBuffer=function(e,t,n,r,i,s){this.type=t;this.itemSize=i;this._allocate=function(n,r){this.handle=e.createBuffer();this.handle.numItems=r;this.handle.itemSize=i;e.bindBuffer(t,this.handle);e.bufferData(t,n,s);this.handle.numItems=r;e.bindBuffer(t,null);this.numItems=r;this.length=n.length};this._allocate(n,r);this.bind=function(){e.bindBuffer(t,this.handle)};this.setData=function(n,r){if(n.length>this.length){this.destroy();this._allocate(n,n.length)}else{if(r||r===0){e.bufferSubData(t,r,n)}else{e.bufferData(t,n)}}};this.unbind=function(){e.bindBuffer(t,null)};this.destroy=function(){e.deleteBuffer(this.handle)}};var SceneJS_PickBuffer=function(e){var t=e.canvas;var n=t.gl;var r;var i=false;this.webglRestored=function(e){n=e;r=null};this._touch=function(){var e=t.canvas.width;var s=t.canvas.height;if(r){if(r.width==e&&r.height==s){return}else{n.deleteTexture(r.texture);n.deleteFramebuffer(r.framebuf);n.deleteRenderbuffer(r.renderbuf)}}r={framebuf:n.createFramebuffer(),renderbuf:n.createRenderbuffer(),texture:n.createTexture(),width:e,height:s};n.bindFramebuffer(n.FRAMEBUFFER,r.framebuf);n.bindTexture(n.TEXTURE_2D,r.texture);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);try{n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,s,0,n.RGBA,n.UNSIGNED_BYTE,null)}catch(o){var u=new WebGLUnsignedByteArray(e*s*3);n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,s,0,n.RGBA,n.UNSIGNED_BYTE,u)}n.bindRenderbuffer(n.RENDERBUFFER,r.renderbuf);n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,e,s);n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,r.texture,0);n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,r.renderbuf);n.bindTexture(n.TEXTURE_2D,null);n.bindRenderbuffer(n.RENDERBUFFER,null);n.bindFramebuffer(n.FRAMEBUFFER,null);n.bindFramebuffer(n.FRAMEBUFFER,r.framebuf);if(!n.isFramebuffer(r.framebuf)){throw SceneJS_errorModule.fatalError("Invalid framebuffer")}var a=n.checkFramebufferStatus(n.FRAMEBUFFER);switch(a){case n.FRAMEBUFFER_COMPLETE:break;case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case n.FRAMEBUFFER_UNSUPPORTED:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: "+a)}i=false};this.bind=function(){this._touch();if(i){return}n.bindFramebuffer(n.FRAMEBUFFER,r.framebuf);i=true};this.clear=function(){if(!i){throw"Pick buffer not bound"}n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);n.disable(n.BLEND)};this.read=function(e,r){var i=e;var s=t.canvas.height-r;var o=new Uint8Array(4);n.readPixels(i,s,1,1,n.RGBA,n.UNSIGNED_BYTE,o);return o};this.unbind=function(){n.bindFramebuffer(n.FRAMEBUFFER,null);i=false}};var SceneJS_PickBufferOLD=function(e){var t=e.canvas;var n=e.canvas.gl;var r;this.bound=false;this.init=function(e){n=e;r=null;var i=t.canvas.width;var s=t.canvas.height;if(r){if(r.width==i&&r.height==s){return}else{n.deleteTexture(r.texture);n.deleteFramebuffer(r.framebuf);n.deleteRenderbuffer(r.renderbuf)}}r={framebuf:n.createFramebuffer(),renderbuf:n.createRenderbuffer(),texture:n.createTexture(),width:i,height:s};n.bindFramebuffer(n.FRAMEBUFFER,r.framebuf);n.bindTexture(n.TEXTURE_2D,r.texture);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);try{n.texImage2D(n.TEXTURE_2D,0,n.RGBA,i,s,0,n.RGBA,n.UNSIGNED_BYTE,null)}catch(o){var u=new WebGLUnsignedByteArray(i*s*3);n.texImage2D(n.TEXTURE_2D,0,n.RGBA,i,s,0,n.RGBA,n.UNSIGNED_BYTE,u)}n.bindRenderbuffer(n.RENDERBUFFER,r.renderbuf);n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,i,s);n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,r.texture,0);n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,r.renderbuf);n.bindTexture(n.TEXTURE_2D,null);n.bindRenderbuffer(n.RENDERBUFFER,null);n.bindFramebuffer(n.FRAMEBUFFER,null);n.bindFramebuffer(n.FRAMEBUFFER,r.framebuf);if(!n.isFramebuffer(r.framebuf)){throw SceneJS_error.fatalError("Invalid framebuffer")}var a=n.checkFramebufferStatus(n.FRAMEBUFFER);switch(a){case n.FRAMEBUFFER_COMPLETE:break;case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case n.FRAMEBUFFER_UNSUPPORTED:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw SceneJS_error.fatalError("Incomplete framebuffer: "+a)}this.bound=false};this.bind=function(){if(this.bound){return}n.bindFramebuffer(n.FRAMEBUFFER,r.framebuf);this.bound=true};this.clear=function(){if(this.bound){return}n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);n.disable(n.BLEND)};this.read=function(e,r){var i=e;var s=t.canvas.height-r;var o=new Uint8Array(4);n.readPixels(i,s,1,1,n.RGBA,n.UNSIGNED_BYTE,o);return o};this.unbind=function(){if(this.bound){return}n.bindFramebuffer(n.FRAMEBUFFER,null);this.bound=false};this.init(e.canvas.gl)};var SceneJS_sceneStatusModule=new function(){this.sceneStatus={};var e=this;SceneJS_events.addListener(SceneJS_events.SCENE_CREATED,function(t){e.sceneStatus[t.engine.id]={numLoading:0}});SceneJS_events.addListener(SceneJS_events.SCENE_DESTROYED,function(t){delete e.sceneStatus[t.engine.id]});this.nodeLoading=function(t){var n=e.sceneStatus[t._engine.id];if(!n){n=e.sceneStatus[t._engine.id]={numLoading:0}}n.numLoading++};this.nodeLoaded=function(e){this.sceneStatus[e._engine.id].numLoading--}};var SceneJS_nodeEventsModule=new function(){var e=[];var t=[];var n=0;var r;var i={type:"listeners",stateId:SceneJS._baseStateId++,empty:true,listeners:[]};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){n=0;r=true});SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(s){if(r){if(n>0){var o={type:"listeners",stateId:e[n-1],listeners:t.slice(0,n)};s.display.renderListeners=o}else{s.display.renderListeners=i}r=false}});this.preVisitNode=function(i){var s=i._listeners["rendered"];if(s&&s.length>0){e[n]=i.id;var o=i.__fireRenderedEvent;if(!o){o=i.__fireRenderedEvent=function(e){i._fireEvent("rendered",e)}}t[n]=o;n++;r=true}};this.postVisitNode=function(t){if(t.id==e[n-1]){n--;r=true}}};var SceneJS_Core=function(e){this.type=e;this.coreId=null;this.stateId=null;this.useCount=0};var SceneJS_CoreFactory=function(){this._stateMap=new SceneJS_Map(null,SceneJS._baseStateId);this._cores={}};SceneJS_CoreFactory.coreTypes={};SceneJS_CoreFactory.createCoreType=function(e,t){};SceneJS_CoreFactory.addCoreBuilder=function(e,t){};SceneJS_CoreFactory.coreAliases={rotate:"xform",translate:"xform",scale:"xform",matrix:"xform",xform:"xform"};SceneJS_CoreFactory.prototype.getCore=function(e,t){var n=SceneJS_CoreFactory.coreAliases[e];if(n){e=n}var r=this._cores[e];if(!r){r=this._cores[e]={}}var i;if(t){i=r[t];if(i){i.useCount++;return i}}i=new SceneJS_Core(e);i.useCount=1;i.stateId=this._stateMap.addItem(i);i.coreId=t!=undefined&&t!=null?t:i.stateId;r[i.coreId]=i;return i};SceneJS_CoreFactory.prototype.putCore=function(e){if(e.useCount==0){return}if(--e.useCount<=0){var t=this._cores[e.type];t[e.coreId]=null;this._stateMap.removeItem(e.stateId)}};SceneJS_CoreFactory.prototype.webglRestored=function(){var e;var t;for(var n in this._cores){if(this._cores.hasOwnProperty(n)){e=this._cores[n];if(e){for(var r in e){if(e.hasOwnProperty(r)){t=e[r];if(t.webglRestored){t.webglRestored()}}}}}}};SceneJS.Node=function(){};SceneJS.Node.prototype.constructor=SceneJS.Node;SceneJS.Node.prototype._construct=function(e,t,n,r){this._engine=e;this._core=t;this.id=n.id||n.nodeId||r;this.type=n.type||"node";this.data=n.data;this.parent=null;this.nodes=[];this._listeners={};this._numListeners=0;this.dirty=false;this.branchDirty=false;if(this._init){this._init(n)}};SceneJS.Node.prototype.getScene=function(){return this._engine.scene};SceneJS.Node.prototype.getCoreId=function(){return this._core.coreId};SceneJS.Node.prototype.getID=function(){return this.id};SceneJS.Node.prototype.getId=function(){return this.id};SceneJS.Node.prototype.getNodeId=function(){return this.id};SceneJS.Node.prototype.getType=function(){return this.type};SceneJS.Node.prototype.getData=function(){return this.data};SceneJS.Node.prototype.setData=function(e){this.data=e;return this};SceneJS.Node.prototype.getNumNodes=function(){return this.nodes.length};SceneJS.Node.prototype.getNodes=function(){return this.nodes.slice(0)};SceneJS.Node.prototype.getNodeAt=function(e){if(e<0||e>=this.nodes.length){return null}return this.nodes[e]};SceneJS.Node.prototype.getFirstNode=function(){if(this.nodes.length==0){return null}return this.nodes[0]};SceneJS.Node.prototype.getLastNode=function(){if(this.nodes.length==0){return null}return this.nodes[this.nodes.length-1]};SceneJS.Node.prototype.getNode=function(e){for(var t=0;t<this.nodes.length;t++){if(this.nodes[t].id==e){return this.nodes[t]}}return null};SceneJS.Node.prototype.disconnectNodeAt=function(e){var t=this.nodes.splice(e,1);if(t.length>0){t[0].parent=null;this._engine.display.objectListDirty=true;return t[0]}else{return null}};SceneJS.Node.prototype.disconnect=function(){if(this.parent){for(var e=0;e<this.parent.nodes.length;e++){if(this.parent.nodes[e]===this){return this.parent.disconnectNodeAt(e)}}}return null};SceneJS.Node.prototype.removeNodeAt=function(e){var t=this.disconnectNodeAt(e);if(t){t.destroy();this._engine.display.objectListDirty=true}};SceneJS.Node.prototype.removeNode=function(e){if(!e){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#removeNode - node argument undefined")}if(!e._compile){if(typeof e=="string"){var t=this._engine.nodes.items[e];if(!t){throw SceneJS_error.fatalError(SceneJS.errors.NODE_NOT_FOUND,"Node#removeNode - node not found anywhere: '"+e+"'")}e=t}}if(e._compile){for(var n=0;n<this.nodes.length;n++){if(this.nodes[n]===e){var r=this.removeNodeAt(n);this._engine.display.objectListDirty=true;return r}}}throw SceneJS_error.fatalError(SceneJS.errors.NODE_NOT_FOUND,"Node#removeNode - child node not found: "+(e._compile?": "+e.id:e))};SceneJS.Node.prototype.disconnectNodes=function(){var e=this.nodes.length;for(var t=0;t<e;t++){this.nodes[t].parent=null}var n=this.nodes;this.nodes=[];this._engine.display.objectListDirty=true;return n};SceneJS.Node.prototype.removeNodes=function(){var e=this.disconnectNodes();for(var t=0;t<e.length;t++){this.nodes[t].destroy();this._engine.display.objectListDirty=true}};SceneJS.Node.prototype.splice=function(){var e,t;if(this.parent==null){return null}var n=this.parent;var r=this.disconnectNodes();for(e=0,t=r.length;e<t;e++){r[e].parent=this.parent}for(e=0,t=n.nodes.length;e<t;e++){if(n.nodes[e]===this){n.nodes.splice.apply(n.nodes,[e,1].concat(r));this.nodes=[];this.parent=null;this.destroy();this._engine.branchDirty(n);return n}}};SceneJS.Node.prototype.addNodes=function(e){if(!e){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNodes - nodes argument is undefined")}var t;var n=[];for(var r=e.length-1;r>=0;r--){t=this.addNode(e[r]);n[r]=t;this._engine.branchDirty(t)}return n};SceneJS.Node.prototype.addNode=function(e){if(!e){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is undefined")}if(!e._compile){if(typeof e=="string"){var t=this._engine.nodes.items[e];if(!t){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node not found: '"+e+"'")}e=t}else{e=this._engine.createNode(e)}}if(!e._compile){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is not a Node or subclass")}if(e.parent!=null){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is still attached to another parent")}this.nodes.push(e);e.parent=this;this._engine.branchDirty(e);return e};SceneJS.Node.prototype.insertNode=function(e,t){if(!e){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#insertNode - node argument is undefined")}if(!e._compile){e=this._engine.createNode(e)}if(!e._compile){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#insertNode - node argument is not a Node or subclass!")}if(e.parent!=null){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#insertNode - node argument is still attached to another parent!")}if(t==undefined||t==null){var n=this.disconnectNodes();var r=e;while(r.getNumNodes()>0){r=r.getLastNode()}r.addNodes(n);this.addNode(e)}else if(t<0){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#insertNode - node index out of range: -1")}else if(t>=this.nodes.length){this.nodes.push(e)}else{this.nodes.splice(t,0,e)}e.parent=this;return e};SceneJS.Node.prototype.mapNodes=function(e){if(e(this)){return this}var t;for(var n=0;n<this.nodes.length;n++){t=this.nodes[n].mapNodes(e);if(t){return t}}return null};SceneJS.Node.prototype.addListener=function(e,t,n){var r=this._listeners[e];if(!r){r=[];this._listeners[e]=r}r.push({eventName:e,fn:t,options:n||{}});this._numListeners++;return this};SceneJS.Node.prototype._fireEvent=function(e,t,n){var r=this._listeners[e];if(r){if(!t){t={}}var i={name:e,params:t,options:n||{}};var s;for(var o=0,u=r.length;o<u;o++){s=r[o];if(s.options.scope){s.fn.call(s.options.scope,i)}else{s.fn.call(this,i)}}}};SceneJS.Node.prototype.removeListener=function(e,t){var n=this._listeners[e];if(!n){return null}for(var r=0;r<n.length;r++){if(n[r].fn==t){n.splice(r,1);return t}}this._numListeners--;return null};SceneJS.Node.prototype.hasListener=function(e){return this._listeners[e]};SceneJS.Node.prototype.hasListeners=function(){return this._numListeners>0};SceneJS.Node.prototype.removeListeners=function(){this._listeners={};this._numListeners=0;return this};SceneJS.Node.prototype.getParent=function(){return this.parent};SceneJS.Node.prototype.eachParent=function(e){if(!e){throw"SceneJS.Node.eachParent param 'fn' is null or undefined"}var t=0;var n=this;while(n.parent){if(e.call(n.parent,t++)===true){return n.parent}n=n.parent}return null};SceneJS.Node.prototype.hasNode=function(e){if(e===null||e===undefined){throw"SceneJS.Node.hasNode param 'node' is null or undefined"}var t=typeof e;var n;if(t=="number"){n=this.getNodeAt(e)}else if(t=="string"){n=this.getNode(e)}else{throw"SceneJS.Node.hasNode param 'node' should be either an index number or an ID string"}return n!=undefined&&n!=null};SceneJS.Node.prototype.node=function(e){if(e===null||e===undefined){throw"SceneJS.Node.node param 'node' is null or undefined"}var t=typeof e;var n;if(t=="number"){n=this.getNodeAt(e)}else if(t=="string"){n=this.getNode(e)}else{throw"SceneJS.Node.node param 'node' should be either an index number or an ID string"}if(!n){throw"SceneJS.Node.node - node not found: '"+e+"'"}return n};SceneJS.Node.prototype.eachNode=function(e,t){if(!e){throw"SceneJS.Node.eachNode param 'fn' is null or undefined"}if(typeof e!="function"){throw"SceneJS.Node.eachNode param 'fn' should be a function"}var n;t=t||{};var r=0;if(t.andSelf){if(e.call(this,r++)===true){return this}}if(!t.depthFirst&&!t.breadthFirst){n=this._iterateEachNode(e,this,r)}else if(t.depthFirst){n=this._iterateEachNodeDepthFirst(e,this,r,false)}else{}if(n){return n}return undefined};SceneJS.Node.prototype.numNodes=function(){return this.nodes.length};SceneJS.Node.prototype._iterateEachNode=function(e,t,n){var r=t.nodes.length;var i;for(var s=0;s<r;s++){i=t.nodes[s];if(e.call(i,n++)===true){return i}}return null};SceneJS.Node.prototype._iterateEachNodeDepthFirst=function(e,t,n,r){if(r){if(e.call(t,n++)===true){return t}}r=true;var i=t.nodes.length;var s;for(var o=0;o<i;o++){s=this._iterateEachNodeDepthFirst(e,t.nodes[o],n,r);if(s){return s}}return null};SceneJS.Node.prototype.findNodesByType=function(e,t){return this._findNodesByType(e,[],t)};SceneJS.Node.prototype._findNodesByType=function(e,t,n){var r;for(r=0;r<this.nodes;r++){var i=this.nodes[r];if(i.type==e){t.add(i)}}if(n){for(r=0;r<this.nodes;r++){this.nodes[r]._findNodesByType(e,t,n)}}return t};SceneJS.Node.prototype.findParentByType=function(e){var t=this.parent;while(t&&t.type!=e){t=t.parent}return t};SceneJS.Node.prototype.set=function(e,t){if(typeof e=="object"){for(var n in e){if(e.hasOwnProperty(n)){this.set(n,e[n])}}return}if(this._set){var r=this._set[e];if(r){return r.call(this,t)}}return this._createAccessor("set",e,t)};SceneJS.Node.prototype.get=function(e){if(this._get){var t=this._get[e];if(t){return t.call(this)}}return this._createAccessor("get",e)};SceneJS.Node.prototype.add=function(e,t){if(typeof e=="object"){for(var n in e){if(e.hasOwnProperty(n)){this.add(n,e[n])}}return}if(this._add){var r=this._add[e];if(r){return r.call(this,t)}}return this._createAccessor("add",e,t)};SceneJS.Node.prototype.inc=function(e,t){if(typeof e=="object"){for(var n in e){if(e.hasOwnProperty(n)){this.inc(n,e[n])}}return}if(this._inc){var r=this._inc[e];if(r){return r.call(this,t)}}return this._createAccessor("inc",e,t)};SceneJS.Node.prototype.insert=function(e,t){if(typeof e=="object"){for(var n in e){if(e.hasOwnProperty(n)){this.insert(n,e[n])}}return}if(this._set){var r=this._set[e];if(r){return r.call(this,t)}}return this._createAccessor("insert",e,t)};SceneJS.Node.prototype.remove=function(e,t){if(typeof e=="object"){for(var n in e){if(e.hasOwnProperty(n)){this.remove(n,e[n])}}return}if(this._remove){var r=this._remove[e];if(r){return r.call(this,t)}}return this._createAccessor("remove",e,t)};SceneJS.Node.prototype._createAccessor=function(e,t,n){var r=e+t.substr(0,1).toUpperCase()+t.substr(1);var i=this[r];if(!i){throw"Method not found on node: '"+r+"'"}var s=this.__proto__;var o;switch(e){case"set":o=s._set||(s._set={});break;case"get":o=s._get||(s._get={});break;case"inc":o=s._inc||(s._inc={});break;case"add":o=s._add||(s._add={});break;case"insert":o=s._insert||(s._insert={});break;case"remove":o=s._remove||(s._remove={});break}o[t]=i;return i.call(this,n)};SceneJS.Node.prototype.bind=function(e,t){if(!e){throw"SceneJS.Node.bind param 'name' null or undefined"}if(typeof e!="string"){throw"SceneJS.Node.bind param 'name' should be a string"}if(!t){throw"SceneJS.Node.bind param 'handler' null or undefined"}if(typeof t!="function"){throw"SceneJS.Node.bind param 'handler' should be a function"}this.addListener(e,t,{scope:this});this._engine.branchDirty(this);return this};SceneJS.Node.prototype.unbind=function(e,t){if(!e){throw"SceneJS.Node.bind param 'name' null or undefined"}if(typeof e!="string"){throw"SceneJS.Node.bind param 'name' should be a string"}if(!t){throw"SceneJS.Node.bind param 'handler' null or undefined"}if(typeof t!="function"){throw"SceneJS.Node.bind param 'handler' should be a function"}this.removeListener(e,t);this._engine.branchDirty(this);return this};SceneJS.Node.prototype.getJSON=function(){return this};SceneJS.Node.prototype._compile=function(){this._compileNodes()};SceneJS.Node.prototype._compileNodes=function(){var e=this._listeners["rendered"];if(e){SceneJS_nodeEventsModule.preVisitNode(this)}var t;for(var n=0,r=this.nodes.length;n<r;n++){t=this.nodes[n];t.branchDirty=t.branchDirty||this.branchDirty;if(t.dirty||t.branchDirty||this._engine.sceneDirty){t._compile();t.dirty=false;t.branchDirty=false}}if(e){SceneJS_nodeEventsModule.postVisitNode(this)}};SceneJS.Node.prototype.destroy=function(){if(!this.destroyed){if(this.parent){for(var e=0;e<this.nodes.length;e++){if(this.parent.nodes[e].id===this.id){this.parent.nodes.splice(e,1);break}}}this._destroyTree();this._engine.display.objectListDirty=true}return this};SceneJS.Node.prototype._destroyTree=function(){this.destroyed=true;this._engine.destroyNode(this);for(var e=0,t=this.nodes.length;e<t;e++){this.nodes[e]._destroyTree()}};SceneJS.Node.prototype._doDestroy=function(){if(this._destroy){this._destroy()}return this};var SceneJS_NodeFactory=function(){this.nodes=new SceneJS_Map({})};SceneJS_NodeFactory.nodeTypes={};SceneJS_NodeFactory.createNodeType=function(e,t){var n=function(){SceneJS.Node.apply(this,arguments);this.type=e};n.prototype=new SceneJS.Node;n.prototype.constructor=n;SceneJS_NodeFactory.nodeTypes[e]=n;return n};SceneJS_NodeFactory.prototype.getNode=function(e,t,n){t.type=t.type||"node";var r;if(t.type=="node"){r=SceneJS.Node}else{r=SceneJS_NodeFactory.nodeTypes[t.type];if(!r){throw SceneJS_error.fatalError("node type not supported: '"+t.type+"'")}}var i=new r;var s=t.id||t.nodeId;if(s){this.nodes.addItem(s,i)}else{s=this.nodes.addItem(i)}i._construct(e,n,t,s);return i};SceneJS_NodeFactory.prototype.putNode=function(e){this.nodes.removeItem(e.id)};(function(){var e={type:"camera",stateId:SceneJS._baseStateId++,mat:SceneJS_math_perspectiveMatrix4(45,1,.1,5e3),optics:{type:"perspective",fovy:45,aspect:1,near:.1,far:5e3}};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.projTransform=e;n=0});SceneJS.Camera=SceneJS_NodeFactory.createNodeType("camera");SceneJS.Camera.prototype._init=function(e){if(this._core.useCount==1){this.setOptics(e.optics)}};SceneJS.Camera.prototype.setOptics=function(e){var t=this._core;if(!e){t.optics={type:n,fovy:60,aspect:1,near:.1,far:5e3}}else{var n=e.type||t.optics.type;if(n=="ortho"){t.optics=SceneJS._applyIf(SceneJS_math_ORTHO_OBJ,{type:n,left:e.left,bottom:e.bottom,near:e.near,right:e.right,top:e.top,far:e.far})}else if(n=="frustum"){t.optics={type:n,left:e.left||-1,bottom:e.bottom||-1,near:e.near||.1,right:e.right||1,top:e.top||1,far:e.far||5e3}}else if(n=="perspective"){t.optics={type:n,fovy:e.fovy||60,aspect:e.aspect==undefined?1:e.aspect,near:e.near||.1,far:e.far||5e3}}else if(!e.type){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Camera configuration invalid: optics type not specified - "+"supported types are 'perspective', 'frustum' and 'ortho'")}else{throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Camera configuration invalid: optics type not supported - "+"supported types are 'perspective', 'frustum' and 'ortho'")}}this._rebuild();this._engine.display.imageDirty=true};SceneJS.Camera.prototype._rebuild=function(){var e=this._core.optics;if(e.type=="ortho"){this._core.matrix=SceneJS_math_orthoMat4c(e.left,e.right,e.bottom,e.top,e.near,e.far)}else if(e.type=="frustum"){this._core.matrix=SceneJS_math_frustumMatrix4(e.left,e.right,e.bottom,e.top,e.near,e.far)}else if(e.type=="perspective"){this._core.matrix=SceneJS_math_perspectiveMatrix4(e.fovy*Math.PI/180,e.aspect,e.near,e.far)}if(!this._core.mat){this._core.mat=new Float32Array(this._core.matrix)}else{this._core.mat.set(this._core.matrix)}};SceneJS.Camera.prototype.getOptics=function(){var e={};for(var t in this._core.optics){if(this._core.optics.hasOwnProperty(t)){e[t]=this._core.optics[t]}}return e};SceneJS.Camera.prototype.getMatrix=function(){return this._core.matrix.slice(0)};SceneJS.Camera.prototype._compile=function(){this._engine.display.projTransform=t[n++]=this._core;this._compileNodes();this._engine.display.projTransform=--n>0?t[n-1]:e}})();(function(){var e={type:"clips",stateId:SceneJS._baseStateId++,empty:true,hash:"",clips:[]};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.clips=e;n=0});SceneJS.Clips=SceneJS_NodeFactory.createNodeType("clips");SceneJS.Clips.prototype._init=function(e){if(this._core.useCount==1){var t=e.clips;if(!t){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"clips node attribute missing : 'clips'")}this._core.clips=this._core.clips||[];for(var n=0,r=t.length;n<r;n++){this._setClip(n,t[n])}}};SceneJS.Clips.prototype.setClips=function(e){var t;for(var n in e){if(e.hasOwnProperty(n)){if(n!=undefined||n!=null){t=parseInt(n);if(t<0||t>=this._core.clips.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid argument to set 'clips': index out of range ("+this._core.clips.length+" clips defined)")}this._setClip(t,e[n]||{})}}}this._engine.display.imageDirty=true};SceneJS.Clips.prototype._setClip=function(e,t){var n=this._core.clips[e]||(this._core.clips[e]={});n.normalAndDist=[t.x||0,t.y||0,t.z||0,t.dist||0];var r=t.mode||n.mode||"disabled";if(r!="inside"&&r!="outside"&&r!="disabled"){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"clips node invalid value for property 'mode': should be 'inside' or 'outside' or 'disabled'")}n.mode=r;this._core.hash=null};SceneJS.Clips.prototype._compile=function(){if(!this._core.hash){this._core.hash=this._core.clips.length}this._engine.display.clips=t[n++]=this._core;this._compileNodes();this._engine.display.clips=--n>0?t[n-1]:e}})();(function(){var e={stateId:SceneJS._baseStateId++,type:"flags",picking:true,clipping:true,enabled:true,transparent:false,backfaces:true,frontface:"ccw",backfaceLighting:true,backfaceTexturing:true,specular:true,ambient:true};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.flags=e;n=0});SceneJS.Flags=SceneJS_NodeFactory.createNodeType("flags");SceneJS.Flags.prototype._init=function(e){if(this._core.useCount==1){this._core.picking=true;this._core.clipping=true;this._core.enabled=true;this._core.transparent=false;this._core.backfaces=true;this._core.frontface="ccw";this._core.backfaceLighting=true;this._core.backfaceTexturing=true;this._core.specular=true;this._core.ambient=true;if(e.flags){this.setFlags(e.flags)}}};SceneJS.Flags.prototype.setFlags=function(e){var t=this._core;if(e.picking!=undefined){t.picking=!!e.picking;this._engine.display.drawListDirty=true}if(e.clipping!=undefined){t.clipping=!!e.clipping;this._engine.display.imageDirty=true}if(e.enabled!=undefined){t.enabled=!!e.enabled;this._engine.display.drawListDirty=true}if(e.transparent!=undefined){t.transparent=!!e.transparent;this._engine.display.drawListDirty=true}if(e.backfaces!=undefined){t.backfaces=!!e.backfaces;this._engine.display.imageDirty=true}if(e.frontface!=undefined){t.frontface=!!e.frontface;this._engine.display.imageDirty=true}if(e.backfaceLighting!=undefined){t.backfaceLighting=!!e.backfaceLighting;this._engine.display.imageDirty=true}if(e.backfaceTexturing!=undefined){t.backfaceTexturing=!!e.backfaceTexturing;this._engine.display.imageDirty=true}if(e.specular!=undefined){t.specular=!!e.specular;this._engine.display.imageDirty=true}if(e.ambient!=undefined){t.ambient=!!e.ambient;this._engine.display.imageDirty=true}return this};SceneJS.Flags.prototype.addFlags=function(e){return this.setFlags(e)};SceneJS.Flags.prototype.getFlags=function(){var e=this._core;return{picking:e.picking,clipping:e.clipping,enabled:e.enabled,transparent:e.transparent,backfaces:e.backfaces,frontface:e.frontface,specular:e.specular,ambient:e.ambient}};SceneJS.Flags.prototype.setPicking=function(e){e=!!e;if(this._core.picking!=e){this._core.picking=e;this._engine.display.drawListDirty=true}return this};SceneJS.Flags.prototype.getPicking=function(){return this._core.picking};SceneJS.Flags.prototype.setClipping=function(e){e=!!e;if(this._core.clipping!=e){this._core.clipping=e;this._engine.display.imageDirty=true}return this};SceneJS.Flags.prototype.getClipping=function(){return this._core.clipping};SceneJS.Flags.prototype.setEnabled=function(e){e=!!e;if(this._core.enabled!=e){this._core.enabled=e;this._engine.display.drawListDirty=true}return this};SceneJS.Flags.prototype.getEnabled=function(){return this._core.enabled};SceneJS.Flags.prototype.setTransparent=function(e){e=!!e;if(this._core.transparent!=e){this._core.transparent=e;this._engine.display.drawListDirty=true}return this};SceneJS.Flags.prototype.getTransparent=function(){return this._core.transparent};SceneJS.Flags.prototype.setBackfaces=function(e){e=!!e;if(this._core.backfaces!=e){this._core.backfaces=e;this._engine.display.imageDirty=true}return this};SceneJS.Flags.prototype.getBackfaces=function(){return this._core.backfaces};SceneJS.Flags.prototype.setFrontface=function(e){if(this._core.frontface!=e){this._core.frontface=e;this._engine.display.imageDirty=true}return this};SceneJS.Flags.prototype.getFrontface=function(){return this._core.frontface};SceneJS.Flags.prototype.setBackfaceLighting=function(e){e=!!e;if(this._core.backfaceLighting!=e){this._core.backfaceLighting=e;this._engine.display.imageDirty=true}return this};SceneJS.Flags.prototype.getBackfaceLighting=function(){return this._core.backfaceLighting};SceneJS.Flags.prototype.setBackfaceTexturing=function(e){e=!!e;if(this._core.backfaceTexturing!=e){this._core.backfaceTexturing=e;this._engine.display.imageDirty=true}return this};SceneJS.Flags.prototype.getBackfaceTexturing=function(){return this._core.backfaceTexturing};SceneJS.Flags.prototype.setAmbient=function(e){e=!!e;if(this._core.ambient!=e){this._core.ambient=e;this._engine.display.imageDirty=true}return this};SceneJS.Flags.prototype.getAmbient=function(){return this._core.ambient};SceneJS.Flags.prototype.setAmbient=function(e){e=!!e;if(this._core.ambient!=e){this._core.ambient=e;this._engine.display.imageDirty=true}return this};SceneJS.Flags.prototype.getAmbient=function(){return this._core.ambient};SceneJS.Flags.prototype._compile=function(){this._engine.display.flags=t[n++]=this._core;this._compileNodes();this._engine.display.flags=--n>0?t[n-1]:e}})();new function(){var e={type:"framebuf",stateId:SceneJS._baseStateId++,empty:true,framebuf:null};var t={};var n=[];var r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.framebuf=e;r=0});SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(){var e;for(var n in t){if(t.hasOwnProperty(n)){e=t[n];if(!e._core._loading){e._buildNodeCore()}}}});SceneJS_events.addListener(SceneJS_events.SCENE_DESTROYED,function(e){});SceneJS.Framebuf=SceneJS_NodeFactory.createNodeType("framebuf");SceneJS.Framebuf.prototype._init=function(){t[this._core.coreId]=this;this._buildNodeCore()};SceneJS.Framebuf.prototype._buildNodeCore=function(){var e=this._engine.canvas;var t=e.gl;var n=e.canvas.width;var r=e.canvas.height;var i=t.createFramebuffer();var s=t.createRenderbuffer();var o=t.createTexture();var u=false;if(!this._core){this._core={}}t.bindFramebuffer(t.FRAMEBUFFER,i);t.bindTexture(t.TEXTURE_2D,o);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);try{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,r,0,t.RGBA,t.UNSIGNED_BYTE,null)}catch(a){var f=new WebGLUnsignedByteArray(n*r*4);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,r,0,t.RGBA,t.UNSIGNED_BYTE,f)}t.bindRenderbuffer(t.RENDERBUFFER,s);t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,n,r);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,o,0);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,s);t.bindTexture(t.TEXTURE_2D,null);t.bindRenderbuffer(t.RENDERBUFFER,null);t.bindFramebuffer(t.FRAMEBUFFER,null);t.bindFramebuffer(t.FRAMEBUFFER,i);if(!t.isFramebuffer(i)){throw SceneJS_error.fatalError("Invalid framebuffer")}var l=t.checkFramebufferStatus(t.FRAMEBUFFER);t.bindRenderbuffer(t.RENDERBUFFER,null);t.bindFramebuffer(t.FRAMEBUFFER,null);switch(l){case t.FRAMEBUFFER_COMPLETE:break;case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case t.FRAMEBUFFER_UNSUPPORTED:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw SceneJS_error.fatalError("Incomplete framebuffer: "+l)}this._core.framebuf={id:this.id,bind:function(){t.bindFramebuffer(t.FRAMEBUFFER,i);t.clearColor(0,0,0,1);t.clearDepth(1);t.enable(t.DEPTH_TEST);t.disable(t.CULL_FACE);t.depthRange(0,1);t.disable(t.SCISSOR_TEST);t.disable(t.BLEND)},unbind:function(){t.bindFramebuffer(t.FRAMEBUFFER,null);t.bindRenderbuffer(t.RENDERBUFFER,s);u=true},isRendered:function(){return u},getTexture:function(){return{bind:function(e){t.activeTexture(t["TEXTURE"+e]);t.bindTexture(t.TEXTURE_2D,o)},unbind:function(e){t.activeTexture(t["TEXTURE"+e]);t.bindTexture(t.TEXTURE_2D,null)}}}}};SceneJS.Framebuf.prototype._compile=function(){this._engine.display.framebuf=n[r++]=this._core;this._compileNodes();this._engine.display.framebuf=--r>0?n[r-1]:e};SceneJS.Framebuf.prototype._destroy=function(){if(this._core){}}};new function(){var e=[];var t=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){t=0});SceneJS.Geometry=SceneJS_NodeFactory.createNodeType("geometry");SceneJS.Geometry.prototype._init=function(e){if(this._core.useCount==1){var t={origin:e.origin,scale:e.scale};var n=this;this._sourceConfigs=null;this._source=null;if(e.plugin){this._sourceConfigs=SceneJS._apply({type:e.plugin},e)}else if(e.source){this._sourceConfigs=e.source}if(this._sourceConfigs){if(!this._sourceConfigs.type){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"geometry config expected: source.type")}SceneJS.Plugins.getPlugin("geometry",this._sourceConfigs.type,function(e){if(!e.getSource){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"geometry: 'getSource' method missing on plugin for geometry source type '"+this._sourceConfigs.type+"'.")}n._source=e.getSource();if(!n._source.onUpdate){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"geometry: 'onUpdate' method missing on plugin for geometry source type '"+this._sourceConfigs.type+"'")}n._source.onCreate(function(e){if(t){e.positions=e.positions?new Float32Array(t.scale||t.origin?n._applyOptions(e.positions,t):e.positions):undefined}n._initNodeCore(e);SceneJS.Geometry._buildNodeCore(n._engine.canvas.gl,n._core);n._core._loading=false;n._fireEvent("loaded");n._engine.display.imageDirty=true;n._engine.branchDirty(n)});if(n._source.onUpdate){n._source.onUpdate(function(e){var t=n._core;if(e.positions&&t.vertexBuf){t.vertexBuf.bind();t.vertexBuf.setData(e.positions,e.positionsOffset||0);if(e.positions.length>t.arrays.positions.length){t.arrays.positions=e.positions}else{t.arrays.positions.set(e.positions,e.positionsOffset||0)}}if(e.normals&&t.normalBuf){t.normalBuf.bind();t.normalBuf.setData(e.normals,e.normalsOffset||0);if(e.normals.length>t.arrays.normals.length){t.arrays.normals=e.normals}else{t.arrays.normals.set(e.normals,e.normalsOffset||0)}}if(e.uv&&t.uvBuf){t.uvBuf.bind();t.uvBuf.setData(e.uv,e.uvOffset||0);if(e.uv.length>t.arrays.uv.length){t.arrays.uv=e.uv}else{t.arrays.uv.set(e.uv,e.uvOffset||0)}}if(e.uv2&&t.uvBuf2){t.uvBuf2.bind();t.uvBuf2.setData(e.uv2,e.uv2Offset||0);if(e.uv2.length>t.arrays.uv2.length){t.arrays.uv2=e.uv2}else{t.arrays.uv2.set(e.uv2,e.uv2Offset||0)}}if(e.colors&&t.colorBuf){if(e.colors.length>t.arrays.colors.length){t.arrays.colors=e.colors}else{t.arrays.colors.set(e.colors,e.colorsOffset||0)}t.colorBuf.bind();t.colorBuf.setData(e.colors,e.colorsOffset||0)}if(e.indices&&t.indexBuf){if(e.indices.length>t.arrays.indices.length){t.arrays.indices=e.indices}else{t.arrays.indices.set(e.indices,e.indicesOffset||0)}t.indexBuf.bind();t.indexBuf.setData(e.indices,e.indicesOffset||0);for(var r=0;r<e.indices.length;r++){var i=e.indices[r];if(i<0||i>=t.arrays.positions.length){alert("out of range ")}if(t.arrays.normals&&(i<0||i>=t.arrays.normals.length)){alert("out of range ")}if(t.arrays.uv&&(i<0||i>=t.arrays.uv.length)){alert("out of range ")}if(t.arrays.uv2&&(i<0||i>=t.arrays.uv2.length)){alert("out of range ")}if(t.arrays.colors&&(i<0||i>=t.arrays.colors.length)){alert("out of range ")}}}n._engine.display.imageDirty=true})}n._core._loading=true;n._fireEvent("loading");n._source.setConfigs(n._sourceConfigs)})}else{this._initNodeCore(e,t);SceneJS.Geometry._buildNodeCore(this._engine.canvas.gl,this._core)}this._core.webglRestored=function(){SceneJS.Geometry._buildNodeCore(n._engine.canvas.gl,n._core)}}};SceneJS.Geometry.prototype._initNodeCore=function(e,t){t=t||{};this._core.primitive=this._getPrimitiveType(e.primitive||"triangles");this._core.arrays={positions:e.positions?new Float32Array(t.scale||t.origin?this._applyOptions(e.positions,t):e.positions):undefined,normals:e.normals?new Float32Array(e.normals):undefined,uv:e.uv?new Float32Array(e.uv):undefined,uv2:e.uv2?new Float32Array(e.uv2):undefined,colors:e.colors?new Float32Array(e.colors):undefined,indices:e.indices?new Uint16Array(e.indices):undefined}};SceneJS.Geometry.prototype._getPrimitiveType=function(e){var t=this._engine.canvas.gl;switch(e){case"points":return t.POINTS;case"lines":return t.LINES;case"line-loop":return t.LINE_LOOP;case"line-strip":return t.LINE_STRIP;case"triangles":return t.TRIANGLES;case"triangle-strip":return t.TRIANGLE_STRIP;case"triangle-fan":return t.TRIANGLE_FAN;default:throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"geometry primitive unsupported: '"+e+"' - supported types are: 'points', 'lines', 'line-loop', "+"'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'")}};SceneJS.Geometry.prototype._applyOptions=function(e,t){var n=e.slice?e.slice(0):new Float32Array(e);if(t.scale){var r=t.scale.x!=undefined?t.scale.x:1;var i=t.scale.y!=undefined?t.scale.y:1;var s=t.scale.z!=undefined?t.scale.z:1;for(var o=0,u=n.length;o<u;o+=3){n[o]*=r;n[o+1]*=i;n[o+2]*=s}}if(t.origin){var a=t.origin.x!=undefined?t.origin.x:0;var f=t.origin.y!=undefined?t.origin.y:0;var l=t.origin.z!=undefined?t.origin.z:0;for(var o=0,u=n.length;o<u;o+=3){n[o]-=a;n[o+1]-=f;n[o+2]-=l}}return n};SceneJS.Geometry._buildNodeCore=function(e,t){var n=e.STATIC_DRAW;try{var r=t.arrays;if(r.positions){t.vertexBuf=new SceneJS_webgl_ArrayBuffer(e,e.ARRAY_BUFFER,r.positions,r.positions.length,3,n)}if(r.normals){t.normalBuf=new SceneJS_webgl_ArrayBuffer(e,e.ARRAY_BUFFER,r.normals,r.normals.length,3,n)}if(r.uv){t.uvBuf=new SceneJS_webgl_ArrayBuffer(e,e.ARRAY_BUFFER,r.uv,r.uv.length,2,n)}if(r.uv2){t.uvBuf2=new SceneJS_webgl_ArrayBuffer(e,e.ARRAY_BUFFER,r.uv2,r.uv2.length,2,n)}if(r.colors){t.colorBuf=new SceneJS_webgl_ArrayBuffer(e,e.ARRAY_BUFFER,r.colors,r.colors.length,4,n)}if(r.indices){t.indexBuf=new SceneJS_webgl_ArrayBuffer(e,e.ELEMENT_ARRAY_BUFFER,r.indices,r.indices.length,1,n)}}catch(i){if(t.vertexBuf){t.vertexBuf.destroy();t.vertexBuf=null}if(t.normalBuf){t.normalBuf.destroy();t.normalBuf=null}if(t.uvBuf){t.uvBuf.destroy();t.uvBuf=null}if(t.uvBuf2){t.uvBuf2.destroy();t.uvBuf2=null}if(t.colorBuf){t.colorBuf.destroy();t.colorBuf=null}if(t.indexBuf){t.indexBuf.destroy();t.indexBuf=null}throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to allocate geometry: "+i)}};SceneJS.Geometry.prototype._updateArray=function(e,t,n){var r=e.length;var i=t.length;if(i+n>r){i-=i+n-r}for(var s=n,o=0;o<i;s++,o++){e[s]=t[o]}};SceneJS.Geometry.prototype.setSource=function(e){this._sourceConfigs=e;var t=this._source;if(t){t.setConfigs(e)}};SceneJS.Geometry.prototype.getSource=function(){return this._sourceConfigs||{}};SceneJS.Geometry.prototype.setPositions=function(e){if(e.positions&&this._core.vertexBuf){var t=this._core;t.vertexBuf.bind();t.vertexBuf.setData(new Float32Array(e.positions),e.positionsOffset||0);t.arrays.positions.set(e.positions,e.positionsOffset||0);this._engine.display.imageDirty=true}};SceneJS.Geometry.prototype.getPositions=function(){return this._core.arrays?this._core.arrays.positions:null};SceneJS.Geometry.prototype.setNormals=function(e){if(e.normals&&this._core.normalBuf){var t=this._core;t.normalBuf.bind();t.normalBuf.setData(new Float32Array(e.normals),e.normalsOffset||0);t.arrays.normals.set(e.normals,e.normalsOffset||0);this._engine.display.imageDirty=true}};SceneJS.Geometry.prototype.getNormals=function(){return this._core.arrays?this._core.arrays.normals:null};SceneJS.Geometry.prototype.setColors=function(e){if(e.colors&&this._core.colorBuf){var t=this._core;t.colorBuf.bind();t.colorBuf.setData(new Float32Array(e.colors),e.colorsOffset||0);t.arrays.colors.set(e.colors,e.colorsOffset||0);this._engine.display.imageDirty=true}};SceneJS.Geometry.prototype.getColors=function(){return this._core.arrays?this._core.arrays.colors:null};SceneJS.Geometry.prototype.getIndices=function(){return this._core.arrays?this._core.arrays.indices:null};SceneJS.Geometry.prototype.setUV=function(e){if(e.uv&&this._core.colorBuf){var t=this._core;t.colorBuf.bind();t.colorBuf.setData(new Float32Array(e.uv),e.uvOffset||0);t.arrays.uv.set(e.uv,e.uvOffset||0);this._engine.display.imageDirty=true}};SceneJS.Geometry.prototype.getUV=function(){return this._core.arrays?this._core.arrays.uv:null};SceneJS.Geometry.prototype.setUV2=function(e){if(e.uv2&&this._core.colorBuf){var t=this._core;t.colorBuf.bind();t.colorBuf.setData(new Float32Array(e.uv2),e.uv2Offset||0);t.arrays.uv2.set(e.uv2,e.uv2Offset||0);this._engine.display.imageDirty=true}};SceneJS.Geometry.prototype.getUV2=function(){return this._core.arrays?this._core.arrays.uv2:null};SceneJS.Geometry.prototype.getPrimitive=function(){return this.primitive};SceneJS.Geometry.prototype.getBoundary=function(){if(this._boundary){return this._boundary}var e=this._core.arrays;if(!e){return null}var t=e.positions;if(!t){return null}this._boundary={xmin:SceneJS_math_MAX_DOUBLE,ymin:SceneJS_math_MAX_DOUBLE,zmin:SceneJS_math_MAX_DOUBLE,xmax:SceneJS_math_MIN_DOUBLE,ymax:SceneJS_math_MIN_DOUBLE,zmax:SceneJS_math_MIN_DOUBLE};var n,r,i;for(var s=0,o=t.length-2;s<o;s+=3){n=t[s];r=t[s+1];i=t[s+2];if(n<this._boundary.xmin){this._boundary.xmin=n}if(r<this._boundary.ymin){this._boundary.ymin=r}if(i<this._boundary.zmin){this._boundary.zmin=i}if(n>this._boundary.xmax){this._boundary.xmax=n}if(r>this._boundary.ymax){this._boundary.ymax=r}if(i>this._boundary.zmax){this._boundary.zmax=i}}return this._boundary};SceneJS.Geometry.prototype._compile=function(){if(this._core._loading){this._compileNodes();return}var n=this._core;if(!n.vertexBuf){n=this._inheritVBOs(n)}if(n.indexBuf){n.hash=[n.normalBuf?"t":"f",n.uvBuf?"t":"f",n.uvBuf2?"t":"f",n.colorBuf?"t":"f",n.primitive].join("");n.stateId=this._core.stateId;n.type="geometry";this._engine.display.geometry=e[t++]=n;SceneJS_events.fireEvent(SceneJS_events.OBJECT_COMPILING,{display:this._engine.display});this._engine.display.buildObject(this.id)}else{e[t++]=this._core}this._compileNodes();t--};SceneJS.Geometry.prototype._inheritVBOs=function(n){var r={primitive:n.primitive,boundary:n.boundary,normalBuf:n.normalBuf,uvBuf:n.uvBuf,uvBuf2:n.uvBuf2,colorBuf:n.colorBuf,indexBuf:n.indexBuf};for(var i=t-1;i>=0;i--){if(e[i].vertexBuf){r.vertexBuf=e[i].vertexBuf;r.boundary=e[i].boundary;r.normalBuf=e[i].normalBuf;r.uvBuf=e[i].uvBuf;r.uvBuf2=e[i].uvBuf2;r.colorBuf=e[i].colorBuf;return r}}return r};SceneJS.Geometry.prototype._destroy=function(){this._engine.display.removeObject(this.id);if(this._core.useCount==1){this._destroyNodeCore();if(this._source){this._source.destroy()}}};SceneJS.Geometry.prototype._destroyNodeCore=function(){if(document.getElementById(this._engine.canvas.canvasId)){var e=this._core;if(e.vertexBuf){e.vertexBuf.destroy()}if(e.normalBuf){e.normalBuf.destroy()}if(e.uvBuf){e.uvBuf.destroy()}if(e.uvBuf2){e.uvBuf2.destroy()}if(e.colorBuf){e.colorBuf.destroy()}if(e.indexBuf){e.indexBuf.destroy()}}}};(function(){var e={type:"layer",stateId:SceneJS._baseStateId++,priority:0,enabled:true};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.layer=e;n=0});SceneJS.Layer=SceneJS_NodeFactory.createNodeType("layer");SceneJS.Layer.prototype._init=function(e){if(this._core.useCount==1){this._core.priority=e.priority||0;this._core.enabled=e.enabled!==false}};SceneJS.Layer.prototype.setPriority=function(e){e=e||0;if(this._core.priority!=e){this._core.priority=e;this._engine.display.stateOrderDirty=true}};SceneJS.Layer.prototype.getPriority=function(){return this._core.priority};SceneJS.Layer.prototype.setEnabled=function(e){e=!!e;if(this._core.enabled!=e){this._core.enabled=e;this._engine.display.drawListDirty=true}};SceneJS.Layer.prototype.getEnabled=function(){return this._core.enabled};SceneJS.Layer.prototype._compile=function(){this._engine.display.layer=t[n++]=this._core;this._compileNodes();this._engine.display.layer=--n>0?t[n-1]:e}})();SceneJS.Library=SceneJS_NodeFactory.createNodeType("library");SceneJS.Library.prototype._compile=function(){};(function(){function t(e){if(e.lights&&e.lights.length>0){var t=e.lights;var n=[];var r;for(var i=0,s=t.length;i<s;i++){r=t[i];n.push(r.mode);if(r.specular){n.push("s")}if(r.diffuse){n.push("d")}n.push(r.space=="world"?"w":"v")}e.hash=n.join("")}else{e.hash=""}}var e={type:"lights",stateId:SceneJS._baseStateId++,hash:null,empty:false,lights:[{mode:"ambient",color:[.6,.6,.6],diffuse:true,specular:false},{mode:"dir",color:[1,1,1],diffuse:true,specular:true,dir:[.5,-1,-.6]},{mode:"dir",color:[1,1,1],diffuse:true,specular:true,dir:[-1,0,0]}]};t(e);var n=[];var r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.lights=e;r=0});SceneJS.Lights=SceneJS_NodeFactory.createNodeType("lights");SceneJS.Lights.prototype._init=function(e){if(this._core.useCount==1){var t=e.lights;if(!t){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"lights node attribute missing : 'lights'")}this._core.lights=this._core.lights||[];for(var n=0,r=t.length;n<r;n++){this._setLight(n,t[n])}}};SceneJS.Lights.prototype.setLights=function(e){var t;for(var n in e){if(e.hasOwnProperty(n)){if(n!=undefined||n!=null){t=parseInt(n);if(t<0||t>=this._core.lights.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid argument to set 'lights': index out of range ("+this._core.lights.length+" lights defined)")}this._setLight(t,e[n]||{})}}}this._engine.display.imageDirty=true};SceneJS.Lights.prototype._setLight=function(e,t){var n=this._core.lights[e]||(this._core.lights[e]=[]);var r=t.mode||"dir";if(r!="dir"&&r!="point"&&r!="ambient"){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Light mode not supported - should be 'dir' or 'point' or 'ambient'")}var i=t.pos;var s=t.dir;var o=t.color;n.color=[o.r!=undefined?o.r:1,o.g!=undefined?o.g:1,o.b!=undefined?o.b:1];n.mode=r;n.diffuse=r=="ambient"?true:t.diffuse!=undefined?t.diffuse:true;n.specular=r=="ambient"?false:t.specular!=undefined?t.specular:true;n.pos=t.pos?[i.x||0,i.y||0,i.z||0]:undefined;n.dir=t.dir?[s.x||0,s.y||0,s.z||0]:undefined;n.constantAttenuation=t.constantAttenuation!=undefined?t.constantAttenuation:1;n.linearAttenuation=t.linearAttenuation||0;n.quadraticAttenuation=t.quadraticAttenuation||0;var u=t.space;if(!u){u="world"}else if(u!="view"&&u!="world"){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"lights node invalid value for property 'space': '"+u+"' - should be 'view' or 'world'")}n.space=u;this._core.hash=null};SceneJS.Lights.prototype._compile=function(){if(!this._core.hash){t(this._core)}this._engine.display.lights=n[r++]=this._core;this._compileNodes();this._engine.display.lights=--r>0?n[r-1]:e}})();(function(){var e=SceneJS_math_identityMat4();var t=new Float32Array(e);var n=SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(SceneJS_math_identityMat4(),SceneJS_math_mat4()));var r=new Float32Array(n);var i={type:"lookAt",stateId:SceneJS._baseStateId++,matrix:e,mat:t,normalMatrix:n,normalMat:r,lookAt:SceneJS_math_LOOKAT_ARRAYS};var s=[];var o=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(e){e.engine.display.viewTransform=i;o=0});SceneJS.Lookat=SceneJS_NodeFactory.createNodeType("lookAt");SceneJS.Lookat.prototype._init=function(e){this._mat=null;this._xf={type:"lookat"};if(this._core.useCount==1){this._core.eyeX=0;this._core.eyeY=0;this._core.eyeZ=1;this._core.lookX=0;this._core.lookY=0;this._core.lookZ=0;this._core.upX=0;this._core.upY=1;this._core.upZ=0;if(!e.eye&&!e.look&&!e.up){this.setEye({x:0,y:0,z:1});this.setLook({x:0,y:0,z:0});this.setUp({x:0,y:1,z:0})}else{this.setEye(e.eye);this.setLook(e.look);this.setUp(e.up)}var t=this._core;this._core.rebuild=function(){t.matrix=SceneJS_math_lookAtMat4c(t.eyeX,t.eyeY,t.eyeZ,t.lookX,t.lookY,t.lookZ,t.upX,t.upY,t.upZ);t.lookAt={eye:[t.eyeX,t.eyeY,t.eyeZ],look:[t.lookX,t.lookY,t.lookZ],up:[t.upX,t.upY,t.upZ]};if(!t.mat){t.mat=new Float32Array(t.matrix);t.normalMat=new Float32Array(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(t.matrix,SceneJS_math_mat4())))}else{t.mat.set(t.matrix);t.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(t.matrix,SceneJS_math_mat4())))}t.dirty=false};this._core.dirty=true}};SceneJS.Lookat.prototype.setEye=function(e){e=e||{};if(e.x!=undefined&&e.x!=null){this._core.eyeX=e.x}if(e.y!=undefined&&e.y!=null){this._core.eyeY=e.y}if(e.z!=undefined&&e.z!=null){this._core.eyeZ=e.z}this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incEye=function(e){e=e||{};this._core.eyeX+=e.x!=undefined&&e.x!=null?e.x:0;this._core.eyeY+=e.y!=undefined&&e.y!=null?e.y:0;this._core.eyeZ+=e.z!=undefined&&e.z!=null?e.z:0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setEyeX=function(e){this._core.eyeX=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setEyeY=function(e){this._core.eyeY=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setEyeZ=function(e){this._core.eyeZ=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incEyeX=function(e){this._core.eyeX+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incEyeY=function(e){this._core.eyeY+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incEyeZ=function(e){this._core.eyeZ+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.getEye=function(){return{x:this._core.eyeX,y:this._core.eyeY,z:this._core.eyeZ}};SceneJS.Lookat.prototype.setLook=function(e){e=e||{};if(e.x!=undefined&&e.x!=null){this._core.lookX=e.x}if(e.y!=undefined&&e.y!=null){this._core.lookY=e.y}if(e.z!=undefined&&e.z!=null){this._core.lookZ=e.z}this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incLook=function(e){e=e||{};this._core.lookX+=e.x!=undefined&&e.x!=null?e.x:0;this._core.lookY+=e.y!=undefined&&e.y!=null?e.y:0;this._core.lookZ+=e.z!=undefined&&e.z!=null?e.z:0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setLookX=function(e){this._core.lookX=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setLookY=function(e){this._core.lookY=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setLookZ=function(e){this._core.lookZ=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incLookX=function(e){this._core.lookX+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incLookY=function(e){this._core.lookY+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incLookZ=function(e){this._core.lookZ+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.getLook=function(){return{x:this._core.lookX,y:this._core.lookY,z:this._core.lookZ}};SceneJS.Lookat.prototype.setUp=function(e){e=e||{};if(e.x!=undefined&&e.x!=null){this._core.upX=e.x}if(e.y!=undefined&&e.y!=null){this._core.upY=e.y}if(e.z!=undefined&&e.z!=null){this._core.upZ=e.z}this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incUp=function(e){e=e||{};this._core.upX+=e.x!=undefined&&e.x!=null?e.x:0;this._core.upY+=e.y!=undefined&&e.y!=null?e.y:0;this._core.upZ+=e.z!=undefined&&e.z!=null?e.z:0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setUpX=function(e){this._core.upX=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setUpY=function(e){this._core.upY=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.setUpZ=function(e){this._core.upZ=e||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incUpX=function(e){this._core.upX+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incUpY=function(e){this._core.upY+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.incUpZ=function(e){this._core.upZ+=e;this._core.dirty=true;this._engine.display.imageDirty=true;return this};SceneJS.Lookat.prototype.getUp=function(){return{x:this._core.upX,y:this._core.upY,z:this._core.upZ}};SceneJS.Lookat.prototype.getMatrix=function(){if(this._core.dirty){this._core.rebuild()}return this._mat.slice(0)};SceneJS.Lookat.prototype.getAttributes=function(){return{look:{x:this._core.lookX,y:this._core.lookY,z:this._core.lookZ},eye:{x:this._core.eyeX,y:this._core.eyeY,z:this._core.eyeZ},up:{x:this._core.upX,y:this._core.upY,z:this._core.upZ}}};SceneJS.Lookat.prototype._compile=function(){this._engine.display.viewTransform=s[o++]=this._core;this._compileNodes();this._engine.display.viewTransform=--o>0?s[o-1]:i}})();new function(){var e={type:"material",stateId:SceneJS._baseStateId++,baseColor:[1,1,1],specularColor:[1,1,1],specular:.4,shine:20,alpha:1,emit:0};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.material=e;n=0});SceneJS.Material=SceneJS_NodeFactory.createNodeType("material");SceneJS.Material.prototype._init=function(e){if(this._core.useCount==1){this.setBaseColor(e.baseColor);this.setSpecularColor(e.specularColor);this.setSpecular(e.specular);this.setShine(e.shine);this.setEmit(e.emit);this.setAlpha(e.alpha)}};SceneJS.Material.prototype.setBaseColor=function(t){var n=e.baseColor;this._core.baseColor=t?[t.r!=undefined&&t.r!=null?t.r:n[0],t.g!=undefined&&t.g!=null?t.g:n[1],t.b!=undefined&&t.b!=null?t.b:n[2]]:e.baseColor;this._engine.display.imageDirty=true;return this};SceneJS.Material.prototype.getBaseColor=function(){return{r:this._core.baseColor[0],g:this._core.baseColor[1],b:this._core.baseColor[2]}};SceneJS.Material.prototype.setSpecularColor=function(t){var n=e.specularColor;this._core.specularColor=t?[t.r!=undefined&&t.r!=null?t.r:n[0],t.g!=undefined&&t.g!=null?t.g:n[1],t.b!=undefined&&t.b!=null?t.b:n[2]]:e.specularColor;this._engine.display.imageDirty=true;return this};SceneJS.Material.prototype.getSpecularColor=function(){return{r:this._core.specularColor[0],g:this._core.specularColor[1],b:this._core.specularColor[2]}};SceneJS.Material.prototype.setSpecular=function(t){this._core.specular=t!=undefined&&t!=null?t:e.specular;this._engine.display.imageDirty=true;return this};SceneJS.Material.prototype.getSpecular=function(){return this._core.specular};SceneJS.Material.prototype.setShine=function(t){this._core.shine=t!=undefined&&t!=null?t:e.shine;this._engine.display.imageDirty=true;return this};SceneJS.Material.prototype.getShine=function(){return this._core.shine};SceneJS.Material.prototype.setEmit=function(t){this._core.emit=t!=undefined&&t!=null?t:e.emit;this._engine.display.imageDirty=true;return this};SceneJS.Material.prototype.getEmit=function(){return this._core.emit};SceneJS.Material.prototype.setAlpha=function(t){this._core.alpha=t!=undefined&&t!=null?t:e.alpha;this._engine.display.imageDirty=true;return this};SceneJS.Material.prototype.getAlpha=function(){return this._core.alpha};SceneJS.Material.prototype._compile=function(){this._engine.display.material=t[n++]=this._core;this._compileNodes();this._engine.display.material=--n>0?t[n-1]:e}};new function(){var e={type:"morphGeometry",stateId:SceneJS._baseStateId++,hash:"",morph:null};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.morphGeometry=e;n=0});SceneJS.MorphGeometry=SceneJS_NodeFactory.createNodeType("morphGeometry");SceneJS.MorphGeometry.prototype._init=function(e){if(this._core.useCount==1){this._sourceConfigs=e.source;this._source=null;if(e.source){if(!e.source.type){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry config expected: source.type")}var t=SceneJS.Plugins.getPlugin(SceneJS.Plugins.MORPH_GEO_SOURCE_PLUGIN,this._sourceConfigs.type);if(!t){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: no support for source type '"+this._sourceConfigs.type+"' - need to include plugin for this source type, "+"or install a custom source service with SceneJS.Plugins.addPlugin(SceneJS.Plugins.MORPH_GEO_SOURCE_PLUGIN, '"+this._sourceConfigs.type+"', <your service>).")}if(!t.getSource){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: 'getSource' method not found on MorphGeoFactoryService (SceneJS.Plugins.MORPH_GEO_SOURCE_PLUGIN)")}this._source=t.getSource();if(!this._source.onUpdate){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: 'onUpdate' method not found on source provided by plugin type '"+e.source.type+"'")}var n=this;this._source.onCreate(function(e){n._buildNodeCore(e);n._core._loading=false;n._fireEvent("loaded");n._engine.branchDirty(this)});if(this._source.onUpdate){this._source.onUpdate(function(e){if(e.targets){var t=e.targets;var r;var i;var s=n._core.targets;var o;for(var u=0,a=t.length;u<a;u++){r=t[u];i=r.targetIndex;o=s[i];if(r.positions&&o.vertexBuf){o.vertexBuf.bind();o.vertexBuf.setData(r.positions,0)}}}n._display.imageDirty=true})}this._core._loading=true;this._fireEvent("loading");this._source.setConfigs(this._sourceConfigs)}else if(e.create instanceof Function){this._buildNodeCore(e.create())}else{this._buildNodeCore(e)}this._core.webglRestored=function(){};this.setFactor(e.factor)}this._core.factor=e.factor||0;this._core.clamp=!!e.clamp};SceneJS.MorphGeometry.prototype._buildNodeCore=function(e){var t=e.targets||[];if(t.length<2){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry node should have at least two targets")}var n=e.keys||[];if(n.length!=t.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry node mismatch in number of keys and targets")}var r=this._core;var i=this._engine.canvas.gl;var s=i.STATIC_DRAW;r.keys=n;r.targets=[];r.key1=0;r.key2=1;var o;var u;var a;var f;var l;for(var c=0,h=t.length;c<h;c++){l=t[c];if(!o&&l.positions){o=l.positions}if(!u&&l.normals){u=l.normals}if(!a&&l.uv){a=l.uv}if(!f&&l.uv2){f=l.uv2}}try{var p;var d;for(var c=0,h=t.length;c<h;c++){l=t[c];p={};d=l.positions||o;if(d){p.vertexBuf=new SceneJS_webgl_ArrayBuffer(i,i.ARRAY_BUFFER,typeof d=="Float32Array"?d:new Float32Array(d),d.length,3,s);o=d}d=l.normals||u;if(d){p.normalBuf=new SceneJS_webgl_ArrayBuffer(i,i.ARRAY_BUFFER,typeof d=="Float32Array"?d:new Float32Array(d),d.length,3,s);u=d}d=l.uv||a;if(d){p.uvBuf=new SceneJS_webgl_ArrayBuffer(i,i.ARRAY_BUFFER,typeof d=="Float32Array"?d:new Float32Array(d),d.length,2,s);a=d}d=l.uv2||f;if(d){p.uvBuf2=new SceneJS_webgl_ArrayBuffer(i,i.ARRAY_BUFFER,typeof d=="Float32Array"?d:new Float32Array(d),d.length,2,s);f=d}r.targets.push(p)}}catch(v){for(var c=0,h=r.targets.length;c<h;c++){p=r.targets[c];if(p.vertexBuf){p.vertexBuf.destroy()}if(p.normalBuf){p.normalBuf.destroy()}if(p.uvBuf){p.uvBuf.destroy()}if(p.uvBuf2){p.uvBuf2.destroy()}}throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to allocate VBO(s) for morphGeometry: "+v)}};SceneJS.MorphGeometry.prototype.setSource=function(e){this._sourceConfigs=e;var t=this._source;if(t){t.setConfigs(e)}};SceneJS.MorphGeometry.prototype.getSource=function(){return this._sourceConfigs};SceneJS.MorphGeometry.prototype.setFactor=function(e){e=e||0;var t=this._core;var n=t.keys;var r=t.key1;var i=t.key2;if(e<n[0]){r=0;i=1}else if(e>n[n.length-1]){r=n.length-2;i=r+1}else{while(n[r]>e){r--;i--}while(n[i]<e){r++;i++}}t.factor=(e-n[r])/(n[i]-n[r]);t.key1=r;t.key2=i;this._engine.display.imageDirty=true};SceneJS.MorphGeometry.prototype.getFactor=function(){return this._core.factor};SceneJS.MorphGeometry.prototype._compile=function(){if(!this._core.hash){this._makeHash()}this._engine.display.morphGeometry=t[n++]=this._core;this._compileNodes();this._engine.display.morphGeometry=--n>0?t[n-1]:e};SceneJS.MorphGeometry.prototype._makeHash=function(){var e=this._core;if(e.targets.length>0){var t=e.targets[0];var n="t";var r="f";e.hash=[t.vertexBuf?n:r,t.normalBuf?n:r,t.uvBuf?n:r,t.uvBuf2?n:r].join("")}else{e.hash=""}};SceneJS.MorphGeometry.prototype._destroy=function(){if(this._core.useCount==1){if(document.getElementById(this._engine.canvas.canvasId)){var e=this._core;var t;for(var n=0,r=e.targets.length;n<r;n++){t=e.targets[n];if(t.vertexBuf){t.vertexBuf.destroy()}if(t.normalBuf){t.normalBuf.destroy()}if(t.uvBuf){t.uvBuf.destroy()}if(t.uvBuf2){t.uvBuf2.destroy()}}}if(this._source){this._source.destroy()}}}};(function(){var e={type:"name",stateId:SceneJS._baseStateId++,name:null};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.name=e;n=0});SceneJS.Name=SceneJS_NodeFactory.createNodeType("name");SceneJS.Name.prototype._init=function(e){if(this._core.useCount==1){this.setName(e.name)}};SceneJS.Name.prototype.setName=function(e){this._core.name=e||"unnamed";this._engine.display.imageDirty=true};SceneJS.Name.prototype.getName=function(){return this._core.name};SceneJS.Name.prototype._compile=function(){this._engine.display.name=t[n++]=this._core;this._compileNodes();this._engine.display.name=--n>0?t[n-1]:e}})();new function(){function i(e){var t;if(r>0){t={};for(var n in e){if(e.hasOwnProperty(n)){if(!(e[n]==undefined)){t[n]=s(n)}}}}o(e.props);return{props:e,setProps:function(t){u(t,e)},restoreProps:function(e){if(t){a(e,t)}}}}function o(e){var t;for(var n in e){if(e.hasOwnProperty(n)){t=e[n];if(t!=undefined&&t!=null){if(l[n]){e[n]=l[n](null,t)}else if(c[n]){e[n]=c[n](null,t)}}}}}var e={type:"renderer",stateId:SceneJS._baseStateId++,props:null};var t;var n=[];var r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(i){t=i.engine.canvas;r=0;i.engine.display.renderer=n[r++]=e});var s=function(e){var t;var i;for(var s=r-1;s>=0;s--){t=n[s].props;i=t[e];if(i!=undefined&&i!=null){return t[e]}}return null};var u=function(e,t){for(var n in t){if(t.hasOwnProperty(n)){var r=l[n];if(r){r(e,t[n])}}}if(t.viewport){c.viewport(e,t.viewport)}if(t.scissor){c.clear(e,t.scissor)}if(t.clear){c.clear(e,t.clear)}};var a=function(e,t){var n;for(var r in t){if(t.hasOwnProperty(r)){n=t[r];if(n!=undefined&&n!=null){var i=l[r];if(i){i(e,n)}}}}if(t.viewport){c.viewport(e,t.viewport)}if(t.scissor){c.clear(e,t.scissor)}};var f=function(e,t){if(!t){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,'Null SceneJS.State node config: "'+t+'"')}var n=SceneJS_webgl_enumMap[t];if(!n){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,'Unrecognised SceneJS.State node config value: "'+t+'"')}var r=e[n];if(!r){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"This browser's WebGL does not support renderer node config value: \""+t+'"')}return r};var l={enableBlend:function(e,t){if(!e){if(t==null||t==undefined){t=false}return t}if(t){e.enable(e.BLEND)}else{e.disable(e.BLEND)}},blendColor:function(e,t){if(!e){t=t||{};return{r:t.r||0,g:t.g||0,b:t.b||0,a:t.a==undefined||t.a==null?1:t.a}}e.blendColor(t.r,t.g,t.b,t.a)},blendEquation:function(e,t){if(!e){return t||"funcAdd"}e.blendEquation(e,f(e,t))},blendEquationSeparate:function(e,t){if(!e){t=t||{};return{rgb:t.rgb||"funcAdd",alpha:t.alpha||"funcAdd"}}e.blendEquation(f(e,t.rgb),f(e,t.alpha))},blendFunc:function(e,t){if(!e){t=t||{};return{sfactor:t.sfactor||"srcAlpha",dfactor:t.dfactor||"oneMinusSrcAlpha"}}e.blendFunc(f(e,t.sfactor||"srcAlpha"),f(e,t.dfactor||"oneMinusSrcAlpha"))},blendFuncSeparate:function(e,t){if(!e){t=t||{};return{srcRGB:t.srcRGB||"zero",dstRGB:t.dstRGB||"zero",srcAlpha:t.srcAlpha||"zero",dstAlpha:t.dstAlpha||"zero"}}e.blendFuncSeparate(f(e,t.srcRGB||"zero"),f(e,t.dstRGB||"zero"),f(e,t.srcAlpha||"zero"),f(e,t.dstAlpha||"zero"))},clearColor:function(e,t){if(!e){t=t||{};return{r:t.r||0,g:t.g||0,b:t.b||0,a:t.a==undefined||t.a==null?1:t.a}}e.clearColor(t.r,t.g,t.b,t.a)},clearDepth:function(e,t){if(!e){return t==null||t==undefined?1:t}e.clearDepth(t)},clearStencil:function(e,t){if(!e){return t||0}e.clearStencil(t)},colorMask:function(e,t){if(!e){t=t||{};return{r:t.r||0,g:t.g||0,b:t.b||0,a:t.a==undefined||t.a==null?1:t.a}}e.colorMask(t.r,t.g,t.b,t.a)},enableCullFace:function(e,t){if(!e){return t}if(t){e.enable(e.CULL_FACE)}else{e.disable(e.CULL_FACE)}},cullFace:function(e,t){if(!e){return t||"back"}e.cullFace(f(e,t))},enableDepthTest:function(e,t){if(!e){if(t==null||t==undefined){t=true}return t}if(t){e.enable(e.DEPTH_TEST)}else{e.disable(e.DEPTH_TEST)}},depthFunc:function(e,t){if(!e){return t||"less"}e.depthFunc(f(e,t))},enableDepthMask:function(e,t){if(!e){if(t==null||t==undefined){t=true}return t}e.depthMask(t)},depthRange:function(e,t){if(!e){t=t||{};return{zNear:t.zNear==undefined||t.zNear==null?0:t.zNear,zFar:t.zFar==undefined||t.zFar==null?1:t.zFar}}e.depthRange(t.zNear,t.zFar)},frontFace:function(e,t){if(!e){return t||"ccw"}e.frontFace(f(e,t))},lineWidth:function(e,t){if(!e){return t||1}e.lineWidth(t)},enableScissorTest:function(e,t){if(!e){return t}if(t){e.enable(e.SCISSOR_TEST)}else{t=false;e.disable(e.SCISSOR_TEST)}}};var c={viewport:function(e,n){if(!e){n=n||{};return{x:n.x||1,y:n.y||1,width:n.width||t.canvas.width,height:n.height||t.canvas.height}}e.viewport(n.x,n.y,n.width,n.height)},scissor:function(e,t){if(!e){t=t||{};return{x:t.x||0,y:t.y||0,width:t.width||1,height:t.height||1}}e.scissor(t.x,t.y,t.width,t.height)},clear:function(e,t){if(!e){t=t||{};return t}var n;if(t.color){n=e.COLOR_BUFFER_BIT}if(t.depth){n=n|e.DEPTH_BUFFER_BIT}if(t.stencil){n=n|e.STENCIL_BUFFER_BIT}if(n){}}};SceneJS.Renderer=SceneJS_NodeFactory.createNodeType("renderer");SceneJS.Renderer.prototype._init=function(e){if(this._core.useCount==1){for(var t in e){if(e.hasOwnProperty(t)){this._core[t]=e[t]}}this._core.dirty=true}};SceneJS.Renderer.prototype.setViewport=function(e){this._core.viewport=e?{x:e.x||1,y:e.y||1,width:e.width||1e3,height:e.height||1e3}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getViewport=function(){return this._core.viewport?{x:this._core.viewport.x,y:this._core.viewport.y,width:this._core.viewport.width,height:this._core.viewport.height}:undefined};SceneJS.Renderer.prototype.setScissor=function(e){this._core.scissor=e?{x:e.x||1,y:e.y||1,width:e.width||1e3,height:e.height||1e3}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getScissor=function(){return this._core.scissor?{x:this._core.scissor.x,y:this._core.scissor.y,width:this._core.scissor.width,height:this._core.scissor.height}:undefined};SceneJS.Renderer.prototype.setClear=function(e){this._core.clear=e?{r:e.r||0,g:e.g||0,b:e.b||0}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getClear=function(){return this._core.clear?{r:this._core.clear.r,g:this._core.clear.g,b:this._core.clear.b}:null};SceneJS.Renderer.prototype.setEnableBlend=function(e){this._core.enableBlend=e;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableBlend=function(){return this._core.enableBlend};SceneJS.Renderer.prototype.setBlendColor=function(e){this._core.blendColor=e?{r:e.r||0,g:e.g||0,b:e.b||0,a:e.a==undefined||e.a==null?1:e.a}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendColor=function(){return this._core.blendColor?{r:this._core.blendColor.r,g:this._core.blendColor.g,b:this._core.blendColor.b,a:this._core.blendColor.a}:undefined};SceneJS.Renderer.prototype.setBlendEquation=function(e){this._core.blendEquation=e;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendEquation=function(){return this._core.blendEquation};SceneJS.Renderer.prototype.setBlendEquationSeparate=function(e){this._core.blendEquationSeparate=e?{rgb:e.rgb||"funcAdd",alpha:e.alpha||"funcAdd"}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendEquationSeparate=function(){return this._core.blendEquationSeparate?{rgb:this._core.rgb,alpha:this._core.alpha}:undefined};SceneJS.Renderer.prototype.setBlendFunc=function(e){this._core.blendFunc=e?{sfactor:e.sfactor||"srcAlpha",dfactor:e.dfactor||"one"}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendFunc=function(){return this._core.blendFunc?{sfactor:this._core.sfactor,dfactor:this._core.dfactor}:undefined};SceneJS.Renderer.prototype.setBlendFuncSeparate=function(e){this._core.blendFuncSeparate=e?{srcRGB:e.srcRGB||"zero",dstRGB:e.dstRGB||"zero",srcAlpha:e.srcAlpha||"zero",dstAlpha:e.dstAlpha||"zero"}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendFuncSeparate=function(){return this._core.blendFuncSeparate?{srcRGB:this._core.blendFuncSeparate.srcRGB,dstRGB:this._core.blendFuncSeparate.dstRGB,srcAlpha:this._core.blendFuncSeparate.srcAlpha,dstAlpha:this._core.blendFuncSeparate.dstAlpha}:undefined};SceneJS.Renderer.prototype.setEnableCullFace=function(e){this._core.enableCullFace=e;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableCullFace=function(){return this._core.enableCullFace};SceneJS.Renderer.prototype.setCullFace=function(e){this._core.cullFace=e;this._core.dirty=true};SceneJS.Renderer.prototype.getCullFace=function(){return this._core.cullFace};SceneJS.Renderer.prototype.setEnableDepthTest=function(e){this._core.enableDepthTest=e;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableDepthTest=function(){return this._core.enableDepthTest};SceneJS.Renderer.prototype.setDepthFunc=function(e){this._core.depthFunc=e;this._core.dirty=true};SceneJS.Renderer.prototype.getDepthFunc=function(){return this._core.depthFunc};SceneJS.Renderer.prototype.setEnableDepthMask=function(e){this._core.enableDepthMask=e;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableDepthMask=function(){return this._core.enableDepthMask};SceneJS.Renderer.prototype.setClearDepth=function(e){this._core.clearDepth=e;this._core.dirty=true};SceneJS.Renderer.prototype.getClearDepth=function(){return this._core.clearDepth};SceneJS.Renderer.prototype.setDepthRange=function(e){this._core.depthRange=e?{zNear:e.zNear==undefined||e.zNear==null?0:e.zNear,zFar:e.zFar==undefined||e.zFar==null?1:e.zFar}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getDepthRange=function(){return this._core.depthRange?{zNear:this._core.depthRange.zNear,zFar:this._core.depthRange.zFar}:undefined};SceneJS.Renderer.prototype.setFrontFace=function(e){this._core.frontFace=e;this._core.dirty=true};SceneJS.Renderer.prototype.getFrontFace=function(){return this._core.frontFace};SceneJS.Renderer.prototype.setLineWidth=function(e){this._core.lineWidth=e;this._core.dirty=true};SceneJS.Renderer.prototype.getLineWidth=function(){return this._core.lineWidth};SceneJS.Renderer.prototype.setEnableScissorTest=function(e){this._core.enableScissorTest=e;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableScissorTest=function(){return this._core.enableScissorTest};SceneJS.Renderer.prototype.setClearStencil=function(e){this._core.clearStencil=e;this._core.dirty=true};SceneJS.Renderer.prototype.getClearStencil=function(){return this._core.clearStencil};SceneJS.Renderer.prototype.setColorMask=function(e){this._core.colorMask=e?{r:e.r||0,g:e.g||0,b:e.b||0,a:e.a==undefined||e.a==null?1:e.a}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getColorMask=function(){return this._core.colorMask?{r:this._core.colorMask.r,g:this._core.colorMask.g,b:this._core.colorMask.b,a:this._core.colorMask.a}:undefined};SceneJS.Renderer.prototype._compile=function(){this._compileNodes()}};SceneJS.Scene=SceneJS_NodeFactory.createNodeType("scene");SceneJS.Scene.prototype._init=function(e){if(e.tagMask){this.setTagMask(e.tagMask)}this._tagSelector=null};SceneJS.Scene.prototype.onEvent=function(e,t){return this._engine.events.onEvent(e,t)};SceneJS.Scene.prototype.unEvent=function(e){this._engine.events.unEvent(e)};SceneJS.Scene.prototype.loseWebGLContext=function(){this._engine.loseWebGLContext()};SceneJS.Scene.prototype.getCanvas=function(){return this._engine.canvas.canvas};SceneJS.Scene.prototype.getGL=function(){return this._engine.canvas.gl};SceneJS.Scene.prototype.getZBufferDepth=function(){var e=this._engine.canvas.gl;return e.getParameter(e.DEPTH_BITS)};SceneJS.Scene.prototype.setTagMask=function(e){if(!this._tagSelector){this._tagSelector={}}this._tagSelector.mask=e;this._tagSelector.regex=e?new RegExp(e):null;this._engine.display.selectTags(this._tagSelector)};SceneJS.Scene.prototype.getTagMask=function(){return this._tagSelector?this._tagSelector.mask:null};SceneJS.Scene.prototype.renderFrame=function(e){return this._engine.renderFrame(e)};SceneJS.Scene.prototype.start=function(e){this._engine.start(e)};SceneJS.Scene.prototype.pause=function(e){this._engine.pause(e)};SceneJS.Scene.prototype.isRunning=function(){return this._engine.running};SceneJS.Scene.prototype.pick=function(e,t,n){return this._engine.pick(e,t,n)};SceneJS.Scene.prototype.destroy=function(){if(!this.destroyed){delete SceneJS._engines[this.id];SceneJS._engineIds.removeItem(this.id);this.destroyed=true}};SceneJS.Scene.prototype.isActive=function(){return!this._engine.destroyed};SceneJS.Scene.prototype.stop=function(){this._engine.stop()};SceneJS.Scene.prototype.containsNode=function(e){return!!this._engine.findNode(e)};SceneJS.Scene.prototype.findNodes=function(e){return this._engine.findNodes(e)};SceneJS.Scene.prototype.findNode=function(e){return this._engine.findNode(e)};SceneJS.Scene.prototype.getNode=function(e){return this._engine.findNode(e)};SceneJS.Scene.prototype.getStatus=function(){return this._engine.destroyed?{destroyed:true}:SceneJS._shallowClone(SceneJS_sceneStatusModule.sceneStatus[this.id])};new function(){function f(e){var t;var n={};var r;for(var i=0;i<u;i++){t=e[i];for(r in t){if(t.hasOwnProperty(r)){n[r]=t[r]}}}return n}function l(e,t){var n;for(var r in e){if(e.hasOwnProperty(r)){n=t[r];if(!n){n=t[r]=[]}n.push(e[r])}}}var e={type:"shader",stateId:SceneJS._baseStateId++,hash:"",empty:true,shader:{}};var t=[];var n=[];var r=[];var i=[];var s=[];var o=[];var u=0;var a=true;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.shader=e;u=0;a=true});SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(l){if(a){if(u>0){var c={type:"shader",stateId:t[u-1],hash:t.slice(0,u).join("."),shaders:{fragment:{code:i.slice(0,u).join("\n"),hooks:f(s)},vertex:{code:n.slice(0,u).join("\n"),hooks:f(r)}},paramsStack:o.slice(0,u)};l.display.shader=c}else{l.display.shader=e}a=false}});SceneJS.Shader=SceneJS_NodeFactory.createNodeType("shader");SceneJS.Shader.prototype._init=function(e){if(this._core.useCount==1){this._setShaders(e.shaders);this.setParams(e.params)}};SceneJS.Shader.prototype._setShaders=function(e){e=e||[];this._core.shaders={};var t;for(var n=0,r=e.length;n<r;n++){t=e[n];if(!t.stage){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"shader 'stage' attribute expected")}var i;if(t.code){if(SceneJS._isArray(t.code)){i=t.code.join("")}else{i=t.code}}this._core.shaders[t.stage]={code:i,hooks:t.hooks}}};SceneJS.Shader.prototype.setParams=function(e){e=e||{};var t=this._core.params;if(!t){t=this._core.params={}}for(var n in e){if(e.hasOwnProperty(n)){t[n]=e[n]}}this._engine.display.imageDirty=true};SceneJS.Shader.prototype.getParams=function(){var e=this._core.params;if(!e){return{}}var t={};for(var n in e){if(e.hasOwnProperty(n)){t[n]=e[n]}}return t};SceneJS.Shader.prototype._compile=function(){t[u]=this._core.coreId;var e=this._core.shaders;var f=e.fragment||{};var l=e.vertex||{};i[u]=f.code||"";s[u]=f.hooks||{};n[u]=l.code||"";r[u]=l.hooks||{};o[u]=this._core.params||{};u++;a=true;this._compileNodes();u--;a=true}};new function(){var e={type:"shaderParams",stateId:SceneJS._baseStateId++,empty:true};var t=[];var n=[];var r=0;var i;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.shaderParams=e;r=0;i=true});SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(s){if(i){if(r>0){var o={type:"shaderParams",stateId:t[r-1],paramsStack:n.slice(0,r)};s.display.shaderParams=o}else{s.display.shaderParams=e}i=false}});SceneJS.ShaderParams=SceneJS_NodeFactory.createNodeType("shaderParams");SceneJS.ShaderParams.prototype._init=function(e){if(this._core.useCount==1){this.setParams(e.params)}};SceneJS.ShaderParams.prototype.setParams=function(e){e=e||{};var t=this._core;if(!t.params){t.params={}}for(var n in e){if(e.hasOwnProperty(n)){t.params[n]=e[n]}}this._engine.display.imageDirty=true};SceneJS.ShaderParams.prototype.getParams=function(){var e=this._core.params;if(!e){return{}}var t={};for(var n in e){if(e.hasOwnProperty(n)){t[n]=e[n]}}return t};SceneJS.ShaderParams.prototype._compile=function(){t[r]=this._core.coreId;n[r]=this._core.params;r++;i=true;this._compileNodes();r--;i=true}};(function(){var e={type:"tag",stateId:SceneJS._baseStateId++,tag:null};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.tag=e;n=0});SceneJS.Tag=SceneJS_NodeFactory.createNodeType("tag");SceneJS.Tag.prototype._init=function(e){if(this._core.useCount==1){if(!e.tag){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"tag node attribute missing : 'tag'")}this.setTag(e.tag)}};SceneJS.Tag.prototype.setTag=function(e){var t=this._core;t.tag=e;t.pattern=null;t.matched=false;this._engine.display.drawListDirty=true};SceneJS.Tag.prototype.getTag=function(){return this._core.tag};SceneJS.Tag.prototype._compile=function(){this._engine.display.tag=t[n++]=this._core;this._compileNodes();this._engine.display.tag=--n>0?t[n-1]:e}})();new function(){var e={type:"texture",stateId:SceneJS._baseStateId++,empty:true,hash:""};var t=[];var n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.texture=e;n=0});SceneJS.Texture=SceneJS_NodeFactory.createNodeType("texture");SceneJS.Texture.prototype._init=function(e){if(this._core.useCount==1){this._core.layers=[];this._core.params={};var t=!!e.waitForLoad;if(!e.layers){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layers missing")}if(!SceneJS._isArray(e.layers)){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layers should be an array")}var n;var r=this._engine.canvas.gl;for(var i=0;i<e.layers.length;i++){n=e.layers[i];if(!n.source&&!n.uri&&!n.src&&!n.framebuf&&!n.video){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+"  has no uri, src, source, framebuf, video or canvasId specified")}if(n.applyFrom){if(n.applyFrom!="uv"&&n.applyFrom!="uv2"&&n.applyFrom!="normal"&&n.applyFrom!="geometry"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+"  applyFrom value is unsupported - "+"should be either 'uv', 'uv2', 'normal' or 'geometry'")}}if(n.applyTo){if(n.applyTo!="baseColor"&&n.applyTo!="specular"&&n.applyTo!="emit"&&n.applyTo!="alpha"&&n.applyTo!="normals"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+" applyTo value is unsupported - "+"should be either 'baseColor', 'specular' or 'normals'")}}if(n.blendMode){if(n.blendMode!="add"&&n.blendMode!="multiply"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+" blendMode value is unsupported - "+"should be either 'add' or 'multiply'")}}var s=SceneJS._apply(n,{waitForLoad:t,texture:null,applyFrom:n.applyFrom||"uv",applyTo:n.applyTo||"baseColor",blendMode:n.blendMode||"multiply",blendFactor:n.blendFactor!=undefined&&n.blendFactor!=null?n.blendFactor:1,translate:{x:0,y:0},scale:{x:1,y:1},rotate:{z:0}});this._core.layers.push(s);this._setLayerTransform(n,s);if(s.framebuf){var o=this._engine.findNode(s.framebuf);if(o&&o.type=="framebuf"){s.texture=o._core.framebuf.getTexture()}}else{this._loadLayerTexture(r,s)}}var u=this;this._core.webglRestored=function(){var e=u._core.layers;var t=u._engine.canvas.gl;for(var n=0,r=e.length;n<r;n++){u._loadLayerTexture(t,e[n])}}}};SceneJS.Texture.prototype._loadLayerTexture=function(e,t){SceneJS_sceneStatusModule.nodeLoading(this);this._engine.nodeLoading(this);this._fireEvent("loading");var n=this;var r=t.source;if(r){if(!r.type){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"texture layer config expected: source.type")}SceneJS.Plugins.getPlugin("texture",r.type,function(i){if(!i.getSource){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"texture: 'getSource' method missing on plugin for texture source type '"+r.type+"'.")}var s=i.getSource({gl:e});if(!s.onUpdate){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"texture: 'onUpdate' method missing on plugin for texture source type '"+r.type+"'")}s.onUpdate(function(){var r=false;return function(){if(!r){r=true;n._setLayerTexture(e,t,s.getTexture())}else{n._engine.display.imageDirty=true}}}());s.setConfigs(r);t._source=s})}else{var i=new Image;i.onload=function(){var r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n._ensureImageSizePowerOfTwo(i));n._setLayerTexture(e,t,r)};i.crossOrigin="";i.src=t.uri||t.src}};SceneJS.Texture.prototype._ensureImageSizePowerOfTwo=function(e){if(!this._isPowerOfTwo(e.width)||!this._isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=this._nextHighestPowerOfTwo(e.width);t.height=this._nextHighestPowerOfTwo(e.height);var n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height);e=t;e.crossOrigin=""}return e};SceneJS.Texture.prototype._isPowerOfTwo=function(e){return(e&e-1)==0};SceneJS.Texture.prototype._nextHighestPowerOfTwo=function(e){--e;for(var t=1;t<32;t<<=1){e=e|e>>t}return e+1};SceneJS.Texture.prototype._setLayerTexture=function(e,t,n){t.texture=new SceneJS_webgl_Texture2D(e,{texture:n,minFilter:this._getGLOption("minFilter",e,t,e.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",e,t,e.LINEAR),wrapS:this._getGLOption("wrapS",e,t,e.CLAMP_TO_EDGE),wrapT:this._getGLOption("wrapT",e,t,e.CLAMP_TO_EDGE),isDepth:this._getOption(t.isDepth,false),depthMode:this._getGLOption("depthMode",e,t,e.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",e,t,e.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",e,t,e.LEQUAL),flipY:this._getOption(t.flipY,true),width:this._getOption(t.width,1),height:this._getOption(t.height,1),internalFormat:this._getGLOption("internalFormat",e,t,e.LEQUAL),sourceFormat:this._getGLOption("sourceType",e,t,e.ALPHA),sourceType:this._getGLOption("sourceType",e,t,e.UNSIGNED_BYTE),update:null});SceneJS_sceneStatusModule.nodeLoaded(this);this._engine.nodeLoaded(this);this._fireEvent("loaded");if(this.destroyed){t.texture.destroy()}this._engine.display.imageDirty=true};SceneJS.Texture.prototype._getGLOption=function(e,t,n,r){var i=n[e];if(i==undefined){return r}var s=SceneJS_webgl_enumMap[i];if(s==undefined){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised value for texture node property '"+e+"' value: '"+i+"'")}var o=t[s];return o};SceneJS.Texture.prototype._getOption=function(e,t){return e==undefined?t:e};SceneJS.Texture.prototype.setLayer=function(e){if(e.index==undefined||e.index==null){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index null or undefined")}if(e.index<0||e.index>=this._core.layers.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index out of range ("+this._core.layers.length+" layers defined)")}this._setLayer(parseInt(e.index),e);this._engine.display.imageDirty=true};SceneJS.Texture.prototype.setLayers=function(e){var t;for(var n in e){if(e.hasOwnProperty(n)){if(n!=undefined||n!=null){t=parseInt(n);if(t<0||t>=this._core.layers.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index out of range ("+this._core.layers.length+" layers defined)")}this._setLayer(t,e[n]||{})}}}this._engine.display.imageDirty=true};SceneJS.Texture.prototype._setLayer=function(e,t){t=t||{};var n=this._core.layers[e];if(t.blendFactor!=undefined&&t.blendFactor!=null){n.blendFactor=t.blendFactor}if(t.source){var r=n._source;if(r){r.setConfigs(t.source)}}if(t.translate||t.rotate||t.scale){this._setLayerTransform(t,n)}};SceneJS.Texture.prototype._setLayerTransform=function(e,t){var n;var r;if(e.translate){var i=e.translate;if(i.x!=undefined){t.translate.x=i.x}if(i.y!=undefined){t.translate.y=i.y}n=SceneJS_math_translationMat4v([i.x||0,i.y||0,0])}if(e.scale){var s=e.scale;if(s.x!=undefined){t.scale.x=s.x}if(s.y!=undefined){t.scale.y=s.y}r=SceneJS_math_scalingMat4v([s.x||1,s.y||1,1]);n=n?SceneJS_math_mulMat4(n,r):r}if(e.rotate){var o=e.rotate;if(o.z!=undefined){t.rotate.z=o.z||0}r=SceneJS_math_rotationMat4v(o.z*.0174532925,[0,0,1]);n=n?SceneJS_math_mulMat4(n,r):r}if(n){t.matrix=n;if(!t.matrixAsArray){t.matrixAsArray=new Float32Array(t.matrix)}else{t.matrixAsArray.set(t.matrix)}t.matrixAsArray=new Float32Array(t.matrix)}};SceneJS.Texture.prototype._compile=function(){if(!this._core.hash){this._makeHash()}this._engine.display.texture=t[n++]=this._core;this._compileNodes();this._engine.display.texture=--n>0?t[n-1]:e};SceneJS.Texture.prototype._makeHash=function(){var e=this._core;var t;if(e.layers&&e.layers.length>0){var n=e.layers;var r=[];var i;for(var s=0,o=n.length;s<o;s++){i=n[s];r.push("/");r.push(i.applyFrom);r.push("/");r.push(i.applyTo);r.push("/");r.push(i.blendMode);if(i.matrix){r.push("/anim")}}t=r.join("")}else{t=""}if(e.hash!=t){e.hash=t}};SceneJS.Texture.prototype._destroy=function(){if(this._core.useCount==1){var e=this._core.layers;var t;var n;for(var r=0,i=e.length;r<i;r++){t=e[r];if(t.texture){t.texture.destroy()}n=t._source;if(n&&n.destroy){n.destroy()}}}}};SceneJS.XForm=SceneJS_NodeFactory.createNodeType("xform");SceneJS.XForm.prototype._init=function(e){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setElements(e.elements)}};SceneJS.XForm.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.XForm.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.XForm.prototype.setElements=function(e){e=e||SceneJS_math_identityMat4();if(e.length!=16){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.XForm elements should number 16")}var t=this._core;if(!t.matrix){t.matrix=e}else{for(var n=0;n<16;n++){t.matrix[n]=e[n]}}t.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.XForm.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};SceneJS.Matrix=SceneJS_NodeFactory.createNodeType("matrix");SceneJS.Matrix.prototype._init=function(e){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setElements(e.elements)}};SceneJS.Matrix.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.Matrix.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.Matrix.prototype.setMatrix=function(e){e=e||SceneJS_math_identityMat4();if(e.length!=16){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Matrix elements should number 16")}var t=this._core;if(!t.matrix){t.matrix=e}else{for(var n=0;n<16;n++){t.matrix[n]=e[n]}}t.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Matrix.prototype.setElements=SceneJS.Matrix.prototype.setMatrix;SceneJS.Matrix.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};SceneJS.Rotate=SceneJS_NodeFactory.createNodeType("rotate");SceneJS.Rotate.prototype._init=function(e){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setMultOrder(e.multOrder);this.setAngle(e.angle);this.setXYZ({x:e.x,y:e.y,z:e.z});var t=this._core;this._core.buildMatrix=function(){t.matrix=SceneJS_math_rotationMat4v(t.angle*Math.PI/180,[t.x,t.y,t.z])}}};SceneJS.Rotate.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.Rotate.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.Rotate.prototype.setMultOrder=function(e){e=e||"post";if(e!="post"&&e!="pre"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for rotate node - '"+e+"' should be 'pre' or 'post'")}this._core.multOrder=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.setAngle=function(e){this._core.angle=e||0;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getAngle=function(){return this._core.angle};SceneJS.Rotate.prototype.setXYZ=function(e){e=e||{};this._core.x=e.x||0;this._core.y=e.y||0;this._core.z=e.z||0;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}};SceneJS.Rotate.prototype.setX=function(e){this._core.x=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getX=function(){return this._core.x};SceneJS.Rotate.prototype.setY=function(e){this._core.y=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getY=function(){return this._core.y};SceneJS.Rotate.prototype.setZ=function(e){this._core.z=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getZ=function(){return this._core.z};SceneJS.Rotate.prototype.incAngle=function(e){this._core.angle+=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};SceneJS.Translate=SceneJS_NodeFactory.createNodeType("translate");SceneJS.Translate.prototype._init=function(e){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setMultOrder(e.multOrder);this.setXYZ({x:e.x,y:e.y,z:e.z});var t=this._core;this._core.buildMatrix=function(){t.matrix=SceneJS_math_translationMat4v([t.x,t.y,t.z],t.matrix)}}};SceneJS.Translate.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.Translate.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.Translate.prototype.setMultOrder=function(e){e=e||"post";if(e!="post"&&e!="pre"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for translate node - '"+e+"' should be 'pre' or 'post'")}this._core.multOrder=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Translate.prototype.setXYZ=function(e){e=e||{};this._core.x=e.x||0;this._core.y=e.y||0;this._core.z=e.z||0;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}};SceneJS.Translate.prototype.setX=function(e){this._core.x=e;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.getX=function(){return this._core.x};SceneJS.Translate.prototype.setY=function(e){this._core.y=e;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.getY=function(){return this._core.y};SceneJS.Translate.prototype.setZ=function(e){this._core.z=e;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.getZ=function(){return this._core.z};SceneJS.Translate.prototype.incX=function(e){this._core.x+=e;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.incY=function(e){this._core.y+=e;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.incZ=function(e){this._core.z+=e;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};SceneJS.Scale=SceneJS_NodeFactory.createNodeType("scale");SceneJS.Scale.prototype._init=function(e){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setMultOrder(e.multOrder);this.setXYZ({x:e.x,y:e.y,z:e.z});var t=this._core;this._core.buildMatrix=function(){t.matrix=SceneJS_math_scalingMat4v([t.x,t.y,t.z])}}};SceneJS.Scale.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.Scale.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.Scale.prototype.setMultOrder=function(e){e=e||"post";if(e!="post"&&e!="pre"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for scale node - '"+e+"' should be 'pre' or 'post'")}this._core.multOrder=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getAngle=function(){return this._core.angle};SceneJS.Scale.prototype.setXYZ=function(e){e=e||{};this._core.x=e.x||0;this._core.y=e.y||0;this._core.z=e.z||0;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}};SceneJS.Scale.prototype.setX=function(e){this._core.x=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getX=function(){return this._core.x};SceneJS.Scale.prototype.setY=function(e){this._core.y=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getY=function(){return this._core.y};SceneJS.Scale.prototype.setZ=function(e){this._core.z=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getZ=function(){return this._core.z};SceneJS.Scale.prototype.incX=function(e){this._core.x+=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.incY=function(e){this._core.y+=e;this._core.matrixDirty=true};SceneJS.Scale.prototype.incZ=function(e){this._core.z+=e;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};var SceneJS_modelXFormStack=new function(){var e=SceneJS_math_identityMat4();var t=new Float32Array(e);var n=SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(SceneJS_math_identityMat4(),SceneJS_math_mat4()));var r=new Float32Array(n);var i={type:"xform",stateId:SceneJS._baseStateId++,matrix:e,mat:t,normalMatrix:n,normalMat:r,parent:null,cores:[],numCores:0,dirty:false,matrixDirty:false};var s=[];var o=0;this.top=i;var u;var a=this;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){o=0;a.top=i;u=true});SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(e){if(u){if(o>0){e.display.modelTransform=s[o-1]}else{e.display.modelTransform=i}u=false}});this.buildCore=function(e){function t(e){e.dirty=true;e.matrixDirty=true;for(var n=0,r=e.numCores;n<r;n++){t(e.cores[n])}}e.parent=null;e.cores=[];e.numCores=0;e.matrixDirty=false;e.matrix=SceneJS_math_identityMat4();e.mat=new Float32Array(e.matrix);e.normalMat=new Float32Array(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(e.matrix,SceneJS_math_mat4())));e.dirty=false;e.setDirty=function(){e.matrixDirty=true;if(e.dirty){}t(e)};e.build=function(){if(e.matrixDirty){if(e.buildMatrix){e.buildMatrix()}e.matrixDirty=false}var t=e.parent;var n;if(t){n=e.matrix.slice(0);while(t){if(t.matrixDirty){if(t.buildMatrix){t.buildMatrix()}t.mat.set(t.matrix);t.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(t.matrix,SceneJS_math_mat4())));t.matrixDirty=false}SceneJS_math_mulMat4(t.matrix,n,n);if(!t.dirty){}t=t.parent}}else{n=e.matrix}e.mat.set(n);e.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(n,SceneJS_math_mat4())));e.dirty=false}};this.push=function(e){s[o++]=e;e.parent=this.top;e.dirty=true;if(this.top){this.top.cores[this.top.numCores++]=e}e.numCores=0;this.top=e;u=true};this.pop=function(){this.top=--o>0?s[o-1]:i;u=true}};var SceneJS_Display=function(e){this._canvas=e.canvas;this._programFactory=new SceneJS_ProgramFactory({canvas:e.canvas});this._chunkFactory=new SceneJS_ChunkFactory;this.flags=null;this.layer=null;this.renderer=null;this.lights=null;this.material=null;this.texture=null;this.modelTransform=null;this.viewTransform=null;this.projTransform=null;this.framebuf=null;this.clips=null;this.morphGeometry=null;this.name=null;this.tag=null;this.renderListeners=null;this.shader=null;this.shaderParams=null;this.geometry=null;this._objectFactory=new SceneJS_ObjectFactory;this._objects={};this._ambientColor=[0,0,0];this._objectList=[];this._objectListLen=0;this._opaqueDrawList=[];this._opaqueDrawListLen=0;this._transparentDrawList=[];this._transparentDrawListLen=0;this._pickDrawList=[];this._pickDrawListLen=0;this._frameCtx={pickNames:[],canvas:this._canvas};this._frameCtx.renderListenerCtx=new SceneJS.RenderContext(this._frameCtx);this.objectListDirty=true;this.stateOrderDirty=true;this.stateSortDirty=true;this.drawListDirty=true;this.imageDirty=true;this.pickBufDirty=true;this.rayPickBufDirty=true};SceneJS_Display.prototype.webglRestored=function(){this._programFactory.webglRestored();this._chunkFactory.webglRestored();var e=this._canvas.gl;if(this.pickBuf){this.pickBuf.webglRestored(e)}if(this.rayPickBuf){this.rayPickBuf.webglRestored(e)}this.imageDirty=true};SceneJS_Display.prototype.buildObject=function(e){var t=this._objects[e];if(!t){t=this._objects[e]=this._objectFactory.getObject(e);this.objectListDirty=true}t.layer=this.layer;t.texture=this.texture;t.geometry=this.geometry;t.flags=this.flags;t.tag=this.tag;var n=[this.geometry.hash,this.shader.hash,this.clips.hash,this.morphGeometry.hash,this.texture.hash,this.lights.hash].join(";");if(!t.program||n!=t.hash){if(t.program){this._programFactory.putProgram(t.program)}t.program=this._programFactory.getProgram(n,this);t.hash=n}this._setChunk(t,0,"program");this._setChunk(t,1,"xform",this.modelTransform);this._setChunk(t,2,"lookAt",this.viewTransform);this._setChunk(t,3,"camera",this.projTransform);this._setChunk(t,4,"flags",this.flags);this._setChunk(t,5,"shader",this.shader);this._setChunk(t,6,"shaderParams",this.shaderParams);this._setChunk(t,7,"name",this.name);this._setChunk(t,8,"lights",this.lights);this._setChunk(t,9,"material",this.material);this._setChunk(t,10,"texture",this.texture);this._setChunk(t,11,"framebuf",this.framebuf);this._setChunk(t,12,"clips",this.clips);this._setChunk(t,13,"morphGeometry",this.morphGeometry);this._setChunk(t,14,"listeners",this.renderListeners);this._setChunk(t,15,"geometry",this.geometry)};SceneJS_Display.prototype._setChunk=function(e,t,n,r,i){var s;if(i){s=r.stateId+1}else if(r){if(r.empty){var o=e.chunks[t];if(o){this._chunkFactory.putChunk(o)}e.chunks[t]=null;return}s=(e.program.id+1)*5e4+r.stateId+1}else{s=(e.program.id+1)*5e4}var o=e.chunks[t];if(o){if(o.id==s){return}this._chunkFactory.putChunk(o)}e.chunks[t]=this._chunkFactory.getChunk(s,n,e.program,r);if(n=="lights"){this._setAmbient(r)}};SceneJS_Display.prototype._setAmbient=function(e){var t=e.lights;var n;for(var r=0,i=t.length;r<i;r++){n=t[r];if(n.mode=="ambient"){this._ambientColor=n.color}}};SceneJS_Display.prototype.removeObject=function(e){var t=this._objects[e];if(!t){return}this._programFactory.putProgram(t.program);t.program=null;t.hash=null;this._objectFactory.putObject(t);delete this._objects[e];this.objectListDirty=true};SceneJS_Display.prototype.selectTags=function(e){this._tagSelector=e;this.drawListDirty=true};SceneJS_Display.prototype.render=function(e){e=e||{};if(this.objectListDirty){this._buildObjectList();this.objectListDirty=false;this.stateOrderDirty=true}if(this.stateOrderDirty){this._makeStateSortKeys();this.stateOrderDirty=false;this.stateSortDirty=true}if(this.stateSortDirty){this._stateSort();this.stateSortDirty=false;this.drawListDirty=true}if(this.drawListDirty){this._buildDrawList();this.imageDirty=true}if(this.imageDirty||e.force){this._doDrawList(false);this.imageDirty=false;this.pickBufDirty=true}};SceneJS_Display.prototype._buildObjectList=function(){this._objectListLen=0;for(var e in this._objects){if(this._objects.hasOwnProperty(e)){this._objectList[this._objectListLen++]=this._objects[e]}}};SceneJS_Display.prototype._makeStateSortKeys=function(){var e;for(var t=0,n=this._objectListLen;t<n;t++){e=this._objectList[t];e.sortKey=e.program?(e.layer.priority+1)*1e8+(e.program.id+1)*1e5+e.texture.stateId*1e3:-1}};SceneJS_Display.prototype._stateSort=function(){this._objectList.length=this._objectListLen;this._objectList.sort(this._stateSortObjects)};SceneJS_Display.prototype._stateSortObjects=function(e,t){return e.sortKey-t.sortKey};SceneJS_Display.prototype._buildDrawList=function(){this._lastStateId=this._lastStateId||[];this._lastPickStateId=this._lastPickStateId||[];for(var e=0;e<20;e++){this._lastStateId[e]=null;this._lastPickStateId[e]=null}this._opaqueDrawListLen=0;this._pickDrawListLen=0;this._transparentDrawListLen=0;var t;var n;var r;var i;var s;var o;var u;var a;var f;if(this._tagSelector){n=this._tagSelector.mask;r=this._tagSelector.regex}if(!this._xpBuf){this._xpBuf=[]}this._xpBufLen=0;for(var e=0,l=this._objectListLen;e<l;e++){t=this._objectList[e];s=t.flags;if(s.enabled===false){continue}if(!t.layer.enabled){continue}if(n){i=t.tag;if(i.tag){if(i.mask!=n){i.mask=n;i.matches=r.test(i.tag)}if(!i.matches){continue}}}a=s.transparent;if(a){this._xpBuf[this._xpBufLen++]=t}o=t.chunks;f=s.picking;for(var c=0,h=o.length;c<h;c++){u=o[c];if(u){if(!a&&u.draw){if(u.unique||this._lastStateId[c]!=u.id){this._opaqueDrawList[this._opaqueDrawListLen++]=u;this._lastStateId[c]=u.id}}if(u.pick){if(f){if(u.unique||this._lastPickStateId[c]!=u.id){this._pickDrawList[this._pickDrawListLen++]=u;this._lastPickStateId[c]=u.id}}}}}}if(this._xpBufLen>0){for(var e=0;e<20;e++){this._lastStateId[e]=null}for(var e=0;e<this._xpBufLen;e++){t=this._xpBuf[e];o=t.chunks;for(var c=0,h=o.length;c<h;c++){u=o[c];if(u&&u.draw){if(u.unique||this._lastStateId[c]!=u.id){this._transparentDrawList[this._transparentDrawListLen++]=u;this._lastStateId[c]=u.id}}}}}this.drawListDirty=false};SceneJS_Display.prototype.pick=function(e){var t=this._canvas.canvas;var n=null;var r=e.canvasX;var i=e.canvasY;var s=this.pickBuf;if(!s){s=this.pickBuf=new SceneJS_PickBuffer({canvas:this._canvas});this.pickBufDirty=true}this.render();s.bind();if(this.pickBufDirty){s.clear();this._doDrawList(true);this._canvas.gl.finish();this.pickBufDirty=false;this.rayPickBufDirty=true}var o=s.read(r,i);var u=o[0]+o[1]*256+o[2]*65536;var a=u>=1?u-1:-1;s.unbind();var f=this._frameCtx.pickNames[a];if(f){n={name:f};if(e.rayPick){var l=this.rayPickBuf;if(!l){l=this.rayPickBuf=new SceneJS_PickBuffer({canvas:this._canvas})}l.bind();if(this.rayPickBufDirty){l.clear();this._doDrawList(true,true);this.rayPickBufDirty=false}o=l.read(r,i);l.unbind();var c=this._unpackDepth(o);var h=t.width;var p=t.height;var d=(r-h/2)/(h/2);var v=-(i-p/2)/(p/2);var m=this._frameCtx.cameraMat;var g=this._frameCtx.viewMat;var y=SceneJS_math_mulMat4(m,g,[]);var b=SceneJS_math_inverseMat4(y,[]);var w=SceneJS_math_transformVector4(b,[d,v,-1,1]);w=SceneJS_math_mulVec4Scalar(w,1/w[3]);var E=SceneJS_math_transformVector4(b,[d,v,1,1]);E=SceneJS_math_mulVec4Scalar(E,1/E[3]);var S=SceneJS_math_subVec3(E,w,[]);var x=SceneJS_math_addVec3(w,SceneJS_math_mulVec4Scalar(S,c,[]),[]);n.canvasPos=[r,i];n.worldPos=x}}return n};SceneJS_Display.prototype._unpackDepth=function(e){var t=[e[0]/256,e[1]/256,e[2]/256,e[3]/256];var n=[1/(256*256*256),1/(256*256),1/256,1];return SceneJS_math_dotVector4(t,n)};SceneJS_Display.prototype._doDrawList=function(e,t){var n=this._frameCtx;n.program=null;n.framebuf=null;n.viewMat=null;n.modelMat=null;n.cameraMat=null;n.renderer=null;n.vertexBuf=false;n.normalBuf=false;n.uvBuf=false;n.uvBuf2=false;n.colorBuf=false;n.backfaces=false;n.frontface="ccw";n.pick=!!e;var r=this._canvas.gl;r.viewport(0,0,this._canvas.canvas.width,this._canvas.canvas.height);r.clearColor(this._ambientColor[0],this._ambientColor[1],this._ambientColor[2],1);r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT);r.lineWidth(3);r.frontFace(r.CCW);if(e){n.pickIndex=0;n.rayPick=!!t;for(var i=0,s=this._pickDrawListLen;i<s;i++){this._pickDrawList[i].pick(n)}}else{for(var i=0,s=this._opaqueDrawListLen;i<s;i++){this._opaqueDrawList[i].draw(n)}if(this._transparentDrawListLen>0){r.enable(r.BLEND);r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);for(var i=0,s=this._transparentDrawListLen;i<s;i++){this._transparentDrawList[i].draw(n)}r.disable(r.BLEND)}}r.flush();if(n.program){}if(n.framebuf){r.finish();n.framebuf.unbind()}if(n.renderer){}};SceneJS_Display.prototype.destroy=function(){this._programFactory.destroy()};var SceneJS_ProgramSourceFactory=new function(){this._sourceCache={};this.getSource=function(e,t){var n=this._sourceCache[e];if(n){n.useCount++;return n}return this._sourceCache[e]=new SceneJS_ProgramSource(e,this._composePickingVertexShader(t),this._composePickingFragmentShader(t),this._composeRenderingVertexShader(t),this._composeRenderingFragmentShader(t))};this.putSource=function(e){var t=this._sourceCache[e];if(t){if(--t.useCount==0){this._sourceCache[t.hash]=null}}};this._composePickingVertexShader=function(e){var t=e.shader.shaders||{};var n=t.vertex||{};var r=n.hooks||{};var i=t.fragment||{};var s=i.hooks||{};var o=e.clips.clips.length>0;var u=!!e.morphGeometry.targets;var a=this._hasNormals(e);var f=["precision mediump float;","attribute vec3 SCENEJS_aVertex;","attribute vec3 SCENEJS_aNormal;","uniform mat4 SCENEJS_uMMatrix;","uniform mat4 SCENEJS_uMNMatrix;","uniform mat4 SCENEJS_uVMatrix;","uniform mat4 SCENEJS_uVNMatrix;","uniform mat4 SCENEJS_uPMatrix;"];if(a&&(s.worldNormal||s.viewNormal)){f.push("varying   vec3 SCENEJS_vWorldNormal;");f.push("varying   vec3 SCENEJS_vViewNormal;")}f.push("varying vec4 SCENEJS_vModelVertex;");f.push("varying vec4 SCENEJS_vWorldVertex;");f.push("varying vec4 SCENEJS_vViewVertex;\n");f.push("varying vec4 SCENEJS_vProjVertex;\n");f.push("uniform vec3 SCENEJS_uWorldEye;");f.push("varying vec3 SCENEJS_vWorldEyeVec;");if(n.code){f.push("\n"+n.code+"\n")}if(u){f.push("uniform float SCENEJS_uMorphFactor;");if(e.morphGeometry.targets[0].vertexBuf){f.push("attribute vec3 SCENEJS_aMorphVertex;")}}f.push("void main(void) {");f.push("   vec4 tmpVertex=vec4(SCENEJS_aVertex, 1.0); ");if(a){f.push("  vec4 modelNormal = vec4(SCENEJS_aNormal, 0.0); ")}f.push("  SCENEJS_vModelVertex = tmpVertex; ");if(r.modelPos){f.push("tmpVertex="+r.modelPos+"(tmpVertex);")}if(u){if(e.morphGeometry.targets[0].vertexBuf){f.push("  vec4 vMorphVertex = vec4(SCENEJS_aMorphVertex, 1.0); ");if(r.modelPos){f.push("vMorphVertex="+r.modelPos+"(vMorphVertex);")}f.push("  tmpVertex = vec4(mix(tmpVertex.xyz, vMorphVertex.xyz, SCENEJS_uMorphFactor), 1.0); ")}}f.push("  tmpVertex = SCENEJS_uMMatrix * tmpVertex; ");if(r.worldPos){f.push("tmpVertex="+r.worldPos+"(tmpVertex);")}f.push("  SCENEJS_vWorldVertex = tmpVertex; ");f.push("SCENEJS_vWorldEyeVec = normalize(SCENEJS_uWorldEye - tmpVertex.xyz);");f.push("  tmpVertex = SCENEJS_uVMatrix * tmpVertex; ");if(r.viewPos){f.push("tmpVertex="+r.viewPos+"(tmpVertex);")}f.push("  SCENEJS_vViewVertex = tmpVertex;");if(a&&(s.worldNormal||s.viewNormal)){f.push("  vec3 worldNormal = normalize((SCENEJS_uMNMatrix * modelNormal).xyz); ");f.push("  SCENEJS_vWorldNormal = worldNormal;");f.push("  SCENEJS_vViewNormal = (SCENEJS_uVNMatrix * vec4(worldNormal, 1.0)).xyz;")}f.push("  SCENEJS_vProjVertex = SCENEJS_uPMatrix * tmpVertex;");f.push("  gl_Position = SCENEJS_vProjVertex;");f.push("}");if(false&&debugCfg.logScripts==true){SceneJS.log.info(f)}return f};this._composePickingFragmentShader=function(e){var t=e.shader.shaders||{};var n=t.fragment||{};var r=n.hooks||{};var i=e.clips.clips.length>0;var s=this._hasNormals(e);var o=["precision mediump float;"];o.push("vec4 packDepth(const in float depth) {");o.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);");o.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);");o.push("  vec4 res = fract(depth * bitShift);");o.push("  res -= res.xxyz * bitMask;");o.push("  return res;");o.push("}");o.push("varying vec4 SCENEJS_vModelVertex;");o.push("varying vec4 SCENEJS_vWorldVertex;");o.push("varying vec4 SCENEJS_vViewVertex;");o.push("varying vec4 SCENEJS_vProjVertex;");o.push("uniform bool SCENEJS_uRayPickMode;");o.push("uniform vec3 SCENEJS_uPickColor;");o.push("uniform float SCENEJS_uZNear;");o.push("uniform float SCENEJS_uZFar;");o.push("varying vec3 SCENEJS_vWorldEyeVec;");o.push("uniform bool  SCENEJS_uClipping;");if(s&&(r.worldNormal||r.viewNormal)){o.push("varying vec3 SCENEJS_vWorldNormal;");o.push("varying vec3 SCENEJS_vViewNormal;")}if(i){for(var u=0;u<e.clips.clips.length;u++){o.push("uniform float SCENEJS_uClipMode"+u+";");o.push("uniform vec4  SCENEJS_uClipNormalAndDist"+u+";")}}if(n.code){o.push("\n"+n.code+"\n")}o.push("void main(void) {");if(r.worldPosClip){o.push("if ("+r.worldPosClip+"(SCENEJS_vWorldVertex) == false) { discard; };")}if(r.viewPosClip){o.push("if (!"+r.viewPosClip+"(SCENEJS_vViewVertex) == false) { discard; };")}if(i){o.push("if (SCENEJS_uClipping) {");o.push("  float   dist;");for(var u=0;u<e.clips.clips.length;u++){o.push("    if (SCENEJS_uClipMode"+u+" != 0.0) {");o.push("        dist = dot(SCENEJS_vWorldVertex.xyz, SCENEJS_uClipNormalAndDist"+u+".xyz) - SCENEJS_uClipNormalAndDist"+u+".w;");o.push("        if (SCENEJS_uClipMode"+u+" == 1.0) {");o.push("            if (dist > 0.0) { discard; }");o.push("        }");o.push("        if (SCENEJS_uClipMode"+u+" == 2.0) {");o.push("            if (dist > 0.0) { discard; }");o.push("        }");o.push("    }")}o.push("}")}if(r.worldPos){o.push(r.worldPos+"(SCENEJS_vWorldVertex);")}if(r.viewPos){o.push(r.viewPos+"(SCENEJS_vViewVertex);")}if(r.worldEyeVec){o.push(r.worldEyeVec+"(SCENEJS_vWorldEyeVec);")}if(s&&r.worldNormal){o.push(r.worldNormal+"(SCENEJS_vWorldNormal);")}if(s&&r.viewNormal){o.push(r.viewNormal+"(SCENEJS_vViewNormal);")}o.push("    if (SCENEJS_uRayPickMode) {");o.push("          float zNormalizedDepth = abs((SCENEJS_uZNear + SCENEJS_vViewVertex.z) / (SCENEJS_uZFar - SCENEJS_uZNear));");o.push("          gl_FragColor = packDepth(zNormalizedDepth); ");o.push("    } else {");o.push("          gl_FragColor = vec4(SCENEJS_uPickColor.rgb, 1.0);  ");o.push("    }");o.push("}");if(false&&debugCfg.logScripts==true){SceneJS.log.info(o)}return o};this._isTexturing=function(e){if(e.texture.layers&&e.texture.layers.length>0){if(e.geometry.uvBuf||e.geometry.uvBuf2){return true}if(e.morphGeometry.targets&&(e.morphGeometry.targets[0].uvBuf||e.morphGeometry.targets[0].uvBuf2)){return true}}return false};this._hasNormals=function(e){if(e.geometry.normalBuf){return true}if(e.morphGeometry.targets&&e.morphGeometry.targets[0].normalBuf){return true}return false};this._composeRenderingVertexShader=function(e){var t=e.shader.shaders||{};if(t.vertex&&t.vertex.code&&!t.vertex.hooks){return t.vertex.code}var n=t.vertex||{};var r=n.hooks||{};var i=t.fragment||{};var s=i.hooks||{};var o=this._isTexturing(e);var u=this._hasNormals(e);var a=e.clips.clips.length>0;var f=!!e.morphGeometry.targets;var l=["precision mediump float;"];l.push("attribute vec3 SCENEJS_aVertex;");l.push("uniform vec3 SCENEJS_uWorldEye;");l.push("varying vec3 SCENEJS_vWorldEyeVec;");if(u){l.push("attribute vec3 SCENEJS_aNormal;");l.push("uniform   mat4 SCENEJS_uMNMatrix;");l.push("uniform   mat4 SCENEJS_uVNMatrix;");l.push("varying   vec3 SCENEJS_vWorldNormal;");l.push("varying   vec3 SCENEJS_vViewNormal;");for(var c=0;c<e.lights.lights.length;c++){var h=e.lights.lights[c];if(h.mode=="dir"){l.push("uniform vec3 SCENEJS_uLightDir"+c+";")}if(h.mode=="point"){l.push("uniform vec4 SCENEJS_uLightPos"+c+";")}if(h.mode=="spot"){l.push("uniform vec4 SCENEJS_uLightPos"+c+";")}l.push("varying vec4 SCENEJS_vViewLightVecAndDist"+c+";")}}if(o){if(e.geometry.uvBuf){l.push("attribute vec2 SCENEJS_aUVCoord;")}if(e.geometry.uvBuf2){l.push("attribute vec2 SCENEJS_aUVCoord2;")}}if(e.geometry.colorBuf){l.push("attribute vec4 SCENEJS_aVertexColor;");l.push("varying vec4 SCENEJS_vColor;")}l.push("uniform mat4 SCENEJS_uMMatrix;");l.push("uniform mat4 SCENEJS_uVMatrix;");l.push("uniform mat4 SCENEJS_uPMatrix;");if(a||s.worldPos){l.push("varying vec4 SCENEJS_vWorldVertex;")}if(s.viewPos){l.push("varying vec4 SCENEJS_vViewVertex;")}if(o){if(e.geometry.uvBuf){l.push("varying vec2 SCENEJS_vUVCoord;")}if(e.geometry.uvBuf2){l.push("varying vec2 SCENEJS_vUVCoord2;")}}if(f){l.push("uniform float SCENEJS_uMorphFactor;");if(e.morphGeometry.targets[0].vertexBuf){l.push("attribute vec3 SCENEJS_aMorphVertex;")}if(u){if(e.morphGeometry.targets[0].normalBuf){l.push("attribute vec3 SCENEJS_aMorphNormal;")}}}if(n.code){l.push("\n"+n.code+"\n")}l.push("void main(void) {");l.push("vec4 tmpVertex=vec4(SCENEJS_aVertex, 1.0); ");if(r.modelPos){l.push("tmpVertex="+r.modelPos+"(tmpVertex);")}l.push("  vec4 modelVertex = tmpVertex; ");if(u){l.push("  vec4 modelNormal = vec4(SCENEJS_aNormal, 0.0); ")}if(f){if(e.morphGeometry.targets[0].vertexBuf){l.push("  vec4 vMorphVertex = vec4(SCENEJS_aMorphVertex, 1.0); ");l.push("  modelVertex = vec4(mix(modelVertex.xyz, vMorphVertex.xyz, SCENEJS_uMorphFactor), 1.0); ")}if(u){if(e.morphGeometry.targets[0].normalBuf){l.push("  vec4 vMorphNormal = vec4(SCENEJS_aMorphNormal, 1.0); ");l.push("  modelNormal = vec4( mix(modelNormal.xyz, vMorphNormal.xyz, SCENEJS_uMorphFactor), 1.0); ")}}}l.push("  vec4 worldVertex = SCENEJS_uMMatrix * modelVertex; ");if(r.worldPos){l.push("worldVertex="+r.worldPos+"(worldVertex);")}if(r.viewMatrix){l.push("vec4 viewVertex = "+r.viewMatrix+"(SCENEJS_uVMatrix) * worldVertex;")}else{l.push("vec4 viewVertex  = SCENEJS_uVMatrix * worldVertex; ")}if(r.viewPos){l.push("viewVertex="+r.viewPos+"(viewVertex);")}if(u){l.push("  vec3 worldNormal = normalize((SCENEJS_uMNMatrix * modelNormal).xyz); ");l.push("  SCENEJS_vWorldNormal = worldNormal;");l.push("  SCENEJS_vViewNormal = (SCENEJS_uVNMatrix * vec4(worldNormal, 1.0)).xyz;")}if(a||s.worldPos){l.push("  SCENEJS_vWorldVertex = worldVertex;")}if(s.viewPos){l.push("  SCENEJS_vViewVertex = viewVertex;")}if(r.projMatrix){l.push("gl_Position = "+r.projMatrix+"(SCENEJS_uPMatrix) * viewVertex;")}else{l.push("  gl_Position = SCENEJS_uPMatrix * viewVertex;")}l.push("  vec3 tmpVec3;");if(u){for(var c=0;c<e.lights.lights.length;c++){h=e.lights.lights[c];if(h.mode=="dir"){if(h.space=="world"){l.push("SCENEJS_vViewLightVecAndDist"+c+" = vec4(-normalize((SCENEJS_uVMatrix * vec4(SCENEJS_uLightDir"+c+", 0.0)).xyz), 0.0);")}else{l.push("SCENEJS_vViewLightVecAndDist"+c+" = vec4(-normalize(SCENEJS_uLightDir"+c+"), 0.0);")}}if(h.mode=="point"){if(h.space=="world"){l.push("tmpVec3 = ((SCENEJS_uVMatrix * vec4(SCENEJS_uLightPos"+c+", 1.0)).xyz - worldVertex.xyz);");l.push("SCENEJS_vViewLightVecAndDist"+c+" = vec4(normalize(tmpVec3), length(tmpVec3));")}else{l.push("tmpVec3 = (SCENEJS_uLightPos"+c+".xyz - worldVertex.xyz);");l.push("SCENEJS_vViewLightVecAndDist"+c+" = vec4(normalize(tmpVec3), length(tmpVec3));")}}}}l.push("SCENEJS_vWorldEyeVec = normalize(SCENEJS_uWorldEye - worldVertex.xyz);");if(o){if(e.geometry.uvBuf){l.push("SCENEJS_vUVCoord = SCENEJS_aUVCoord;")}if(e.geometry.uvBuf2){l.push("SCENEJS_vUVCoord2 = SCENEJS_aUVCoord2;")}}if(e.geometry.colorBuf){l.push("SCENEJS_vColor = SCENEJS_aVertexColor;")}l.push("}");if(false&&debugCfg.logScripts===true){SceneJS.log.info(l)}return l};this._composeRenderingFragmentShader=function(e){var t=e.shader.shaders||{};if(t.fragment&&t.fragment.code&&!t.fragment.hooks){return t.fragment.code}var n=t.fragment||{};var r=n.hooks||{};var i=this._isTexturing(e);var s=this._hasNormals(e);var o=e.clips.clips.length>0;var u=["\n"];u.push("precision mediump float;");if(o||r.worldPos){u.push("varying vec4 SCENEJS_vWorldVertex;")}if(r.viewPos){u.push("varying vec4 SCENEJS_vViewVertex;")}if(o){for(var a=0;a<e.clips.clips.length;a++){u.push("uniform float SCENEJS_uClipMode"+a+";");u.push("uniform vec4  SCENEJS_uClipNormalAndDist"+a+";")}}if(i){if(e.geometry.uvBuf){u.push("varying vec2 SCENEJS_vUVCoord;")}if(e.geometry.uvBuf2){u.push("varying vec2 SCENEJS_vUVCoord2;")}var f;for(var a=0,l=e.texture.layers.length;a<l;a++){f=e.texture.layers[a];u.push("uniform sampler2D SCENEJS_uSampler"+a+";");if(f.matrix){u.push("uniform mat4 SCENEJS_uLayer"+a+"Matrix;")}u.push("uniform float SCENEJS_uLayer"+a+"BlendFactor;")}}u.push("uniform bool  SCENEJS_uBackfaceTexturing;");u.push("uniform bool  SCENEJS_uBackfaceLighting;");u.push("uniform bool  SCENEJS_uSpecularLighting;");u.push("uniform bool  SCENEJS_uClipping;");u.push("uniform bool  SCENEJS_uAmbient;");u.push("uniform bool  SCENEJS_uTransparent;");if(e.geometry.colorBuf){u.push("varying vec4 SCENEJS_vColor;")}u.push("uniform vec3  SCENEJS_uAmbientColor;");u.push("uniform vec3  SCENEJS_uMaterialBaseColor;");u.push("uniform float SCENEJS_uMaterialAlpha;");u.push("uniform float SCENEJS_uMaterialEmit;");u.push("uniform vec3  SCENEJS_uMaterialSpecularColor;");u.push("uniform float SCENEJS_uMaterialSpecular;");u.push("uniform float SCENEJS_uMaterialShine;");u.push("  vec3    ambient= SCENEJS_uAmbient ? SCENEJS_uAmbientColor : vec3(0.0, 0.0, 0.0);");u.push("  float   emit    = SCENEJS_uMaterialEmit;");u.push("varying vec3 SCENEJS_vWorldEyeVec;");if(s){u.push("varying vec3 SCENEJS_vWorldNormal;");u.push("varying vec3 SCENEJS_vViewNormal;");var c;for(var a=0;a<e.lights.lights.length;a++){c=e.lights.lights[a];u.push("uniform vec3  SCENEJS_uLightColor"+a+";");if(c.mode=="point"){u.push("uniform vec3  SCENEJS_uLightAttenuation"+a+";")}u.push("varying vec4  SCENEJS_vViewLightVecAndDist"+a+";")}}if(n.code){u.push("\n"+n.code+"\n")}u.push("void main(void) {");if(o){u.push("if (SCENEJS_uClipping) {");u.push("  float   dist;");for(var a=0;a<e.clips.clips.length;a++){u.push("    if (SCENEJS_uClipMode"+a+" != 0.0) {");u.push("        dist = dot(SCENEJS_vWorldVertex.xyz, SCENEJS_uClipNormalAndDist"+a+".xyz) - SCENEJS_uClipNormalAndDist"+a+".w;");u.push("        if (SCENEJS_uClipMode"+a+" == 1.0) {");u.push("            if (dist > 0.0) { discard; }");u.push("        }");u.push("        if (SCENEJS_uClipMode"+a+" == 2.0) {");u.push("            if (dist > 0.0) { discard; }");u.push("        }");u.push("    }")}u.push("}")}if(r.worldPos){u.push(r.worldPos+"(SCENEJS_vWorldVertex);")}if(r.viewPos){u.push(r.viewPos+"(SCENEJS_vViewVertex);")}if(r.worldEyeVec){u.push(r.worldEyeVec+"(SCENEJS_vWorldEyeVec);")}if(s&&r.worldNormal){u.push(r.worldNormal+"(SCENEJS_vWorldNormal);")}if(s&&r.viewNormal){u.push(r.viewNormal+"(SCENEJS_vViewNormal);")}if(e.geometry.colorBuf){u.push("  vec3    color   = SCENEJS_vColor.rgb;")}else{u.push("  vec3    color   = SCENEJS_uMaterialBaseColor;")}u.push("  float alpha         = SCENEJS_uMaterialAlpha;");u.push("  float emit          = SCENEJS_uMaterialEmit;");u.push("  float specular      = SCENEJS_uMaterialSpecular;");u.push("  vec3  specularColor = SCENEJS_uMaterialSpecularColor;");u.push("  float shine         = SCENEJS_uMaterialShine;");if(r.materialBaseColor){u.push("color="+r.materialBaseColor+"(color);")}if(r.materialAlpha){u.push("alpha="+r.materialAlpha+"(alpha);")}if(r.materialEmit){u.push("emit="+r.materialEmit+"(emit);")}if(r.materialSpecular){u.push("specular="+r.materialSpecular+"(specular);")}if(r.materialSpecularColor){u.push("specularColor="+r.materialSpecularColor+"(specularColor);")}if(r.materialShine){u.push("shine="+r.materialShine+"(shine);")}if(s){u.push("  float   attenuation = 1.0;");u.push("  vec3    viewNormalVec = SCENEJS_vViewNormal;")}var f;if(i){if(s){u.push("if (SCENEJS_uBackfaceTexturing || dot(SCENEJS_vWorldNormal, SCENEJS_vWorldEyeVec) > 0.0) {")}u.push("  vec4    texturePos;");u.push("  vec2    textureCoord=vec2(0.0,0.0);");for(var a=0,l=e.texture.layers.length;a<l;a++){f=e.texture.layers[a];if(f.applyFrom=="normal"&&s){if(e.geometry.normalBuf){u.push("texturePos=vec4(viewNormalVec.xyz, 1.0);")}else{SceneJS.log.warn("Texture layer applyFrom='normal' but geo has no normal vectors");continue}}if(f.applyFrom=="uv"){if(e.geometry.uvBuf){u.push("texturePos = vec4(SCENEJS_vUVCoord.s, SCENEJS_vUVCoord.t, 1.0, 1.0);")}else{SceneJS.log.warn("Texture layer applyTo='uv' but geometry has no UV coordinates");continue}}if(f.applyFrom=="uv2"){if(e.geometry.uvBuf2){u.push("texturePos = vec4(SCENEJS_vUVCoord2.s, SCENEJS_vUVCoord2.t, 1.0, 1.0);")}else{SceneJS.log.warn("Texture layer applyTo='uv2' but geometry has no UV2 coordinates");continue}}if(f.matrix){u.push("textureCoord=(SCENEJS_uLayer"+a+"Matrix * texturePos).xy;")}else{u.push("textureCoord=texturePos.xy;")}if(f.applyTo=="alpha"){if(f.blendMode=="multiply"){u.push("alpha = alpha * (SCENEJS_uLayer"+a+"BlendFactor * texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);")}else if(f.blendMode=="add"){u.push("alpha = ((1.0 - SCENEJS_uLayer"+a+"BlendFactor) * alpha) + (SCENEJS_uLayer"+a+"BlendFactor * texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);")}}if(f.applyTo=="baseColor"){if(f.blendMode=="multiply"){u.push("color = color * (SCENEJS_uLayer"+a+"BlendFactor * texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);")}else{u.push("color = ((1.0 - SCENEJS_uLayer"+a+"BlendFactor) * color) + (SCENEJS_uLayer"+a+"BlendFactor * texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);")}}if(f.applyTo=="emit"){if(f.blendMode=="multiply"){u.push("emit  = emit * (SCENEJS_uLayer"+a+"BlendFactor * texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);")}else{u.push("emit = ((1.0 - SCENEJS_uLayer"+a+"BlendFactor) * emit) + (SCENEJS_uLayer"+a+"BlendFactor * texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);")}}if(f.applyTo=="specular"&&s){if(f.blendMode=="multiply"){u.push("specular  = specular * (SCENEJS_uLayer"+a+"BlendFactor * texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);")}else{u.push("specular = ((1.0 - SCENEJS_uLayer"+a+"BlendFactor) * specular) + (SCENEJS_uLayer"+a+"BlendFactor * texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);")}}if(f.applyTo=="normals"&&s){u.push("vec3 bump = normalize(texture2D(SCENEJS_uSampler"+a+", vec2(textureCoord.x, -textureCoord.y)).xyz * 2.0 - 1.0);");u.push("viewNormalVec *= -bump;")}}if(s){u.push("}")}}u.push("  vec4    fragColor;");if(s){u.push("if (SCENEJS_uBackfaceLighting || dot(SCENEJS_vWorldNormal, SCENEJS_vWorldEyeVec) > 0.0) {");u.push("  vec3    lightValue      = vec3(0.0, 0.0, 0.0);");u.push("  vec3    specularValue   = vec3(0.0, 0.0, 0.0);");u.push("  vec3    viewLightVec;");u.push("  float   dotN;");u.push("  float   lightDist;");var c;for(var a=0,l=e.lights.lights.length;a<l;a++){c=e.lights.lights[a];u.push("viewLightVec = SCENEJS_vViewLightVecAndDist"+a+".xyz;");if(c.mode=="point"){u.push("dotN = max(dot(viewNormalVec, viewLightVec) ,0.0);");u.push("lightDist = SCENEJS_vViewLightVecAndDist"+a+".w;");u.push("  attenuation = 1.0 / ("+"  SCENEJS_uLightAttenuation"+a+"[0] + "+"  SCENEJS_uLightAttenuation"+a+"[1] * lightDist + "+"  SCENEJS_uLightAttenuation"+a+"[2] * lightDist * lightDist);");if(c.diffuse){u.push("  lightValue += dotN *  SCENEJS_uLightColor"+a+" * attenuation;")}if(c.specular){u.push("if (SCENEJS_uSpecularLighting) specularValue += attenuation * specularColor * SCENEJS_uLightColor"+a+" * specular * pow(max(dot(reflect(viewLightVec, viewNormalVec), vec3(0.0,0.0,1.0)), 0.0), shine);")}}if(c.mode=="dir"){u.push("dotN = max(dot(viewNormalVec,viewLightVec),0.0);");if(c.diffuse){u.push("lightValue += dotN * SCENEJS_uLightColor"+a+";")}if(c.specular){u.push("if (SCENEJS_uSpecularLighting) specularValue += specularColor * SCENEJS_uLightColor"+a+" * specular * pow(max(dot(reflect(viewLightVec, viewNormalVec), vec3(0.0,0.0,1.0)), 0.0), shine);")}}}u.push("      fragColor = vec4((specularValue.rgb + color.rgb * (lightValue.rgb + ambient.rgb)) + (emit * color.rgb), alpha);");u.push("   } else {");u.push("      fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);");u.push("   }")}else{u.push("fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);")}if(r.pixelColor){u.push("fragColor="+r.pixelColor+"(fragColor);")}if(false&&debugCfg.whitewash===true){u.push("    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);")}else{u.push("    gl_FragColor = fragColor;")}u.push("}");return u}};var SceneJS_ProgramSource=function(e,t,n,r,i){this.hash=e;this.pickVertexSrc=t;this.pickFragmentSrc=n;this.drawVertexSrc=r;this.drawFragmentSrc=i;this.useCount=0};var SceneJS_ProgramFactory=function(e){this._canvas=e.canvas;this._programs={};this._nextProgramId=0};SceneJS_ProgramFactory.prototype.getProgram=function(e,t){var n=this._programs[e];if(!n){var r=SceneJS_ProgramSourceFactory.getSource(e,t);n=new SceneJS_Program(this._nextProgramId++,e,r,this._canvas.gl);this._programs[e]=n}n.useCount++;return n};SceneJS_ProgramFactory.prototype.putProgram=function(e){if(--e.useCount<=0){e.draw.destroy();e.pick.destroy();SceneJS_ProgramSourceFactory.putSource(e.hash);this._programs[e.hash]=null}};SceneJS_ProgramFactory.prototype.webglRestored=function(){var e=this._canvas.gl;for(var t in this._programs){if(this._programs.hasOwnProperty(t)){this._programs[t].build(e)}}};SceneJS_ProgramFactory.prototype.destroy=function(){};var SceneJS_Program=function(e,t,n,r){this.id=e;this.hash=n.hash;this.source=n;this.gl=r;this.draw=null;this.pick=null;this.useCount=0;this.build(r)};SceneJS_Program.prototype.build=function(e){this.gl=e;this.draw=new SceneJS_webgl_Program(e,[this.source.drawVertexSrc.join("\n")],[this.source.drawFragmentSrc.join("\n")]);this.pick=new SceneJS_webgl_Program(e,[this.source.pickVertexSrc.join("\n")],[this.source.pickFragmentSrc.join("\n")])};var SceneJS_ObjectFactory=function(){};SceneJS_ObjectFactory.prototype._freeObjects=[];SceneJS_ObjectFactory.prototype._numFreeObjects=0;SceneJS_ObjectFactory.prototype.getObject=function(e){var t;if(this._numFreeObjects>0){t=this._freeObjects[--this._numFreeObjects];t.id=e;return t}return new SceneJS_Object(e)};SceneJS_ObjectFactory.prototype.putObject=function(e){this._freeObjects[this._numFreeObjects++]=e};var SceneJS_Object=function(e){this.id=e;this.hash=null;this.sortKey=null;this.chunks=[];this.chunksLen=0;this.program=null;this.layer=null;this.texture=null;this.flags=null;this.tag=null};SceneJS.RenderContext=function(e){this._frameCtx=e};SceneJS.RenderContext.prototype.getCameraMatrix=function(){return this._frameCtx.cameraMat};SceneJS.RenderContext.prototype.getViewMatrix=function(){return this._frameCtx.viewMat};SceneJS.RenderContext.prototype.getModelMatrix=function(){return this._frameCtx.modelMat};SceneJS.RenderContext.prototype.getCanvasPos=function(e){this.getProjPos(e);var t=this._frameCtx.canvas.canvas;var n=t.width;var r=t.height;var i=this._pc;var s=i[0]/i[3]*n*.5;var o=i[1]/i[3]*r*.5;return{x:s+n*.5,y:r-o-r*.5}};SceneJS.RenderContext.prototype.getCameraPos=function(e){this.getProjPos(e);this._camPos=SceneJS_math_normalizeVec3(this._pc,[0,0,0]);return{x:this._camPos[0],y:this._camPos[1],z:this._camPos[2]}};SceneJS.RenderContext.prototype.getProjPos=function(e){this.getViewPos(e);this._pc=SceneJS_math_transformPoint3(this._frameCtx.cameraMat,this._vc);return{x:this._pc[0],y:this._pc[1],z:this._pc[2],w:this._pc[3]}};SceneJS.RenderContext.prototype.getViewPos=function(e){this.getWorldPos(e);this._vc=SceneJS_math_transformPoint3(this._frameCtx.viewMat,this._wc);return{x:this._vc[0],y:this._vc[1],z:this._vc[2],w:this._vc[3]}};SceneJS.RenderContext.prototype.getWorldPos=function(e){this._wc=SceneJS_math_transformPoint3(this._frameCtx.modelMat,e||[0,0,0]);return{x:this._wc[0],y:this._wc[1],z:this._wc[2],w:this._wc[3]}};var SceneJS_Chunk=function(e,t,n,r){this.type=t;this.id=e;this.program=n;this.core=r;this.useCount=0;if(this.build){this.build()}};SceneJS_Chunk.prototype.init=function(e,t,n){this.id=e;this.program=t;this.core=n;if(this.build){this.build()}};var SceneJS_ChunkFactory=function(){this._chunks={}};SceneJS_ChunkFactory._chunkTypes={};SceneJS_ChunkFactory._freeChunks={};SceneJS_ChunkFactory.createChunkType=function(e){if(!e.type){throw"'type' expected in params"}var t=SceneJS_Chunk;var n=function(){t.apply(this,arguments);this.type=e.type};n.prototype=new t;n.prototype.constructor=n;if(e.drawAndPick){e.draw=e.pick=e.drawAndPick}SceneJS_ChunkFactory._chunkTypes[e.type]=n;SceneJS._apply(e,n.prototype);SceneJS_ChunkFactory._freeChunks[e.type]={chunks:[],chunksLen:0};return n};SceneJS_ChunkFactory.prototype.getChunk=function(e,t,n,r){var i=SceneJS_ChunkFactory._chunkTypes[t];if(!i){throw"chunk type not supported: '"+t+"'"}var s=this._chunks[e];if(s){s.useCount++;return s}var o=SceneJS_ChunkFactory._freeChunks[t];if(o.chunksLen>0){s=o.chunks[--o.chunksLen]}if(s){s.init(e,n,r)}else{s=new i(e,t,n,r)}s.useCount=1;this._chunks[e]=s;return s};SceneJS_ChunkFactory.prototype.putChunk=function(e){if(e.useCount==0){return}if(--e.useCount<=0){this._chunks[e.id]=null;var t=SceneJS_ChunkFactory._freeChunks[e.type];t.chunks[t.chunksLen++]=e}};SceneJS_ChunkFactory.prototype.webglRestored=function(){var e;for(var t in this._chunks){if(this._chunks.hasOwnProperty(t)){e=this._chunks[t];if(e.build){e.build()}}}};SceneJS_ChunkFactory.createChunkType({type:"camera",build:function(){this._uPMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uPMatrix");this._uPMatrixPick=this.program.pick.getUniformLocation("SCENEJS_uPMatrix");this._uZNearPick=this.program.pick.getUniformLocation("SCENEJS_uZNear");this._uZFarPick=this.program.pick.getUniformLocation("SCENEJS_uZFar")},draw:function(e){var t=this.program.gl;if(this._uPMatrixDraw){t.uniformMatrix4fv(this._uPMatrixDraw,t.FALSE,this.core.mat)}e.cameraMat=this.core.mat},pick:function(e){var t=this.program.gl;if(this._uPMatrixPick){t.uniformMatrix4fv(this._uPMatrixPick,t.FALSE,this.core.mat)}if(e.rayPick){if(this._uZNearPick){t.uniform1f(this._uZNearPick,this.core.optics.near)}if(this._uZFarPick){t.uniform1f(this._uZFarPick,this.core.optics.far)}}e.cameraMat=this.core.mat}});SceneJS_ChunkFactory.createChunkType({type:"clips",build:function(){this._draw=this._draw||[];var e=this.program.draw;for(var t=0,n=this.core.clips.length;t<n;t++){this._draw[t]={uClipMode:e.getUniformLocation("SCENEJS_uClipMode"+t),uClipNormalAndDist:e.getUniformLocation("SCENEJS_uClipNormalAndDist"+t)}}this._pick=this._pick||[];var r=this.program.pick;for(var t=0,n=this.core.clips.length;t<n;t++){this._pick[t]={uClipMode:r.getUniformLocation("SCENEJS_uClipMode"+t),uClipNormalAndDist:r.getUniformLocation("SCENEJS_uClipNormalAndDist"+t)}}},drawAndPick:function(e){var t=e.pick?this._pick:this._draw;var n;var r;var i=this.core.clips;var s;var o=this.program.gl;for(var u=0,a=i.length;u<a;u++){if(e.pick){n=t[u].uClipMode;r=t[u].uClipNormalAndDist}else{n=t[u].uClipMode;r=t[u].uClipNormalAndDist}if(n&&r){s=i[u];if(s.mode=="inside"){o.uniform1f(n,2);o.uniform4fv(r,s.normalAndDist)}else if(s.mode=="outside"){o.uniform1f(n,1);o.uniform4fv(r,s.normalAndDist)}else{o.uniform1f(n,0)}}}}});SceneJS_ChunkFactory.createChunkType({type:"draw",unique:true,build:function(){},drawAndPick:function(e){var t=this.program.gl;t.drawElements(this.core.primitive,this.core.indexBuf.numItems,t.UNSIGNED_SHORT,0)}});SceneJS_ChunkFactory.createChunkType({type:"flags",build:function(){var e=this.program.draw;this._uBackfaceTexturingDraw=e.getUniformLocation("SCENEJS_uBackfaceTexturing");this._uBackfaceLightingDraw=e.getUniformLocation("SCENEJS_uBackfaceLighting");this._uSpecularLightingDraw=e.getUniformLocation("SCENEJS_uSpecularLighting");this._uClippingDraw=e.getUniformLocation("SCENEJS_uClipping");this._uAmbientDraw=e.getUniformLocation("SCENEJS_uAmbient");var t=this.program.pick;this._uClippingPick=t.getUniformLocation("SCENEJS_uClipping")},drawAndPick:function(e){var t=this.program.gl;var n=this.core.backfaces;if(e.backfaces!=n){if(n){t.disable(t.CULL_FACE)}else{t.enable(t.CULL_FACE)}e.backfaces=n}var r=this.core.frontface;if(e.pick){t.uniform1i(this._uClippingPick,this.core.clipping)}else{t.uniform1i(this._uBackfaceTexturingDraw,this.core.backfaceTexturing);t.uniform1i(this._uBackfaceLightingDraw,this.core.backfaceLighting);t.uniform1i(this._uSpecularLightingDraw,this.core.specular);t.uniform1i(this._uClippingDraw,this.core.clipping);t.uniform1i(this._uAmbientDraw,this.core.ambient)}}});SceneJS_ChunkFactory.createChunkType({type:"framebuf",build:function(){},drawAndPick:function(e){if(e.framebuf){this.program.gl.finish();e.framebuf.unbind()}var t=this.core.framebuf;if(t){t.bind();e.framebuf=t}}});SceneJS_ChunkFactory.createChunkType({type:"geometry",unique:true,build:function(){var e=this.program.draw;this._aVertexDraw=e.getAttribute("SCENEJS_aVertex");this._aNormalDraw=e.getAttribute("SCENEJS_aNormal");this._aUVDraw=e.getAttribute("SCENEJS_aUVCoord");this._aUV2Draw=e.getAttribute("SCENEJS_aUVCoord2");this._aColorDraw=e.getAttribute("SCENEJS_aVertexColor");var t=this.program.pick;this._aVertexPick=t.getAttribute("SCENEJS_aVertex");this._aNormalPick=t.getAttribute("SCENEJS_aNormal");this._aUVPick=t.getAttribute("SCENEJS_aUVCoord");this._aUV2Pick=t.getAttribute("SCENEJS_aUVCoord2");this._aColorPick=t.getAttribute("SCENEJS_aVertexColor")},draw:function(e){var t=this.program.gl;if(e.geoChunkId!=this.id){if(this._aVertexDraw&&!e.vertexBuf){this._aVertexDraw.bindFloatArrayBuffer(this.core.vertexBuf)}if(this._aNormalDraw&&!e.normalBuf){this._aNormalDraw.bindFloatArrayBuffer(this.core.normalBuf)}if(this._aUVDraw&&!e.uvBuf){this._aUVDraw.bindFloatArrayBuffer(this.core.uvBuf)}if(this._aUV2Draw&&!e.uvBuf2){this._aUV2Draw.bindFloatArrayBuffer(this.core.uvBuf2)}if(this._aColorDraw&&!e.colorBuf){this._aColorDraw.bindFloatArrayBuffer(this.core.colorBuf)}this.core.indexBuf.bind();e.geoChunkId=this.id}t.drawElements(this.core.primitive,this.core.indexBuf.numItems,t.UNSIGNED_SHORT,0)},pick:function(e){var t=this.program.gl;if(e.geoChunkId!=this.id){if(this._aVertexPick&&!e.vertexBuf){this._aVertexPick.bindFloatArrayBuffer(this.core.vertexBuf)}if(this._aNormalPick&&!e.normalBuf){this._aNormalPick.bindFloatArrayBuffer(this.core.normalBuf)}if(this._aUVPick&&!e.uvBuf){this._aUVPick.bindFloatArrayBuffer(this.core.uvBuf)}if(this._aUV2Pick&&!e.uvBuf2){this._aUV2Pick.bindFloatArrayBuffer(this.core.uvBuf2)}this.core.indexBuf.bind();e.geoChunkId=this.id}t.drawElements(this.core.primitive,this.core.indexBuf.numItems,t.UNSIGNED_SHORT,0)}});SceneJS_ChunkFactory.createChunkType({type:"lights",build:function(){this._uAmbientColor=this._uAmbientColor||[];this._uLightColor=this._uLightColor||[];this._uLightDir=this._uLightDir||[];this._uLightPos=this._uLightPos||[];this._uLightCutOff=this._uLightCutOff||[];this._uLightSpotExp=this._uLightSpotExp||[];this._uLightAttenuation=this._uLightAttenuation||[];var e=this.core.lights;var t=this.program;for(var n=0,r=e.length;n<r;n++){switch(e[n].mode){case"ambient":this._uAmbientColor[n]=t.draw.getUniformLocation("SCENEJS_uAmbientColor");break;case"dir":this._uLightColor[n]=t.draw.getUniformLocation("SCENEJS_uLightColor"+n);this._uLightPos[n]=null;this._uLightDir[n]=t.draw.getUniformLocation("SCENEJS_uLightDir"+n);break;case"point":this._uLightColor[n]=t.draw.getUniformLocation("SCENEJS_uLightColor"+n);this._uLightPos[n]=t.draw.getUniformLocation("SCENEJS_uLightPos"+n);this._uLightDir[n]=null;break}}},draw:function(e){if(e.dirty){this.build()}var t=this.core.lights;var n;var r=this.program.gl;for(var i=0,s=t.length;i<s;i++){n=t[i];if(this._uAmbientColor[i]){r.uniform3fv(this._uAmbientColor[i],n.color)}else{if(this._uLightColor[i]){r.uniform3fv(this._uLightColor[i],n.color)}if(this._uLightPos[i]){r.uniform3fv(this._uLightPos[i],n.pos)}if(this._uLightDir[i]){r.uniform3fv(this._uLightDir[i],n.dir)}}}}});SceneJS_ChunkFactory.createChunkType({type:"listeners",build:function(){},draw:function(e){var t=this.core.listeners;var n=e.renderListenerCtx;for(var r=t.length-1;r>=0;r--){if(t[r](n)===true){return true}}}});SceneJS_ChunkFactory.createChunkType({type:"lookAt",build:function(){this._uvMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uVMatrix");this._uVNMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uVNMatrix");this._uWorldEyeDraw=this.program.draw.getUniformLocation("SCENEJS_uWorldEye");this._uvMatrixPick=this.program.pick.getUniformLocation("SCENEJS_uVMatrix")},draw:function(e){if(this.core.dirty){this.core.rebuild()}var t=this.program.gl;if(this._uvMatrixDraw){t.uniformMatrix4fv(this._uvMatrixDraw,t.FALSE,this.core.mat)}if(this._uVNMatrixDraw){t.uniformMatrix4fv(this._uVNMatrixDraw,t.FALSE,this.core.normalMat)}if(this._uWorldEyeDraw){t.uniform3fv(this._uWorldEyeDraw,this.core.lookAt.eye)}e.viewMat=this.core.mat},pick:function(e){var t=this.program.gl;if(this._uvMatrixPick){t.uniformMatrix4fv(this._uvMatrixPick,t.FALSE,this.core.mat)}e.viewMat=this.core.mat}});SceneJS_ChunkFactory.createChunkType({type:"material",build:function(){var e=this.program.draw;this._uMaterialBaseColor=e.getUniformLocation("SCENEJS_uMaterialBaseColor");this._uMaterialSpecularColor=e.getUniformLocation("SCENEJS_uMaterialSpecularColor");this._uMaterialSpecular=e.getUniformLocation("SCENEJS_uMaterialSpecular");this._uMaterialShine=e.getUniformLocation("SCENEJS_uMaterialShine");this._uMaterialEmit=e.getUniformLocation("SCENEJS_uMaterialEmit");this._uMaterialAlpha=e.getUniformLocation("SCENEJS_uMaterialAlpha")},draw:function(){var e=this.program.gl;if(this._uMaterialBaseColor){e.uniform3fv(this._uMaterialBaseColor,this.core.baseColor)}if(this._uMaterialSpecularColor){e.uniform3fv(this._uMaterialSpecularColor,this.core.specularColor)}if(this._uMaterialSpecular){e.uniform1f(this._uMaterialSpecular,this.core.specular)}if(this._uMaterialShine){e.uniform1f(this._uMaterialShine,this.core.shine)}if(this._uMaterialEmit){e.uniform1f(this._uMaterialEmit,this.core.emit)}if(this._uMaterialAlpha){e.uniform1f(this._uMaterialAlpha,this.core.alpha)}}});SceneJS_ChunkFactory.createChunkType({type:"morphGeometry",build:function(){var e=this.program.draw;this._aVertexDraw=e.getAttribute("SCENEJS_aVertex");this._aNormalDraw=e.getAttribute("SCENEJS_aNormal");this._aUVDraw=e.getAttribute("SCENEJS_aUVCoord");this._aUV2Draw=e.getAttribute("SCENEJS_aUVCoord2");this._aColorDraw=e.getAttribute("SCENEJS_aVertexColor");this._aMorphVertexDraw=e.getAttribute("SCENEJS_aMorphVertex");this._aMorphNormalDraw=e.getAttribute("SCENEJS_aMorphNormal");this._aMorphUVDraw=e.getAttribute("SCENEJS_aMorphUVCoord");this._aMorphUV2Draw=e.getAttribute("SCENEJS_aMorphUVCoord2");this._aMorphColorDraw=e.getAttribute("SCENEJS_aMorphColor");this._uMorphFactorDraw=e.getUniformLocation("SCENEJS_uMorphFactor");var t=this.program.pick;this._aVertexPick=t.getAttribute("SCENEJS_aVertex");this._aNormalPick=t.getAttribute("SCENEJS_aNormal");this._aUVPick=t.getAttribute("SCENEJS_aUVCoord");this._aUV2Pick=t.getAttribute("SCENEJS_aUVCoord2");this._aColorPick=t.getAttribute("SCENEJS_aVertexColor");this._aMorphVertexPick=t.getAttribute("SCENEJS_aMorphVertex");this._aMorphNormalPick=t.getAttribute("SCENEJS_aMorphNormal");this._aMorphUVPick=t.getAttribute("SCENEJS_aMorphUVCoord");this._aMorphUV2Pick=t.getAttribute("SCENEJS_aMorphUVCoord2");this._aMorphColorPick=t.getAttribute("SCENEJS_aMorphColor");this._uMorphFactorPick=t.getUniformLocation("SCENEJS_uMorphFactor")},draw:function(e){var t=this.core.targets;if(!t||t.length==0){e.vertexBuf=false;e.normalBuf=false;e.uvBuf=false;e.uvBuf2=false;e.colorBuf=false;return}var n=this.program.gl;var r=this.core.targets[this.core.key1];var i=this.core.targets[this.core.key2];if(this._aMorphVertexDraw){this._aVertexDraw.bindFloatArrayBuffer(r.vertexBuf);this._aMorphVertexDraw.bindFloatArrayBuffer(i.vertexBuf);e.vertexBuf=true}else{e.vertexBuf=false}if(this._aMorphNormalDraw){this._aNormalDraw.bindFloatArrayBuffer(r.normalBuf);this._aMorphNormalDraw.bindFloatArrayBuffer(i.normalBuf);e.normalBuf=true}else{e.normalBuf=false}if(this._aMorphUVDraw){this._aUVDraw.bindFloatArrayBuffer(r.uvBuf);this._aMorphUVDraw.bindFloatArrayBuffer(i.uvBuf);e.uvBuf=true}else{e.uvBuf=false}if(this._aMorphUV2Draw){this._aUV2Draw.bindFloatArrayBuffer(r.uvBuf2);this._aMorphUV2Draw.bindFloatArrayBuffer(i.uvBuf2);e.uvBuf2=true}else{e.uvBuf2=false}if(this._aMorphColorDraw){this._aColorDraw.bindFloatArrayBuffer(r.colorBuf);this._aMorphColorDraw.bindFloatArrayBuffer(i.colorBuf);e.colorBuf=true}else{e.colorBuf=false}if(this._uMorphFactorDraw){n.uniform1f(this._uMorphFactorDraw,this.core.factor)}},pick:function(e){var t=this.core.targets;if(!t||t.length==0){e.vertexBuf=false;e.normalBuf=false;e.uvBuf=false;e.uvBuf2=false;e.colorBuf=false;return}var n=this.program.gl;var r=t[this.core.key1];var i=t[this.core.key2];if(this._aMorphVertexPick){this._aVertexPick.bindFloatArrayBuffer(r.vertexBuf);this._aMorphVertexPick.bindFloatArrayBuffer(i.vertexBuf);e.vertexBuf=true}else{e.vertexBuf=false}if(this._aMorphNormalPick){this._aNormalPick.bindFloatArrayBuffer(r.normalBuf);this._aMorphNormalPick.bindFloatArrayBuffer(i.normalBuf);e.normalBuf=true}else{e.normalBuf=false}if(this._aMorphUVPick){this._aUVPick.bindFloatArrayBuffer(r.uvBuf);this._aMorphUVPick.bindFloatArrayBuffer(i.uvBuf);e.uvBuf=true}else{e.uvBuf=false}if(this._aMorphUV2Pick){this._aUV2Pick.bindFloatArrayBuffer(r.uvBuf2);this._aMorphUV2Pick.bindFloatArrayBuffer(i.uvBuf2);e.uvBuf2=true}else{e.uvBuf2=false}if(this._aMorphColorPick){this._aColorPick.bindFloatArrayBuffer(r.colorBuf);this._aMorphColorPick.bindFloatArrayBuffer(i.colorBuf);e.colorBuf=true}else{e.colorBuf=false}if(this._uMorphFactorPick){n.uniform1f(this._uMorphFactorPick,this.core.factor)}}});SceneJS_ChunkFactory.createChunkType({type:"name",build:function(){this._uPickColor=this.program.pick.getUniformLocation("SCENEJS_uPickColor")},pick:function(e){if(this._uPickColor&&this.core.name){e.pickNames[e.pickIndex++]=this.core.name;var t=e.pickIndex>>16&255;var n=e.pickIndex>>8&255;var r=e.pickIndex&255;this.program.gl.uniform3fv(this._uPickColor,[r/255,n/255,t/255])}}});SceneJS_ChunkFactory.createChunkType({type:"program",build:function(){this._rayPickMode=this.program.pick.getUniformLocation("SCENEJS_uRayPickMode")},draw:function(e){var t=this.program.draw;if(e.program){e.program.unbind()}t.bind();e.program=t;e.vertexBuf=false;e.normalBuf=false;e.uvBuf=false;e.uvBuf2=false;e.colorBuf=false;e.geoChunkId=null;var n=this.program.gl;for(var r=0;r<10;r++){n.disableVertexAttribArray(r)}},pick:function(e){var t=this.program.pick;if(e.program){e.program.unbind()}t.bind();var n=this.program.gl;n.uniform1i(this._rayPickMode,e.rayPick);e.program=t;e.vertexBuf=false;e.normalBuf=false;e.uvBuf=false;e.uvBuf2=false;e.colorBuf=false;e.geoChunkId=null;for(var r=0;r<10;r++){n.disableVertexAttribArray(r)}}});SceneJS_ChunkFactory.createChunkType({type:"renderer",build:function(){},drawAndPick:function(e){if(this.core.props){var t=this.program.gl;if(e.renderer){e.renderer.props.restoreProps(t);e.renderer=this.core}this.core.props.setProps(t)}}});SceneJS_ChunkFactory.createChunkType({type:"shader",build:function(){},drawAndPick:function(e){var t=this.core.paramsStack;if(t){var n=e.pick?this.program.pick:this.program.draw;var r;var i;for(var s=0,o=t.length;s<o;s++){r=t[s];for(i in r){if(r.hasOwnProperty(i)){n.setUniform(i,r[i])}}}}}});SceneJS_ChunkFactory.createChunkType({type:"shaderParams",build:function(){},drawAndPick:function(e){var t=this.core.paramsStack;if(t){var n=e.pick?this.program.pick:this.program.draw;var r;var i;for(var s=0,o=t.length;s<o;s++){r=t[s];for(i in r){if(r.hasOwnProperty(i)){n.setUniform(i,r[i])}}}}}});SceneJS_ChunkFactory.createChunkType({type:"texture",build:function(){this._uTexSampler=this._uTexSampler||[];this._uTexMatrix=this._uTexMatrix||[];this._uTexBlendFactor=this._uTexBlendFactor||[];var e=this.core.layers;if(e){var t;var n=this.program.draw;for(var r=0,i=e.length;r<i;r++){t=e[r];this._uTexSampler[r]="SCENEJS_uSampler"+r;this._uTexMatrix[r]=t.matrixAsArray?n.getUniform("SCENEJS_uLayer"+r+"Matrix"):null;this._uTexBlendFactor[r]=n.getUniform("SCENEJS_uLayer"+r+"BlendFactor")}}},draw:function(){var e=this.core.layers;if(e){var t=this.program.draw;var n;for(var r=0,i=e.length;r<i;r++){n=e[r];if(this._uTexSampler[r]&&n.texture){t.bindTexture(this._uTexSampler[r],n.texture,r);if(this._uTexMatrix[r]){this._uTexMatrix[r].setValue(n.matrixAsArray)}if(this._uTexBlendFactor[r]){this._uTexBlendFactor[r].setValue(n.blendFactor)}}else{}}}}});SceneJS_ChunkFactory.createChunkType({type:"xform",build:function(){var e=this.program.draw;this._uMatLocationDraw=e.getUniformLocation("SCENEJS_uMMatrix");this._uNormalMatLocationDraw=e.getUniformLocation("SCENEJS_uMNMatrix");var t=this.program.pick;this._uMatLocationPick=t.getUniformLocation("SCENEJS_uMMatrix");this._uNormalMatLocationPick=t.getUniformLocation("SCENEJS_uMNMatrix")},draw:function(e){if(this.core.dirty&&this.core.build){this.core.build()}var t=this.program.gl;if(this._uMatLocationDraw){t.uniformMatrix4fv(this._uMatLocationDraw,t.FALSE,this.core.mat)}if(this._uNormalMatLocationDraw){t.uniformMatrix4fv(this._uNormalMatLocationDraw,t.FALSE,this.core.normalMat)}e.modelMat=this.core.mat},pick:function(e){if(this.core.dirty){this.core.build()}var t=this.program.gl;if(this._uMatLocationPick){t.uniformMatrix4fv(this._uMatLocationPick,t.FALSE,this.core.mat)}if(this._uNormalMatLocationPick){t.uniformMatrix4fv(this._uNormalMatLocationPick,t.FALSE,this.core.normalMat)}e.modelMat=this.core.mat}});SceneJS.configure({pluginPath:"http://xeolabs.github.com/scenejs/build/latest/plugins"});var SceneHub_Map=function(e,t){this.items=e||[];var n=t||0;var r=n+1;this.addItem=function(){var e;if(arguments.length==2){var t=arguments[0];e=arguments[1];if(this.items[t]){throw"ID clash: '"+t+"'"}this.items[t]=e;return t}else{while(true){e=arguments[0];var n=r++;if(!this.items[n]){this.items[n]=e;return n}}}};this.removeItem=function(e){var t=this.items[e];delete this.items[e];return t}};var SceneHubAPI={};SceneHubAPI.tools={};SceneHubAPI._defaultLoader=function(e,t,n,r){var i=new XMLHttpRequest;i.overrideMimeType("application/json");i.open("GET",SceneHubAPI._cfg.assetPath+"/"+e+"/"+t.replace(/\./g,"/")+".json",true);i.onreadystatechange=function(){if(i.readyState==4){var e=JSON.parse(i.responseText);n(e)}};i.send(null)};SceneHubAPI._cfg={assetLoader:SceneHubAPI._defaultLoader,assetPath:"assets/",dataStore:null};SceneHubAPI.configure=function(e){if(e.assetLoader){SceneHubAPI._cfg.assetLoader=e.assetLoader}if(e.assetPath){SceneHubAPI._cfg.assetPath=e.assetPath}if(e.dataStore){SceneHubAPI._cfg.dataStore=e.dataStore}};SceneHubAPI._isArray=function(e){return e&&!e.propertyIsEnumerable("length")&&typeof e==="object"&&typeof e.length==="number"};SceneHubAPI._extend=function(e,t){var n=function(){};n.prototype=t.prototype;e.prototype=new n;e.prototype.constructor=e};SceneHubAPI._apply=function(e,t){for(var n in e){if(e.hasOwnProperty(n)){t[n]=e[n]}}return t};SceneHubAPI._applyIf=function(e,t){for(var n in e){if(e.hasOwnProperty(n)){if(t[n]==undefined||t[n]==null){t[n]=e[n]}}}return t};SceneHubAPI._math={};SceneHubAPI._math.MAX_DOUBLE=1e7;SceneHubAPI._math.MIN_DOUBLE=-1e7;SceneHubAPI._math.ArbitraryBox3=function(e){this.verts=e};SceneHubAPI._math.ArbitraryBox3.prototype.setVerts=function(e){var t;for(var n=0,r=e.length;n<r;n++){t=e[n];this.verts[n][0]=t[0];this.verts[n][1]=t[1];this.verts[n][2]=t[2];this.verts[n][3]=t[3]}return this};SceneHubAPI._math.ArbitraryBox3.prototype.transform=function(e){this.verts=SceneHubAPI._math.transformPoints4(e,this.verts);return this};SceneHubAPI._math.ArbitraryBox3.fromAxisBox=function(e){return new SceneHubAPI._math.ArbitraryBox3([[e.xmin,e.ymax,e.zmax,1],[e.xmin,e.ymax,e.zmax,1],[e.xmin,e.ymin,e.zmax,1],[e.xmax,e.ymin,e.zmax,1],[e.xmax,e.ymax,e.zmax,1],[e.xmax,e.ymin,e.zmax,1],[e.xmax,e.ymin,e.zmin,1],[e.xmax,e.ymax,e.zmin,1],[e.xmax,e.ymax,e.zmax,1],[e.xmax,e.ymax,e.zmin,1],[e.xmin,e.ymax,e.zmin,1],[e.xmin,e.ymax,e.zmax,1],[e.xmin,e.ymax,e.zmax,1],[e.xmin,e.ymax,e.zmin,1],[e.xmin,e.ymin,e.zmin,1],[e.xmin,e.ymin,e.zmax,1],[e.xmin,e.ymin,e.zmin,1],[e.xmax,e.ymin,e.zmin,1],[e.xmax,e.ymin,e.zmax,1],[e.xmin,e.ymin,e.zmax,1],[e.xmax,e.ymin,e.zmin,1],[e.xmin,e.ymin,e.zmin,1],[e.xmin,e.ymax,e.zmin,1],[e.xmax,e.ymax,e.zmin,1]])};SceneHubAPI._math.AxisBox3=function(e){e=e||{};this.xmin=e.xmin||0;this.ymin=e.ymin||0;this.zmin=e.zmin||0;this.xmax=e.xmax||0;this.ymax=e.ymax||0;this.zmax=e.zmax||0};SceneHubAPI._math.AxisBox3.prototype.invert=function(){this.xmin=SceneHubAPI._math.MAX_DOUBLE;this.ymin=SceneHubAPI._math.MAX_DOUBLE;this.zmin=SceneHubAPI._math.MAX_DOUBLE;this.xmax=SceneHubAPI._math.MIN_DOUBLE;this.ymax=SceneHubAPI._math.MIN_DOUBLE;this.zmax=SceneHubAPI._math.MIN_DOUBLE;return this};SceneHubAPI._math.AxisBox3.prototype.expandByVerts=function(e){for(var t=0,n=e.length;t<n;t++){p=e[t];if(p[0]<this.xmin)this.xmin=p[0];if(p[1]<this.ymin)this.ymin=p[1];if(p[2]<this.zmin)this.zmin=p[2];if(p[0]>this.xmax)this.xmax=p[0];if(p[1]>this.ymax)this.ymax=p[1];if(p[2]>this.zmax)this.zmax=p[2]}return this};SceneHubAPI._math.AxisBox3.prototype.expandAxisBox=function(e){if(e.xmin<this.xmin)this.xmin=e.xmin;if(e.ymin<this.ymin)this.ymin=e.ymin;if(e.zmin<this.zmin)this.zmin=e.zmin;if(e.xmax>this.xmax)this.xmax=e.xmax;if(e.ymax>this.ymax)this.ymax=e.ymax;if(e.zmax>this.zmax)this.zmax=e.zmax;return this};SceneHubAPI._math.transformPoint3=function(e,t){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]]};SceneHubAPI._math.transformPoint4=function(e,t){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]]};SceneHubAPI._math.transformPoints3=function(e,t){var n=new Array(t.length);var r=t.length;for(var i=0;i<r;i++){n[i]=SceneHubAPI._math.transformPoint3(e,t[i])}return n};SceneHubAPI._math.transformPoints4=function(e,t){var n=new Array(t.length);var r=t.length;for(var i=0;i<r;i++){n[i]=SceneHubAPI._math.transformPoint4(e,t[i])}return n};SceneHubAPI._math.clamp=function(e,t,n){return e<t?t:e>n?n:e};SceneHubAPI._math.divVec3=function(e,t){return[e[0]/t[0],e[1]/t[1],e[2]/t[2]]};SceneHubAPI._math.negateVector4=function(e){return[-e[0],-e[1],-e[2],-e[3]]};SceneHubAPI._math.addVec4=function(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3]]};SceneHubAPI._math.addVec4s=function(e,t){return[e[0]+t,e[1]+t,e[2]+t,e[3]+t]};SceneHubAPI._math.addScalarVec4=function(e,t){return SceneHubAPI._math.addVec4s(t,e)};SceneHubAPI._math.addVec3=function(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]};SceneHubAPI._math.addVec3s=function(e,t){return[e[0]+t,e[1]+t,e[2]+t]};SceneHubAPI._math.subVec4=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3]]};SceneHubAPI._math.subVec3=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]};SceneHubAPI._math.lerpVec3=function(e,t,n,r,i){var s=(e-t)/(n-t);return[r[0]+s*(i[0]-r[0]),r[1]+s*(i[1]-r[1]),r[2]+s*(i[2]-r[2])]};SceneHubAPI._math.lerpVec2=function(e,t,n,r,i){var s=(e-t)/(n-t);return[r[0]+s*(i[0]-r[0]),r[1]+s*(i[1]-r[1])]};SceneHubAPI._math.negateVector3=function(e){return[-e[0],-e[1],-e[2]]};SceneHubAPI._math.subVec2=function(e,t){return[e[0]-t[0],e[1]-t[1]]};SceneHubAPI._math.subVec4Scalar=function(e,t){return[e[0]-t,e[1]-t,e[2]-t,e[3]-t]};SceneHubAPI._math.subScalarVec4=function(e,t){return[t-e[0],t-e[1],t-e[2],t-e[3]]};SceneHubAPI._math.mulVec4=function(e,t){return[e[0]*t[0],e[1]*t[1],e[2]*t[2],e[3]*t[3]]};SceneHubAPI._math.mulVec4Scalar=function(e,t){return[e[0]*t,e[1]*t,e[2]*t,e[3]*t]};SceneHubAPI._math.mulVec3Scalar=function(e,t){return[e[0]*t,e[1]*t,e[2]*t]};SceneHubAPI._math.mulVec2Scalar=function(e,t){return[e[0]*t,e[1]*t]};SceneHubAPI._math.divVec4=function(e,t){return[e[0]/t[0],e[1]/t[1],e[2]/t[2],e[3]/t[3]]};SceneHubAPI._math.divScalarVec3=function(e,t){return[e/t[0],e/t[1],e/t[2]]};SceneHubAPI._math.divVec3s=function(e,t){return[e[0]/t,e[1]/t,e[2]/t]};SceneHubAPI._math.divVec4s=function(e,t){return[e[0]/t,e[1]/t,e[2]/t,e[3]/t]};SceneHubAPI._math.divScalarVec4=function(e,t){return[e/t[0],e/t[1],e/t[2],e/t[3]]};SceneHubAPI._math.dotVector4=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]};SceneHubAPI._math.cross3Vec4=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0],0]};SceneHubAPI._math.cross3Vec3=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]};SceneHubAPI._math.sqLenVec4=function(e){return SceneHubAPI._math.dotVector4(e,e)};SceneHubAPI._math.lenVec4=function(e){return Math.sqrt(SceneHubAPI._math.sqLenVec4(e))};SceneHubAPI._math.dotVector3=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]};SceneHubAPI._math.dotVector2=function(e,t){return e[0]*t[0]+e[1]*t[1]};SceneHubAPI._math.sqLenVec3=function(e){return SceneHubAPI._math.dotVector3(e,e)};SceneHubAPI._math.sqLenVec2=function(e){return SceneHubAPI._math.dotVector2(e,e)};SceneHubAPI._math.lenVec3=function(e){return Math.sqrt(SceneHubAPI._math.sqLenVec3(e))};SceneHubAPI._math.lenVec2=function(e){return Math.sqrt(SceneHubAPI._math.sqLenVec2(e))};SceneHubAPI._math.rcpVec3=function(e){return SceneHubAPI._math.divScalarVec3(1,e)};SceneHubAPI._math.vec3ObjToArray=function(e){return[e.x,e.y,e.z]};SceneHubAPI._math.vec3ArrayToObj=function(e){return{x:e[0],y:e[1],z:e[2]}};SceneHubAPI._math.normalizeVec4=function(e){var t=1/SceneHubAPI._math.lenVec4(e);return SceneHubAPI._math.mulVec4Scalar(e,t)};SceneHubAPI._math.normalizeVec3=function(e){var t=1/SceneHubAPI._math.lenVec3(e);return SceneHubAPI._math.mulVec3Scalar(e,t)};SceneHubAPI._math.normalizeVec2=function(e){var t=1/SceneHubAPI._math.lenVec2(e);return SceneHubAPI._math.mulVec2Scalar(e,t)};SceneHubAPI._math.mat4=function(){return new Array(16)};SceneHubAPI._math.dupMat4=function(e){return e.slice(0,16)};SceneHubAPI._math.getCellMat4=function(e,t,n){return e[t+n*4]};SceneHubAPI._math.setCellMat4=function(e,t,n,r){e[t+n*4]=r};SceneHubAPI._math.getRowMat4=function(e,t){return[e[t+0],e[t+4],e[t+8],e[t+12]]};SceneHubAPI._math.setRowMat4=function(e,t,n){e[t+0]=n[0];e[t+4]=n[1];e[t+8]=n[2];e[t+12]=n[3]};SceneHubAPI._math.setRowMat4c=function(e,t,n,r,i,s){SceneHubAPI._math.setRowMat4(e,t,[n,r,i,s])};SceneHubAPI._math.setRowMat4s=function(e,t,n){SceneHubAPI._math.setRowMat4c(e,t,n,n,n,n)};SceneHubAPI._math.getColMat4=function(e,t){var n=t*4;return[e[n+0],e[n+1],e[n+2],e[n+3]]};SceneHubAPI._math.setColMat4v=function(e,t,n){var r=t*4;e[r+0]=n[0];e[r+1]=n[1];e[r+2]=n[2];e[r+3]=n[3]};SceneHubAPI._math.setColMat4c=function(e,t,n,r,i,s){SceneHubAPI._math.setColMat4v(e,t,[n,r,i,s])};SceneHubAPI._math.setColMat4Scalar=function(e,t,n){SceneHubAPI._math.setColMat4c(e,t,n,n,n,n)};SceneHubAPI._math.mat4To3=function(e){return[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]};SceneHubAPI._math.m4s=function(e){return[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]};SceneHubAPI._math.setMat4ToZeroes=function(){return SceneHubAPI._math.m4s(0)};SceneHubAPI._math.setMat4ToOnes=function(){return SceneHubAPI._math.m4s(1)};SceneHubAPI._math.diagonalMat4v=function(e){return[e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]]};SceneHubAPI._math.diagonalMat4c=function(e,t,n,r){return SceneHubAPI._math.diagonalMat4v([e,t,n,r])};SceneHubAPI._math.diagonalMat4s=function(e){return SceneHubAPI._math.diagonalMat4c(e,e,e,e)};SceneHubAPI._math.identityMat4=function(){return SceneHubAPI._math.diagonalMat4s(1)};SceneHubAPI._math.isIdentityMat4=function(e){var t=0;var n=0;var r=0;for(t=0;t<4;++t){for(n=0;n<4;++n){r=e[t+n*4];if(t==n){if(r!=1){return false}}else{if(r!=0){return false}}}}return true};SceneHubAPI._math.negateMat4=function(e){var t=SceneHubAPI._math.mat4();for(var n=0;n<16;++n){t[n]=-e[n]}return t};SceneHubAPI._math.addMat4=function(e,t){var n=SceneHubAPI._math.mat4();for(var r=0;r<16;++r){n[r]=e[r]+t[r]}return n};SceneHubAPI._math.addMat4Scalar=function(e,t){var n=SceneHubAPI._math.mat4();for(var r=0;r<16;++r){n[r]=e[r]+t}return n};SceneHubAPI._math.addScalarMat4=function(e,t){return SceneHubAPI._math.addMat4Scalar(t,e)};SceneHubAPI._math.subMat4=function(e,t){var n=SceneHubAPI._math.mat4();for(var r=0;r<16;++r){n[r]=e[r]-t[r]}return n};SceneHubAPI._math.subMat4Scalar=function(e,t){var n=SceneHubAPI._math.mat4();for(var r=0;r<16;++r){n[r]=e[r]-t}return n};SceneHubAPI._math.subScalarMat4=function(e,t){var n=SceneHubAPI._math.mat4();for(var r=0;r<16;++r){n[r]=e-t[r]}return n};SceneHubAPI._math.mulMat4=function(e,t,n){if(!n){n=e}var r=e[0],i=e[1],s=e[2],o=e[3];var u=e[4],a=e[5],f=e[6],l=e[7];var c=e[8],h=e[9],p=e[10],d=e[11];var v=e[12],m=e[13],g=e[14],y=e[15];var b=t[0],w=t[1],E=t[2],S=t[3];var x=t[4],T=t[5],N=t[6],C=t[7];var k=t[8],L=t[9],A=t[10],O=t[11];var M=t[12],_=t[13],D=t[14],P=t[15];n[0]=b*r+w*u+E*c+S*v;n[1]=b*i+w*a+E*h+S*m;n[2]=b*s+w*f+E*p+S*g;n[3]=b*o+w*l+E*d+S*y;n[4]=x*r+T*u+N*c+C*v;n[5]=x*i+T*a+N*h+C*m;n[6]=x*s+T*f+N*p+C*g;n[7]=x*o+T*l+N*d+C*y;n[8]=k*r+L*u+A*c+O*v;n[9]=k*i+L*a+A*h+O*m;n[10]=k*s+L*f+A*p+O*g;n[11]=k*o+L*l+A*d+O*y;n[12]=M*r+_*u+D*c+P*v;n[13]=M*i+_*a+D*h+P*m;n[14]=M*s+_*f+D*p+P*g;n[15]=M*o+_*l+D*d+P*y;return n};SceneHubAPI._math.mulMat4s=function(e,t){var n=SceneHubAPI._math.mat4();for(var r=0;r<16;++r){n[r]=e[r]*t}return n};SceneHubAPI._math.mulMat4v4=function(e,t){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]]};SceneHubAPI._math.transposeMat4=function(e){var t=SceneHubAPI._math.mat4();var n=0;var r=0;for(n=0;n<4;++n){for(r=0;r<4;++r){t[n+r*4]=e[n*4+r]}}return t};SceneHubAPI._math.determinantMat4=function(e){var t=SceneHubAPI._math.getCellMat4;return t(e,0,3)*t(e,1,2)*t(e,2,1)*t(e,3,0)-t(e,0,2)*t(e,1,3)*t(e,2,1)*t(e,3,0)-t(e,0,3)*t(e,1,1)*t(e,2,2)*t(e,3,0)+t(e,0,1)*t(e,1,3)*t(e,2,2)*t(e,3,0)+t(e,0,2)*t(e,1,1)*t(e,2,3)*t(e,3,0)-t(e,0,1)*t(e,1,2)*t(e,2,3)*t(e,3,0)-t(e,0,3)*t(e,1,2)*t(e,2,0)*t(e,3,1)+t(e,0,2)*t(e,1,3)*t(e,2,0)*t(e,3,1)+t(e,0,3)*t(e,1,0)*t(e,2,2)*t(e,3,1)-t(e,0,0)*t(e,1,3)*t(e,2,2)*t(e,3,1)-t(e,0,2)*t(e,1,0)*t(e,2,3)*t(e,3,1)+t(e,0,0)*t(e,1,2)*t(e,2,3)*t(e,3,1)+t(e,0,3)*t(e,1,1)*t(e,2,0)*t(e,3,2)-t(e,0,1)*t(e,1,3)*t(e,2,0)*t(e,3,2)-t(e,0,3)*t(e,1,0)*t(e,2,1)*t(e,3,2)+t(e,0,0)*t(e,1,3)*t(e,2,1)*t(e,3,2)+t(e,0,1)*t(e,1,0)*t(e,2,3)*t(e,3,2)-t(e,0,0)*t(e,1,1)*t(e,2,3)*t(e,3,2)-t(e,0,2)*t(e,1,1)*t(e,2,0)*t(e,3,3)+t(e,0,1)*t(e,1,2)*t(e,2,0)*t(e,3,3)+t(e,0,2)*t(e,1,0)*t(e,2,1)*t(e,3,3)-t(e,0,0)*t(e,1,2)*t(e,2,1)*t(e,3,3)-t(e,0,1)*t(e,1,0)*t(e,2,2)*t(e,3,3)+t(e,0,0)*t(e,1,1)*t(e,2,2)*t(e,3,3)};SceneHubAPI._math.inverseMat4=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14],m=e[15];var g=SceneHubAPI._math.identityMat4();g[0]=l*v*a-d*c*a+d*u*h-o*v*h-l*u*m+o*c*m;g[1]=d*c*i-l*v*i-d*r*h+n*v*h+l*r*m-n*c*m;g[2]=o*v*i-d*u*i+d*r*a-n*v*a-o*r*m+n*u*m;g[3]=l*u*i-o*c*i-l*r*a+n*c*a+o*r*h-n*u*h;g[4]=p*c*a-f*v*a-p*u*h+s*v*h+f*u*m-s*c*m;g[5]=f*v*i-p*c*i+p*r*h-t*v*h-f*r*m+t*c*m;g[6]=p*u*i-s*v*i-p*r*a+t*v*a+s*r*m-t*u*m;g[7]=s*c*i-f*u*i+f*r*a-t*c*a-s*r*h+t*u*h;g[8]=f*d*a-p*l*a+p*o*h-s*d*h-f*o*m+s*l*m;g[9]=p*l*i-f*d*i-p*n*h+t*d*h+f*n*m-t*l*m;g[10]=s*d*i-p*o*i+p*n*a-t*d*a-s*n*m+t*o*m;g[11]=f*o*i-s*l*i-f*n*a+t*l*a+s*n*h-t*o*h;g[12]=p*l*u-f*d*u-p*o*c+s*d*c+f*o*v-s*l*v;g[13]=f*d*r-p*l*r+p*n*c-t*d*c-f*n*v+t*l*v;g[14]=p*o*r-s*d*r-p*n*u+t*d*u+s*n*v-t*o*v;g[15]=s*l*r-f*o*r+f*n*u-t*l*u-s*n*c+t*o*c;var y=1/(p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*m+s*l*r*m+f*n*u*m-t*l*u*m-s*n*c*m+t*o*c*m);for(var b=0;b<16;++b){g[b]*=y}return g};SceneHubAPI._math.traceMat4=function(e){return e[0]+e[5]+e[10]+e[15]};SceneHubAPI._math.translationMat4v=function(e){var t=SceneHubAPI._math.identityMat4();t[12]=e[0];t[13]=e[1];t[14]=e[2];return t};SceneHubAPI._math.translationMat4c=function(e,t,n){return SceneHubAPI._math.translationMat4v([e,t,n])};SceneHubAPI._math.translationMat4s=function(e){return SceneHubAPI._math.translationMat4c(e,e,e)};SceneHubAPI._math.rotationMat4v=function(e,t){var n=SceneHubAPI._math.normalizeVec4([t[0],t[1],t[2],0]);var r=Math.sin(e);var i=Math.cos(e);var s=1-i;var o=n[0];var u=n[1];var a=n[2];var f,l,c,h,p,d,v,m,g;f=o*o;l=u*u;c=a*a;h=o*u;p=u*a;d=a*o;v=o*r;m=u*r;g=a*r;var y=SceneHubAPI._math.mat4();y[0]=s*f+i;y[1]=s*h+g;y[2]=s*d-m;y[3]=0;y[4]=s*h-g;y[5]=s*l+i;y[6]=s*p+v;y[7]=0;y[8]=s*d+m;y[9]=s*p-v;y[10]=s*c+i;y[11]=0;y[12]=0;y[13]=0;y[14]=0;y[15]=1;return y};SceneHubAPI._math.rotationEulerMat4v=function(e,t,n){var r=Math.cos(-t);var i=Math.sin(-t);var s=Math.cos(-n);var o=Math.sin(-n);var u=Math.cos(-e);var a=Math.sin(-e);return[r*s,i*a-r*o*u,r*o*a+i*u,0,o,s*u,-s*a,0,-i*s,i*o*u+r*a,-i*o*a+r*u,0,0,0,0,1]};SceneHubAPI._math.rotationMat4c=function(e,t,n,r){return SceneHubAPI._math.rotationMat4v(e,[t,n,r])};SceneHubAPI._math.scalingMat4v=function(e){var t=SceneHubAPI._math.identityMat4();t[0]=e[0];t[5]=e[1];t[10]=e[2];return t};SceneHubAPI._math.scalingMat4c=function(e,t,n){return SceneHubAPI._math.scalingMat4v([e,t,n])};SceneHubAPI._math.scalingMat4s=function(e){return SceneHubAPI._math.scalingMat4c(e,e,e)};SceneHubAPI._math.lookAtMat4v=function(e,t,n){var r=[e[0],e[1],e[2],0];var i=[t[0],t[1],t[2],0];var s=[n[0],n[1],n[2],0];var o=SceneHubAPI._math.normalizeVec4(SceneHubAPI._math.subVec4(i,r));var u=SceneHubAPI._math.normalizeVec4(s);var a=SceneHubAPI._math.normalizeVec4(SceneHubAPI._math.cross3Vec4(o,u));u=SceneHubAPI._math.normalizeVec4(SceneHubAPI._math.cross3Vec4(a,o));var f=SceneHubAPI._math.mat4();f[0]=a[0];f[1]=u[0];f[2]=-o[0];f[3]=0;f[4]=a[1];f[5]=u[1];f[6]=-o[1];f[7]=0;f[8]=a[2];f[9]=u[2];f[10]=-o[2];f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;f=SceneHubAPI._math.mulMat4(f,SceneHubAPI._math.translationMat4v(SceneHubAPI._math.negateVector4(r)));return f};SceneHubAPI._math.lookAtMat4c=function(e,t,n,r,i,s,o,u,a){return SceneHubAPI._math.lookAtMat4v([e,t,n],[r,i,s],[o,u,a])};SceneHubAPI._math.orthoMat4v=function(e,t){var n=[e[0],e[1],e[2],0];var r=[t[0],t[1],t[2],0];var i=SceneHubAPI._math.addVec4(r,n);var s=SceneHubAPI._math.subVec4(r,n);var o=SceneHubAPI._math.mat4();o[0]=2/s[0];o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=2/s[1];o[6]=0;o[7]=0;o[8]=0;o[9]=0;o[10]=-2/s[2];o[11]=0;o[12]=-i[0]/s[0];o[13]=-i[1]/s[1];o[14]=-i[2]/s[2];o[15]=1;return o};SceneHubAPI._math.orthoMat4c=function(e,t,n,r,i,s){return SceneHubAPI._math.orthoMat4v([e,n,i],[t,r,s])};SceneHubAPI._math.frustumMat4v=function(e,t){var n=[e[0],e[1],e[2],0];var r=[t[0],t[1],t[2],0];var i=SceneHubAPI._math.addVec4(r,n);var s=SceneHubAPI._math.subVec4(r,n);var o=2*n[2];var u=SceneHubAPI._math.mat4();u[0]=o/s[0];u[1]=0;u[2]=0;u[3]=0;u[4]=0;u[5]=o/s[1];u[6]=0;u[7]=0;u[8]=i[0]/s[0];u[9]=i[1]/s[1];u[10]=-i[2]/s[2];u[11]=-1;u[12]=0;u[13]=0;u[14]=-o*r[2]/s[2];u[15]=0;return u};SceneHubAPI._math.frustumMatrix4=function(e,t,n,r,i,s){return SceneHubAPI._math.frustumMat4v([e,n,i],[t,r,s])};SceneHubAPI._math.perspectiveMatrix4=function(e,t,n,r){var i=new Array(4);var s=new Array(4);i[2]=n;s[2]=r;s[1]=i[2]*Math.tan(e/2);i[1]=-s[1];s[0]=s[1]*t;i[0]=-s[0];return SceneHubAPI._math.frustumMat4v(i,s)};SceneHubAPI._math.transformPoint3=function(e,t){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]]};SceneHubAPI._math.transformPoint4=function(e,t){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]]};SceneHubAPI._math.transformPoints3=function(e,t){var n=new Array(t.length);var r=t.length;for(var i=0;i<r;i++){n[i]=SceneHubAPI._math.transformPoint3(e,t[i])}return n};SceneHubAPI._math.transformVector3=function(e,t){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2],e[1]*t[0]+e[5]*t[1]+e[9]*t[2],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]]};SceneHubAPI._math.projectVec4=function(e){var t=1/e[3];return[e[0]*t,e[1]*t,e[2]*t,1]};SceneHubAPI._math.Plane3=function(e,t,n){this.normal=[0,0,1];this.offset=0;if(e&&t){this.normal[0]=e[0];this.normal[1]=e[1];this.normal[2]=e[2];this.offset=t;if(n){var r=Math.sqrt(this.normal[0]*this.normal[0]+this.normal[1]*this.normal[1]+this.normal[2]*this.normal[2]);if(r>0){r=1/r;this.normal[0]*=r;this.normal[1]*=r;this.normal[2]*=r;this.offset*=r}}}};SceneHubAPI._math.identityQuaternion=function(){return[0,0,0,1]};SceneHubAPI._math.angleAxisQuaternion=function(e,t){var n=t/2;var r=Math.sin(n);return[r*e[0],r*e[1],r*e[2],Math.cos(n)]};SceneHubAPI._math.mulQuaternions=function(e,t){return[e[3]*t[0]+e[0]*t[3]+e[1]*t[2]-e[2]*t[1],e[3]*t[1]+e[1]*t[3]+e[2]*t[0]-e[0]*t[2],e[3]*t[2]+e[2]*t[3]+e[0]*t[1]-e[1]*t[0],e[3]*t[3]-e[0]*t[0]-e[1]*t[1]-e[2]*t[2]]};SceneHubAPI._math.newMat4FromQuaternion=function(e){var t=2*e[0];var n=2*e[1];var r=2*e[2];var i=t*e[3];var s=n*e[3];var o=r*e[3];var u=t*e[0];var a=n*e[0];var f=r*e[0];var l=n*e[1];var c=r*e[1];var h=r*e[2];var p=SceneHubAPI._math.identityMat4();SceneHubAPI._math.setCellMat4(p,0,0,1-(l+h));SceneHubAPI._math.setCellMat4(p,0,1,a-o);SceneHubAPI._math.setCellMat4(p,0,2,f+s);SceneHubAPI._math.setCellMat4(p,1,0,a+o);SceneHubAPI._math.setCellMat4(p,1,1,1-(u+h));SceneHubAPI._math.setCellMat4(p,1,2,c-i);SceneHubAPI._math.setCellMat4(p,2,0,f-s);SceneHubAPI._math.setCellMat4(p,2,1,c+i);SceneHubAPI._math.setCellMat4(p,2,2,1-(u+l));return p};SceneHubAPI._math.normalizeQuaternion=function(e){var t=SceneHubAPI._math.lenVec3([e[0],e[1],e[2]]);return[e[0]/t,e[1]/t,e[2]/t,e[3]/t]};SceneHubAPI._math.conjugateQuaternion=function(e){return[-e[0],-e[1],-e[2],e[3]]};SceneHubAPI._math.angleAxisFromQuaternion=function(e){e=SceneHubAPI._math.normalizeQuaternion(e);var t=2*Math.acos(e[3]);var n=Math.sqrt(1-e[3]*e[3]);if(n<.001){return{x:e[0],y:e[1],z:e[2],angle:t}}else{return{x:e[0]/n,y:e[1]/n,z:e[2]/n,angle:t}}};SceneHubAPI._math.getBoundaryCenter=function(e){return[(e.xmax+e.xmin)*.5,(e.ymax+e.ymin)*.5,(e.zmax+e.zmin)*.5]};SceneHubAPI._math.getBoundaryDiag=function(e){return Math.abs(SceneHubAPI._math.lenVec3(SceneHubAPI._math.subVec3([e.xmax,e.ymax,e.zmax],[e.xmin,e.ymin,e.zmin])))};SceneHubAPI.Component=function(){};SceneHubAPI.Component.prototype={_init:function(){this._handleMap=new SceneHub_Map;this._topicSubs={};this._handleTopics={};this._topicPubs={}},_publish:function(e,t){this._topicPubs[e]=t;var n=this._topicSubs[e];if(n){for(var r in n){if(n.hasOwnProperty(r)){n[r].call(this,t)}}}},on:function(e,t){var n=this._topicSubs[e];if(!n){n={};this._topicSubs[e]=n}var r=this._handleMap.addItem();n[r]=t;this._handleTopics[r]=e;var i=this._topicPubs[e];if(i){t.call(this,i)}return r},off:function(e){var t=this._handleTopics[e];if(t){delete this._handleTopics[e];var n=this._topicSubs[t];if(n){delete n[e]}this._handleMap.removeItem(e)}},once:function(e,t){var n=this;var r=this.on(e,function(e){n.off(r);t(e)})},log:function(e){console.log(e)}};var SceneHub=function(e){this._init();this._cfg=SceneHubAPI._apply(e||{},SceneHubAPI._cfg);this._idMap=new SceneHub_Map;this.scenes={}};SceneHubAPI._extend(SceneHub,SceneHubAPI.Component);SceneHub.prototype.createScene=function(e,t){e=e||{};var n=e.id;if(n){if(this.scenes[n]){throw"scene with this ID already in client: "+n}}else{n=this._idMap.addItem({});e=SceneHubAPI._apply({id:n},e)}if(e.useScene){var r=this;this._cfg.assetLoader("scene",e.useScene,function(n){var i=r._createScene(SceneHubAPI._apply(e,n));if(t){t(i)}})}else if(e.dataRef){var i=e.dataRef;if(!i.user){throw"param expected: dataRef.user"}if(!i.id){throw"param expected: dataRef.id"}if(!this._dataStore){throw"no dataStore configured"}}else{var s=this._createScene(e);if(t){t(s)}return s}};SceneHub.prototype._createScene=function(e){var t=new SceneHubAPI.Scene(SceneHubAPI._apply(e,this._cfg));this.scenes[e.id]=t;this._publish("scenes."+e.id,t);return t};SceneHubAPI.Scene=function(e){function a(e,t){e=e.replace(/\./g,"/");var n=e.lastIndexOf("/");f(n>-1?e.substr(0,n):"",t)}function f(t,n){if(n.appearance){var r=n.appearance;if(r.texture){var i=r.texture.layers;if(i){for(var s=0,o=i.length;s<o;s++){i[s].src=e.assetPath+"/object/"+t+"/"+i[s].src}}}}if(n.sound){n.sound.src=e.assetPath+"/object/"+t+"/"+n.sound.src}if(n.objects){var u=n.objects;for(var s=0,o=u.length;s<o;s++){f(t,u[s])}}}this._init(this);this.id=e.id;e=e||{};var t;if(e.nodes){if(!e.nodes["world"]){throw"'world' node mandatory in nodes config"}t=e.nodes}else{if(e.scene){this._scenejsScene=e.scene}else{var n=e.canvasId;if(!n){n="canvas-"+this.id;var r=document.getElementsByTagName("body")[0];r.innerHTML="";var i=document.createElement("div");i.style.height="100%";i.style.width="100%";var s="";if(e.forkMeRibbon!==false){s='<a href="https://github.com/scenehub"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>'}i.innerHTML='<canvas id="'+n+'" style="width: 100%; height: 100%; margin: 0; padding: 0;"></canvas>'+s;r.appendChild(i)}this._scenejsScene=SceneJS.createScene(SceneHubAPI.Scene._getDefaultScene(this.id,n,e.lights));var o=this;this._scenejsScene.start({idleFunc:function(){o._publish("tick")}})}var u=this._scenejsScene.getNode("world");if(!u){throw"scene must have a node with ID 'world'"}t={world:u,view:this._scenejsScene.getNode("view"),sky:this._scenejsScene.getNode("sky")}}this._objectFactory=new SceneHubAPI.Scene._ObjectFactory(this,e.assetLoader,a,t);this._dataStore=e.dataStore;this.objects={};this.rootObjects={};this.numObjects=0;this.numObjectsLoading=0;var l=this._scenejsScene.getNode("camera");if(!l){throw"scene node not found: 'camera'"}var c=this._scenejsScene.getNode("lookat");if(!c){throw"scene node not found: 'lookat'"}this.camera=new SceneHubAPI.Camera(this,l,c,e.camera||{});var h=t["world"].addNode({type:"library"});this.appearances=new SceneHubAPI.AssetLibrary({model:this,type:"appearance",libNode:h,loader:e.assetLoader,postLoad:function(t,n){t=t.replace(/\./g,"/");var r=t.lastIndexOf("/");if(r>-1){t=t.substr(0,r)}else{t=""}if(n.texture){var i=n.texture.layers;if(i){for(var s=0,o=i.length;s<o;s++){i[s].src=e.assetPath+"/appearance/"+t+"/"+i[s].src}}}},factory:SceneHubAPI.Appearance});this.shaders=new SceneHubAPI.AssetLibrary({type:"shader",model:this,libNode:h,loader:e.assetLoader,factory:SceneHubAPI.Shader});this.geometries=new SceneHubAPI.AssetLibrary({type:"geometry",model:this,libNode:h,loader:e.assetLoader,factory:SceneHubAPI.Geometry});this.morphs=new SceneHubAPI.AssetLibrary({type:"morph",model:this,libNode:h,loader:e.assetLoader,factory:SceneHubAPI.Morph});this.behaviours=new SceneHubAPI.AssetLibrary({type:"behaviour",model:this,loader:e.assetLoader,factory:SceneHubAPI.Behaviour});this.sounds=new SceneHubAPI.AssetLibrary({type:"sound",model:this,loader:e.assetLoader,postLoad:function(t,n){t=t.replace(/\./g,"/");var r=t.lastIndexOf("/");if(r>-1){t=t.substr(0,r)}else{t=""}n.src=e.assetPath+"/sound/"+t+"/"+n.src},factory:SceneHubAPI.Sound});if(e.objects){for(var p=0,d=e.objects.length;p<d;p++){this.createObject(e.objects[p])}}};SceneHubAPI._extend(SceneHubAPI.Scene,SceneHubAPI.Component);SceneHubAPI.Scene.prototype.createObject=function(e,t){this._objectFactory.create(null,null,e,t)};SceneHubAPI.Scene.prototype.save=function(e,t,n){if(!e){throw"param expected: key"}if(!this._dataStore){throw"no dataStore configured"}this._dataStore.save(e,this.id,this._toJSON(),t,n)};SceneHubAPI.Scene.prototype._toJSON=function(){var e={foo:"foo",objects:[]};for(var t in this.rootObjects){if(this.rootObjects.hasOwnProperty(t)){e.objects.push(this.objects[t]._toJSON())}}return e};SceneHubAPI.Scene.prototype.destroy=function(){};SceneHubAPI.Scene._getDefaultScene=function(e,t,n){return{id:e,canvasId:t,nodes:[{id:"camera",type:"camera",optics:{type:"perspective",fovy:40,aspect:1.47,near:.1,far:1e4},nodes:[{type:"lookAt",eye:{x:0,y:0,z:-1},look:{x:0,y:0,z:0},up:{x:0,y:1,z:0},nodes:[{type:"lights",lights:[{mode:"dir",color:{r:1,g:1,b:1},diffuse:true,specular:true,dir:{x:1,y:-.5,z:-1},scope:"world"},{mode:"dir",color:{r:1,g:1,b:1},diffuse:true,specular:true,dir:{x:0,y:0,z:1},scope:"world"},{mode:"dir",color:{r:1,g:1,b:1},diffuse:true,specular:false,dir:{x:0,y:0,z:1},scope:"world"}],nodes:[{type:"material",baseColor:{r:1,g:1,b:1},emit:2,id:"view"}]}]},{id:"lookat",type:"lookAt",eye:{x:0,y:0,z:-100},look:{x:0,y:0,z:0},up:{x:0,y:1,z:0},nodes:[{id:"sky",type:"shader",shaders:[{stage:"vertex",code:["mat4 myViewMatrix(mat4 m) {","   m[3][0] =m[3][1] = m[3][2] = 0.0;","return m;","}"],hooks:{viewMatrix:"myViewMatrix"}}]},{id:"lights",type:"lights",lights:n||[{mode:"ambient",color:[.6,.6,.6],diffuse:true,specular:false},{mode:"dir",color:[1,1,1],diffuse:true,specular:true,dir:[.5,-1,-.6]},{mode:"dir",color:[1,1,1],diffuse:true,specular:true,dir:[-1,0,0]}],nodes:[{id:"world",type:"material",baseColor:{r:1,g:1,b:1},emit:2}]}]}]}]}};SceneHubAPI.Camera=function(e,t,n,r){this._init();this.model=e;this._camera=t;this._lookat=n;this.set(r)};SceneHubAPI._extend(SceneHubAPI.Camera,SceneHubAPI.Component);SceneHubAPI.Camera.prototype.set=function(e){e=e||{};if(e.eye){this._lookat.setEye(e.eye);this._publish("eye",this._lookat.getEye())}if(e.look){this._lookat.setLook(e.look);this._publish("look",this._lookat.getLook())}if(e.up){this._lookat.setUp(e.up);this._publish("up",this._lookat.getUp())}if(e.optics){this._camera.setOptics(e.optics);this._publish("optics",this._camera.getOptics())}};SceneHubAPI.Scene._ObjectFactory=function(e,t,n,r){function s(e){var t=1;for(var n in e.objects){if(e.objects.hasOwnProperty(n)){t+=s(e.objects[n])}}return t}var i=new SceneHub_Map;this.create=function(s,o,u,a){i.addItem();var f;if(u.id){if(e.objects[u.id]){throw"object already exists: "+u.id}f=u.id}else{f=i.addItem({})}if(!o){var l=u.space||"world";o=r[l];if(!o){throw"node not found: "+l}}e._publish("objectLoading",{objectId:f,numObjectsLoading:e.numObjectsLoading});var c=this;if(u.useObject){t("object",u.useObject,function(e){n(u.useObject,e);c._createObject(s,o,SceneHubAPI._apply(u,e),f,a)})}else{this._createObject(s,o,u,f,a)}};this._createObject=function(t,n,r,i,s){new SceneHubAPI.Object(e,t,n,r,this,function(t){e.objects[i]=t;e.numObjects++;if(s){s(t)}e.numObjectsLoading--;e._publish("objectCreated",{object:t,numObjectsLoading:e.numObjectsLoading});e._publish("objects."+i,t)})};this.destroy=function(t){var n=t.id;if(!e.objects[n]){return}delete e.objects[n];delete e.rootObjects[n];i.removeItem(n);e.numObjects--;e._publish("objectDestroyed",{objectId:n});e._publish("objects."+t.id,null)}};SceneHubAPI.Object=function(e,t,n,r,i,s){function a(){u._buildNodes(r,n,o,function(){var e=r.objects;if(e){for(var t=0,n=e.length;t<n;t++){u.createObject(e[t])}}if(s){s(u)}})}this._init();this.model=e;this.id=r.id;this.parent=t;this.level=t?t.level+1:0;this.objects={};this.numObjects=0;this._factory=i;var o={materialCoreId:null,materialAttr:null,textureCoreId:null,textureAttr:null,shaderCoreId:null,shaderAttr:null,morphCoreId:null,morphAttr:null,geometryCoreId:null,geometryAttr:null,soundAttr:null};var u=this;var f=[];var l=0;if(r.useAppearance){f.push(function(){u.model.appearances.getAsset(r.useAppearance,function(e){if(e.material){o.materialCoreId=e.material.getCoreId()}if(e.texture){o.textureCoreId=e.texture.getCoreId()}u._appearanceId=r.useAppearance;if(--l==0){a()}})});l++}else if(r.appearance){o.materialAttr=r.appearance.material;o.textureAttr=r.appearance.texture}if(r.useShader){f.push(function(){u.model.shaders.getAsset(r.useShader,function(e){o.shaderCoreId=e.node.getCoreId();u._shaderId=r.useShader;if(--l==0){a()}})});l++}else if(r.shader){o.shaderAttr=r.shader}if(r.shaderParams){o.shaderParams=r.shaderParams}if(r.useMorph){f.push(function(){u.model.geometries.getAsset(r.useMorph,function(e){o.morphCoreId=e.node.getCoreId();u._morphId=r.useMorph;if(--l==0){a()}})});l++}else if(r.morph){o.morphAttr=r.morph}if(r.useGeometry){f.push(function(){u.model.geometries.getAsset(r.useGeometry,function(e){o.geometryCoreId=e.node.getCoreId();u._geometryId=r.useGeometry;if(--l==0){a()}})});l++}else if(r.geometry){o.geometryAttr=r.geometry}if(r.useSound){f.push(function(){u.model.sounds.getAsset(r.useSound,function(e){o.soundAttr=e.attr;u._soundId=r.useSound;if(--l==0){a()}})});l++}else if(r.sound){o.soundAttr=r.sound}if(r.events){o.events=r.events}if(r.behaviours){var c=r.behaviours;var h;for(var p in c){if(c.hasOwnProperty(p)){h=c[p];if(SceneHubAPI._isArray(h)){for(var d=0,v=h.length;d<v;d++){this.on(p,h[d].fn)}}else{this.on(p,h.fn)}}}}if(f.length==0){a()}else{while(f.length>0){f.pop()()}}};SceneHubAPI._extend(SceneHubAPI.Object,SceneHubAPI.Component);SceneHubAPI.Object.prototype._buildNodes=function(e,t,n,r){this.flags=t.addNode({type:"flags",flags:SceneHubAPI._apply(e.flags||{},{enabled:true})});t=this.flags;this._rootNode=this.flags;if(e.translate){this.translate=t.addNode({type:"translate",x:e.translate.x,y:e.translate.y,z:e.translate.z});t=this.translate}if(e.rotate){this.rotate=t.addNode({type:"rotate",x:e.rotate.x,y:e.rotate.y,z:e.rotate.z,angle:e.rotate.angle});t=this.rotate}if(e.scale){this.scale=t.addNode({type:"scale",x:e.scale.x,y:e.scale.y,z:e.scale.z});t=this.scale}if(e.name){t=this.name=t.addNode({type:"name",name:e.name})}if(n.materialCoreId){t=this.material=t.addNode({type:"material",coreId:n.materialCoreId})}else if(n.materialAttr){n.materialAttr.type="material";t=this.material=t.addNode(n.materialAttr)}if(n.textureCoreId){t=this.texture=t=t.addNode({type:"texture",coreId:n.textureCoreId})}else if(n.textureAttr){n.textureAttr.type="texture";t=this.texture=t.addNode(n.textureAttr)}if(n.shaderParams){t=this.shaderParams=t.addNode({type:"shaderParams",params:e.shaderParams||{}})}if(n.morphCoreId||n.morphAttr){if(n.morphCoreId){this.morph=t.addNode({type:"morphGeometry",coreId:n.morphCoreId})}else if(n.morphAttr){n.morphAttr.type="morphGeometry";this.morph=t.addNode(n.morphAttr)}t=this.morph}if(n.geometryCoreId||n.geometryAttr){if(n.geometryCoreId){this.geometry=t.addNode({type:"geometry",coreId:n.geometryCoreId})}else if(n.geometryAttr){n.geometryAttr.type="geometry";this.geometry=t.addNode(n.geometryAttr)}t=this.geometry;var i=t.getBoundary();this._modelBoundary=new SceneHubAPI._math.AxisBox3(i);this._worldBoundary=null}if(n.soundAttr){if(!n.geometryCoreId&&!n.geometryAttr){t.addNode({type:"geometry",coreId:"__sound-location",primitive:"points",positions:[1,1,1],indices:[0]})}var s=new SceneHubAPI._SoundRenderer(n.soundAttr);this._soundRenderer=s;this.flags.addListener("rendered",function(e){var t=e.params;var n=t.getWorldPos([0,0,0]);s.set({pos:n})})}this._leafNode=t;r()};SceneHubAPI.Object.prototype.createObject=function(e,t){this._factory.create(this,this._leafNode,e,t)};SceneHubAPI.Object.prototype.set=function(e){var t=false;if(e.flags&&this.flags){this.flags.setFlags(e.flags);if(this._soundRenderer){this._soundRenderer.set({mute:!this.flags.getEnabled()})}}if(e.translate&&this.translate){this.translate.setXYZ(e.translate);t=true}if(e.scale&&this.scale){this.scale.setXYZ(e.scale);t=true}if(e.rotate&&this.rotate){this.rotate.set(e.rotate);t=true}if(e.shaderParams&&this.shaderParams){this.shaderParams.setParams(e.shaderParams)}if(e.morphFactor&&this.morph){this.morph.setFactor(e.morphFactor)}if(e.sound&&this._soundRenderer){this._soundRenderer.set(e.sound)}if(t){this._setBoundaryDirty()}};SceneHubAPI.Object.prototype._setBoundaryDirty=function(){this._worldBoundary=null;if(this.numObjects>0){for(var e in this.objects){if(this.objects.hasOwnProperty(e)){this.objects[e]._setBoundaryDirty()}}}this._publish("boundaryUpdated")};SceneHubAPI.Object.prototype.getModelBoundary=function(){return this._modelBoundary};SceneHubAPI.Object.prototype.getWorldBoundary=function(){if(!this._worldBoundary){this._buildWorldBoundary()}return this._worldBoundary};SceneHubAPI.Object.prototype._buildWorldBoundary=function(){if(!this._worldBoundary){if(this._modelBoundary){var e=new SceneHubAPI._math.ArbitraryBox3.fromAxisBox(this._modelBoundary);var t=this.getWorldMatrix();if(t){e.transform(t)}this._worldBoundary=(new SceneHubAPI._math.AxisBox3).invert().expandByVerts(e.verts)}}};SceneHubAPI.Object.prototype.getWorldMatrix=function(){for(var e=this;!!e;e=e.parent){if(e.scale){return e.scale.getWorldMatrix()}else if(e.rotate){return e.rotate.getWorldMatrix()}else if(e.translate){return e.translate.getWorldMatrix()}}return SceneHubAPI._math.identityMat4()};SceneHubAPI.Object.prototype._objectDestroyed=function(e){delete this.objects[e];this.numObjects--};SceneHubAPI.Object.prototype.destroy=function(){if(this.numObjects>0){for(var e in this.objects){if(this.objects.hasOwnProperty(e)){this.objects[e].destroy()}}}this._rootNode.destroy();if(this._appearanceId){this.model.appearances.putAppearance(this._appearanceId)}if(this._morphId){this.model.morphs.putMorph(this._morphId)}if(this._geometryId){this.model.geometries.putGeometry(this._geometryId)}if(this._shaderId){this.model.shaders.putShader(this._shaderId)}if(this._soundRenderer){this._soundRenderer.destroy()}if(this.parent){this.parent._objectDestroyed(this.id)}this._factory.destroy(this);this._publish("destroyed")};SceneHubAPI.AssetLibrary=function(e){this._init();this.model=e.model;this.type=e.type;this._loader=e.loader;this._factory=e.factory;this._libNode=e.libNode;this._postLoad=e.postLoad;this.assets={}};SceneHubAPI._extend(SceneHubAPI.AssetLibrary,SceneHubAPI.Component);SceneHubAPI.AssetLibrary.prototype.createAsset=function(e){var t=e.id;if(!t){throw"config expected: id"}if(this.assets[t]){throw"asset already defined: "+t}var n=new this._factory(this._libNode,e);var r=this;n.on("destroyed",function(){delete r.assets[t]});this.assets[t]=n;return n};SceneHubAPI.AssetLibrary.prototype.getAsset=function(e,t){var n=this.assets[e];if(n){n._useCount==undefined?n._useCount=1:n._useCount++;t(n)}else{var r=this;if(!this._loader){throw"asset not found: "+e}this._loader(this.type,e,function(i){if(r.assets[e]){t(r.assets[e])}else{i.id=e;if(r._postLoad){r._postLoad(e,i)}n=r.createAsset(i);n._useCount==undefined?n._useCount=1:n._useCount++;t(n)}})}};SceneHubAPI.AssetLibrary.prototype.putAsset=function(e){var t=this.assets[e];if(t){if(t._useCount!=undefined){if(--t._useCount==0){t.destroy()}}}};SceneHubAPI.Appearance=function(e,t){this._init();this.id=t.id;this.useCount=1;this.node=e.addNode({type:"node"});if(t.texture){this.texture=this.node.addNode(SceneHubAPI._apply(t.texture,{type:"texture"}))}if(t.material){this.material=this.node.addNode(SceneHubAPI._apply(t.material,{type:"material"}))}};SceneHubAPI._extend(SceneHubAPI.Appearance,SceneHubAPI.Component);SceneHubAPI.Appearance.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI.Shader=function(e,t){this._init();this.id=t.id;this.useCount=1;this.node=e.addNode(SceneHubAPI._apply(t,{type:"shader"}))};SceneHubAPI._extend(SceneHubAPI.Shader,SceneHubAPI.Component);SceneHubAPI.Shader.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI.Geometry=function(e,t){this._init();this.id=t.id;this.useCount=1;this.node=e.addNode(SceneHubAPI._apply(t,{type:"geometry"}))};SceneHubAPI._extend(SceneHubAPI.Geometry,SceneHubAPI.Component);SceneHubAPI.Geometry.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI.Morph=function(e,t){this._init();this.id=t.id;this.useCount=1;this.node=e.addNode(SceneHubAPI._apply(t,{type:"morphGeometry"}))};SceneHubAPI._extend(SceneHubAPI.Morph,SceneHubAPI.Component);SceneHubAPI.Morph.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI.Behaviour=function(e,t){this._init();this.id=t.id;this.fn=t.fn;this.useCount=1};SceneHubAPI._extend(SceneHubAPI.Behaviour,SceneHubAPI.Component);SceneHubAPI.Sound=function(e,t){this._init();this.id=t.id;this.useCount=1;this.attr=t;if(!t.src){throw"sound asset attribute expected: src"}this.src=t.src};SceneHubAPI._extend(SceneHubAPI.Sound,SceneHubAPI.Component);SceneHubAPI.Sound.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI._SoundRenderer=function(e){if(!e.src){throw"soundRenderer asset attribute expected: src"}this._init();this.attr=e;this.src=e.src;var t="__SceneHub._SoundRenderer."+SceneHubAPI._SoundRenderer._idMap.addItem();this._audioContainerId=t+".container";var n=document.getElementsByTagName("body")[0];var r=document.createElement("div");r.id=this._audioContainerId;r.innerHTML='<audio id="'+t+'"  src=""></audio>';n.appendChild(r);var i=document.getElementById(t);this._audio=i;this._supported=i.canPlayType('audio/ogg;codecs="vorbis"')==="probably";if(!this._supported){return}this.playing=false;this.set(e)};SceneHubAPI._extend(SceneHubAPI._SoundRenderer,SceneHubAPI.Component);SceneHubAPI._SoundRenderer._idMap=new SceneHub_Map;SceneHubAPI._SoundRenderer.prototype.set=function(e){if(!this._supported){return}e=e||{};if(e.src){this.src=e.src;this._audio.setAttribute("src",this.src)}if(e.play){if(!this.playing){this._audio.play();this.playing=true}}if(e.mute){alert("sound mute")}};SceneHubAPI._SoundRenderer.prototype.destroy=function(){SceneHubAPI._SoundRenderer._idMap.removeItem(this._audioId);var e=document.getElementsByTagName("body")[0];e.removeChild(this._audioContainerId)};SceneHubAPI.configure({assetPath:"http://scenehub.github.com/scenehub-assets/assets"});